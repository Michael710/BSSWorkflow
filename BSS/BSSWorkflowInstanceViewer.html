<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>

<link rel="stylesheet" type="text/css" href="../resources/css/ext-all.css" />
<link rel="stylesheet" type="text/css" href="../shared/example.css" />
<link rel="stylesheet" type="text/css" href="../ux/css/CheckHeader.css" />

<script type="text/javascript" src="../bootstrap.js"></script>
<script type="text/javascript" src="JSON.js"></script>
<script type="text/javascript" src="go-debug.js"></script>
<script type="text/javascript" src="CustomNodeHandler.js"></script>


<body onload="init()">

<script>


Ext.Loader.setConfig({enabled: true});

Ext.Loader.setPath('Ext.ux', '../ux/');
Ext.require([
    'Ext.form.*',
    'Ext.window.Window',
    'Ext.data.*',
    'Ext.ux.FieldReplicator'
]);



var stage;
var layer;

var BSSWorkflowName = "No Workflow Selected";

var BSSWorkflowId = 0;
var BSSWorkflowStepId = 1;
var BSSUserId = 1;

var workflowgrid;
var bssWorkflowStatusData;
var bssWorkflowStatusListStore;
var bssWorkflowActionTypeData;
var bssWorkflowActionTypeStore;
var bssWorkflowNotificationListStore;

var bsslinedrawmode = 'OFF';
var startlinedrawx;
var startlinedrawy;
var endlinedrawx;
var endlinedrawy;


bssWorkflowStatusData = [
    {id:1, value: 'Start'},
    {id:2, value: 'Submit'},
    {id:3, value: 'Review'},
    {id:4, value: 'Rejected'},
    {id:5, value: 'Approved'},
    {id:6, value: 'Action'},
    {id:7, value: 'Notify'},
    {id:8, value: 'Task'},
    {id:9, value: 'End'}
];



bssWorkflowStatusListStore = Ext.create('Ext.data.Store', {
            fields: [{name: 'id'}, {name: 'value'}],
            data: bssWorkflowStatusData,
            listeners: {
                load: function () {
                    //this sets the default value to USA after the store loads

                    //   alert('GG');
                    //   var combo = Ext.getCmp('idstatustype');
                    //   combo.setValue('2');
                }
            }
        }
);

bssWorkflowActionTypeData = [
    { id:1, value: 'Action'},
    { id:2, value: 'URL'}
];

bssWorkflowActionTypeStore = Ext.create('Ext.data.Store', {
            fields: [{name: 'id'}, {name: 'value'} ],
            data: bssWorkflowActionTypeData
        }
);

bssWorkflowNotificationListStore = Ext.create('Ext.data.Store', {
            fields: [{name: 'id'}, {name: 'value'} ],
            data: bssWorkflowActionTypeData
        }
);



bssWorkflowApprovalStatusData = [ { id:1, value: 'A'},{ id:2, value: 'B'}];

workflowapprovalstatusliststore = Ext.create('Ext.data.Store', {
            fields: [{name: 'id'}, {name: 'value'} ],
            data: bssWorkflowApprovalStatusData
        }
);

var BSSSIGNOFF_FLAG = false;
var BSSADDREMOVEAPPROVERS = false;

var signoffsStore = Ext.create('Ext.data.Store', {
    fields: [
        {name: 'id', type: 'string'},
        {name: 'masterid', type: 'string'},
        {name: 'sequence', type: 'string'},
        {name: 'WorkflowApprover', type: 'string'},
        {name: 'SignoffDate', type: 'date'},
        {name: 'SignoffResult', type: 'string'},
        {name: 'Comments', type: 'string'}
    ],
    data:
            [['1','','','','','','']]
});

bssUserData = [ { id:1, value: 'A'},{ id:2, value: 'B'}];

userliststore = Ext.create('Ext.data.Store', {
            fields: [{name: 'id'}, {name: 'value'} ],
            data: bssUserData
        }
);


//Get the data
xmlHttp = new XMLHttpRequest();
xmlHttp.open( "GET", "BSSGetComboStore.php?BSSSQLString=SELECT id, Email AS value FROM users", false );
xmlHttp.send( null );
//        alert("DATA: " + xmlHttp.responseText);
var bssNewFlowManagerData = eval('[' + xmlHttp.responseText + ']');
userliststore.loadData(bssNewFlowManagerData,false);




var cellEditing6 = Ext.create('Ext.grid.plugin.CellEditing', {
    clicksToEdit: 1
});

//Get the data
xmlHttp = new XMLHttpRequest();
xmlHttp.open( "GET", "BSSGetComboStore.php?BSSSQLString=SELECT id, NotificationName AS value FROM Notifications", false );
xmlHttp.send( null );
//alert("DATA: " + xmlHttp.responseText);
var bssNotificationData = eval('[' + xmlHttp.responseText + ']');
bssWorkflowNotificationListStore.loadData(bssNotificationData,false);

Ext.Loader.setConfig({
    enabled: true
});
Ext.Loader.setPath('Ext.ux', '../ux');

Ext.require([
    'Ext.selection.CellModel',
    'Ext.grid.*',
    'Ext.data.*',
    'Ext.util.*',
    'Ext.state.*',
    'Ext.form.*',
    'Ext.ux.CheckColumn', '*'
]);


function init() {
   // alert('init');

   // if (window.goSamples) goSamples();  // init for these samples -- you don't need to call this
    var $ = go.GraphObject.make;  // for conciseness in defining templates

    myDiagram = new go.Diagram("myDiagram");// must name or refer to the DIV HTML element
    myDiagram.allowVerticalScroll = false;
    myDiagram.allowSelect = true;
    myDiagram.allowGroup = false;
    myDiagram.maxSelectionCount = 1;

    // define several shared Brushes
    var graygrad = $(go.Brush, go.Brush.Linear, { 0: "rgb(150, 150, 150)", 0.5: "rgb(86, 86, 86)", 1: "rgb(86, 86, 86)" });
    var greengrad = $(go.Brush, go.Brush.Linear, { 0: "rgb(98, 199, 79)", 1: "rgb(17, 51, 6)" });
    var bluegrad = $(go.Brush, go.Brush.Linear, { 0: "rgb(50, 50, 150)", 1: "rgb(51, 102, 255)" });
    var orggrad = $(go.Brush, go.Brush.Linear, { 0: "rgb(255, 81, 0)", 1: "rgb(153, 50, 0)" });
    var redgrad = $(go.Brush, go.Brush.Linear, { 0: "rgb(255, 0, 0)", 1: "rgb(100, 0, 0)" });
    var yellowgrad = $(go.Brush, go.Brush.Linear, { 0: "rgb(254, 201, 0)", 1: "rgb(254, 162, 0)" });
    var blackgrad = $(go.Brush, go.Brush.Linear, { 0: "rgb(0, 0, 0)", 1: "rgb(120, 120, 120)" });
    var purplegrad = $(go.Brush, go.Brush.Linear, { 0: "rgb(99, 0, 99)", 1: "rgb(153, 51, 153)" });


    // Don't show shadows on mobile devices for performance reasons
    var shadows = !("ontouchstart" in window);

    // define the Node template for regular nodes

 //   myDiagram.add(
 //           $(go.Node, go.Panel.Vertical,
 //                   $(go.TextBlock, {name: 'txtWFSelected', text: "Selected Workflow: "+ BSSWorkflowName, font: "12pt sans-serif" }) ));

 //   var s = "TEST ME";
 //   myDiagram.nodeTemplateMap.add("SELECTEDWF",
 //           $(go.Node, "Vertical",
 //           $(go.TextBlock,
 //           { font: "12pt sans-serif" },
 //           new go.Binding("text", "wfname", function(s) { return "Selected Workflow: " + s; }))));

    myDiagram.nodeTemplateMap.add("",  // the default category
            $(go.Node, go.Panel.Spot,
                    // the Node.location is at the center of each node
                    { locationSpot: go.Spot.Center, isShadowed: shadows, shadowColor: "#242424" },
                    // The Node.location comes from the "loc" property of the node data,
                    // converted by the Point.parse method.
                    // If the Node.location is changed, it updates the "loc" property of the node data,
                    // converting back using the Point.stringify method.
                    new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                    // handle mouse enter/leave events to show/hide the ports
                    { mouseEnter: function(e, obj) { showPorts(obj.part, true); },
                      mouseLeave: function(e, obj) { showPorts(obj.part, false); },
                  mouseDragLeave: function(e, obj) {addworkflowsteptoform(); },
                     doubleClick: function(e, obj) { alert(obj); }},
                    // the main object is a Panel that surrounds a TextBlock with a rectangular Shape
                    $(go.Panel, go.Panel.Auto,
                            $(go.Shape,
                                    { figure: "RoundedRectangle", fill: graygrad },
                                    new go.Binding("figure", "figure")),
                            $(go.TextBlock,
                                    { font: "bold 9pt Helvetica, Arial, sans-serif",
                                        stroke: "white",
                                        margin: 8,
                                        maxSize: new go.Size(100, NaN),
                                        wrap: go.TextBlock.WrapFit,
                                        editable: true },
                                    new go.Binding("text", "text").makeTwoWay())),
                    // four named ports, one on each side:
                    makePort("L", go.Spot.Left, true, true),
                    makePort("R", go.Spot.Right, true, true),
                    makePort("T", go.Spot.Top, false, true),
                    makePort("B", go.Spot.Bottom, true, false)
            ));

    myDiagram.nodeTemplateMap.add("LOAD",  // the default category
            $(go.Node, go.Panel.Spot,
                    { locationSpot: go.Spot.Center, isShadowed: shadows, shadowColor: "#242424", selectable: false },
                    new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                    { mouseEnter: function(e, obj) { showPorts(obj.part, true); },
                      mouseLeave: function(e, obj) { showPorts(obj.part, false); },
                      doubleClick: function(e, obj) {GetWorkFlowList(); }},
                    $(go.Panel, go.Panel.Auto,
                            $(go.Shape,
                                    { figure: "RoundedRectangle", fill: bluegrad },
                                    new go.Binding("figure", "figure")),
                            $(go.TextBlock,
                                    { font: "bold 9pt Helvetica, Arial, sans-serif",
                                        stroke: "white",
                                        margin: 8,
                                        maxSize: new go.Size(100, NaN),
                                        wrap: go.TextBlock.WrapFit,
                                        editable: true },
                                    new go.Binding("text", "text").makeTwoWay()))
               //     makePort("L", go.Spot.Left, true, true),
               //     makePort("R", go.Spot.Right, true, true)

            ));

    myDiagram.nodeTemplateMap.add("SAVE",  // the default category
            $(go.Node, go.Panel.Spot,
                    { locationSpot: go.Spot.Center, isShadowed: shadows, shadowColor: "#242424", selectable: false },
                    new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                    { mouseEnter: function(e, obj) { showPorts(obj.part, true); },
                        mouseLeave: function(e, obj) { showPorts(obj.part, false); },
                        doubleClick: function(e, obj) {save(); }},
                    $(go.Panel, go.Panel.Auto,
                            $(go.Shape,
                                    { figure: "RoundedRectangle", fill: greengrad },
                                    new go.Binding("figure", "figure")),
                            $(go.TextBlock,
                                    { font: "bold 9pt Helvetica, Arial, sans-serif",
                                        stroke: "white",
                                        margin: 8,
                                        maxSize: new go.Size(100, NaN),
                                        wrap: go.TextBlock.WrapFit,
                                        editable: true },
                                    new go.Binding("text", "text").makeTwoWay()))
                    //     makePort("L", go.Spot.Left, true, true),
                    //     makePort("R", go.Spot.Right, true, true)
            ));


    myDiagram.nodeTemplateMap.add("SUBMIT",  // the default category
            $(go.Node, go.Panel.Spot,
                    { locationSpot: go.Spot.Center, isShadowed: shadows, shadowColor: "#242424" },
                    new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                    { mouseEnter: function(e, obj) { showPorts(obj.part, true); },
                      mouseLeave: function(e, obj) { showPorts(obj.part, false); },
                      doubleClick: function(e, obj) {OpenSubmitForm(BSSWorkflowId, obj.part.data.key, obj.part.data.category); }},
                    $(go.Panel, go.Panel.Auto,
                            $(go.Shape,
                                    { figure: "RoundedRectangle", fill: bluegrad },
                                    new go.Binding("figure", "figure")),
                            $(go.TextBlock,
                                    { font: "bold 9pt Helvetica, Arial, sans-serif",
                                        stroke: "white",
                                        margin: 8,
                                        maxSize: new go.Size(100, NaN),
                                        wrap: go.TextBlock.WrapFit,
                                        editable: true },
                                    new go.Binding("text", "text").makeTwoWay())),
                    makePort("L", go.Spot.Left, true, true),
                    makePort("R", go.Spot.Right, true, true),
                    makePort("T", go.Spot.Top, false, true),
                    makePort("B", go.Spot.Bottom, true, false)

            ));


    myDiagram.nodeTemplateMap.add("URL",  // the default category
            $(go.Node, go.Panel.Spot,
                    { locationSpot: go.Spot.Center, isShadowed: shadows, shadowColor: "#242424" },
                    new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                    { mouseEnter: function(e, obj) { showPorts(obj.part, true); },
                        mouseLeave: function(e, obj) { showPorts(obj.part, false); },
                        doubleClick: function(e, obj) {OpenURLForm(BSSWorkflowId, obj.part.data.key, obj.part.data.category); }},
                    $(go.Panel, go.Panel.Auto,
                            $(go.Shape,
                                    { figure: "Cloud", fill: bluegrad },
                                    new go.Binding("figure", "figure")),
                            $(go.TextBlock,
                                    { font: "bold 9pt Helvetica, Arial, sans-serif",
                                        stroke: "white",
                                        margin: 8,
                                        maxSize: new go.Size(100, NaN),
                                        wrap: go.TextBlock.WrapFit,
                                        editable: true },
                                    new go.Binding("text", "text").makeTwoWay())),
                    makePort("L", go.Spot.Left, true, true),
                    makePort("R", go.Spot.Right, true, true),
                    makePort("T", go.Spot.Top, false, true),
                    makePort("B", go.Spot.Bottom, true, false)
            ));


    myDiagram.nodeTemplateMap.add("REVIEW",  // the default category
            $(go.Node, go.Panel.Spot,
                    { locationSpot: go.Spot.Center, isShadowed: shadows, shadowColor: "#242424" },
                    new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                    { mouseEnter: function(e, obj) { showPorts(obj.part, true); },
                      mouseLeave: function(e, obj) { showPorts(obj.part, false); },
                      doubleClick: function(e, obj) {OpenReviewForm(BSSWorkflowId, obj.part.data.key, obj.part.data.category); }},
                    $(go.Panel, go.Panel.Auto,
                            $(go.Shape,
                                    { figure: "RoundedRectangle", fill: purplegrad },
                                    new go.Binding("figure", "figure")),
                            $(go.TextBlock,
                                    { font: "bold 9pt Helvetica, Arial, sans-serif",
                                        stroke: "white",
                                        margin: 8,
                                        maxSize: new go.Size(100, NaN),
                                        wrap: go.TextBlock.WrapFit,
                                        editable: true },
                                    new go.Binding("text", "text").makeTwoWay())),
                    makePort("L", go.Spot.Left, true, true),
                    makePort("R", go.Spot.Right, true, true),
                    makePort("T", go.Spot.Top, false, true),
                    makePort("B", go.Spot.Bottom, true, false)

            ));


    myDiagram.nodeTemplateMap.add("NOTIFY",  // the default category
            $(go.Node, go.Panel.Spot,
                    { locationSpot: go.Spot.Center, isShadowed: shadows, shadowColor: "#242424" },
                    new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                    { mouseEnter: function(e, obj) { showPorts(obj.part, true); },
                      mouseLeave: function(e, obj) { showPorts(obj.part, false); },
                      doubleClick: function(e, obj) {OpenNotificationForm(BSSWorkflowId, obj.part.data.key, obj.part.data.category); }},
                    $(go.Panel, go.Panel.Auto,
                            $(go.Shape,
                                    { figure: "File", fill: bluegrad },
                                    new go.Binding("figure", "figure")),
                            $(go.TextBlock,
                                    { font: "bold 9pt Helvetica, Arial, sans-serif",
                                        stroke: "white",
                                        margin: 8,
                                        maxSize: new go.Size(100, NaN),
                                        wrap: go.TextBlock.WrapFit,
                                        editable: true },
                                    new go.Binding("text", "text").makeTwoWay())),
                    makePort("L", go.Spot.Left, true, true),
                    makePort("R", go.Spot.Right, true, true),
                    makePort("T", go.Spot.Top, false, true),
                    makePort("B", go.Spot.Bottom, true, false)

            ));

    myDiagram.nodeTemplateMap.add("TASK",  // the default category
            $(go.Node, go.Panel.Spot,
                    { locationSpot: go.Spot.Center, isShadowed: shadows, shadowColor: "#242424" },
                    new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                    { mouseEnter: function(e, obj) { showPorts(obj.part, true); },
                        mouseLeave: function(e, obj) { showPorts(obj.part, false); },
                        doubleClick: function(e, obj) {OpenTaskForm(BSSWorkflowId, obj.part.data.key, obj.part.data.category); }},
                    $(go.Panel, go.Panel.Auto,
                            $(go.Shape,
                                    { figure: "Actor", fill: bluegrad },
                                    new go.Binding("figure", "figure")),
                            $(go.TextBlock,
                                    { font: "bold 9pt Helvetica, Arial, sans-serif",
                                        stroke: "white",
                                        margin: 8,
                                        maxSize: new go.Size(100, NaN),
                                        wrap: go.TextBlock.WrapFit,
                                        editable: true },
                                    new go.Binding("text", "text").makeTwoWay())),
                    makePort("L", go.Spot.Left, true, true),
                    makePort("R", go.Spot.Right, true, true),
                    makePort("T", go.Spot.Top, false, true),
                    makePort("B", go.Spot.Bottom, true, false)

            ));


  var lightText = 'whitesmoke';
    myDiagram.nodeTemplateMap.add("Enddd",
      $(go.Node, "Spot", nodeStyle(),
        $(go.Panel, "Auto",
          $(go.Shape, "Circle",
            { minSize: new go.Size(40, 60), fill: "#DC3C00", stroke: null }),
          $(go.TextBlock, "End",
            { margin: 5, font: "bold 11pt Helvetica, Arial, sans-serif", stroke: lightText })
        ),
        // three named ports, one on each side except the bottom, all input only:
        makePort("T", go.Spot.Top, false, true),
        makePort("L", go.Spot.Left, false, true),
        makePort("R", go.Spot.Right, false, true)
      ));
      


    myDiagram.nodeTemplateMap.add("REJECTED",  // the default category
            $(go.Node, go.Panel.Spot,
                    { locationSpot: go.Spot.Center, isShadowed: shadows, shadowColor: "#242424" },
                    new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                    { mouseEnter: function(e, obj) { showPorts(obj.part, true); },
                      mouseLeave: function(e, obj) { showPorts(obj.part, false); },
                      doubleClick: function(e, obj) {OpenForm(BSSWorkflowId, obj.part.data.key, obj.part.data.category);}
                    },
                    $(go.Panel, go.Panel.Auto,
                            $(go.Shape,
                                    { figure: "RoundedRectangle", fill: redgrad },
                                    new go.Binding("figure", "figure")),
                            $(go.TextBlock,
                                    { font: "bold 9pt Helvetica, Arial, sans-serif",
                                        stroke: "white",
                                        margin: 8,
                                        maxSize: new go.Size(100, NaN),
                                        wrap: go.TextBlock.WrapFit,
                                        editable: true },
                                    new go.Binding("text", "text").makeTwoWay())),
                    // four named ports, one on each side:
                    //       makePort("T", go.Spot.Top, false, true),
                    makePort("L", go.Spot.Left, true, true),
                    makePort("R", go.Spot.Right, true, true),
                    makePort("T", go.Spot.Top, false, true),
                    makePort("B", go.Spot.Bottom, true, false)

                    //      makePort("B", go.Spot.Bottom, true, false)
            ));


    myDiagram.nodeTemplateMap.add("ACTION",  // the default category
            $(go.Node, go.Panel.Spot,
                    { locationSpot: go.Spot.Center, isShadowed: shadows, shadowColor: "#242424" },
                    new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                    { mouseEnter: function(e, obj) { showPorts(obj.part, true); },
                        mouseLeave: function(e, obj) { showPorts(obj.part, false); },
                        doubleClick: function(e, obj) {OpenActionForm(BSSWorkflowId, obj.part.data.key, obj.part.data.category); }},
                    $(go.Panel, go.Panel.Auto,
                            $(go.Shape,
                                    { figure: "Procedure", fill: orggrad },
                                    new go.Binding("figure", "figure")),
                            $(go.TextBlock,
                                    { font: "bold 9pt Helvetica, Arial, sans-serif",
                                        stroke: "white",
                                        margin: 8,
                                        maxSize: new go.Size(100, NaN),
                                        wrap: go.TextBlock.WrapFit,
                                        editable: true },
                                    new go.Binding("text", "text").makeTwoWay())),
                    // four named ports, one on each side:
                    makePort("L", go.Spot.Left, true, true),
                    makePort("R", go.Spot.Right, true, true),
                    makePort("T", go.Spot.Top, false, true),
                    makePort("B", go.Spot.Bottom, true, false)

            ));



    myDiagram.nodeTemplateMap.add("START",
            $(go.Node, go.Panel.Spot,
                    { locationSpot: go.Spot.Center, isShadowed: shadows, shadowColor: "#242424" },
                    new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                    { mouseEnter: function(e, obj) { showPorts(obj.part, true); },
                        mouseLeave: function(e, obj) { showPorts(obj.part, false);},
                        doubleClick: function(e, obj) {OpenForm(BSSWorkflowId, obj.part.data.key, obj.part.data.category);}
                    },
                    $(go.Panel, go.Panel.Auto,
                            $(go.Shape,
                                    { figure: "Ellipse", fill: greengrad, stroke: "rgb(17, 51, 6)" }),
                            $(go.TextBlock,
                                    { text: "Start", margin: 5,
                                        font: "bold 9pt Helvetica, Arial, sans-serif",
                                        stroke: "rgb(255, 255, 255)" })),
                    // three named ports, one on each side except the top, all output only:
                    makePort("L", go.Spot.Left, true, false),
                    makePort("R", go.Spot.Right, true, false),
                    makePort("T", go.Spot.Top, false, true),
                    makePort("B", go.Spot.Bottom, true, false)

            ));

    myDiagram.nodeTemplateMap.add("END",
            $(go.Node, go.Panel.Spot,
                    { locationSpot: go.Spot.Center, isShadowed: shadows, shadowColor: "#242424" },
                    new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                    { mouseEnter: function(e, obj) { showPorts(obj.part, true);},
                      mouseLeave: function(e, obj) { showPorts(obj.part, false);},
                      doubleClick: function(e, obj) {OpenForm(BSSWorkflowId, obj.part.data.key, obj.part.data.category);}},
                    $(go.Panel, go.Panel.Auto,
                            $(go.Shape,
                                    { figure: "Ellipse", fill: blackgrad, stroke: "rgb(82, 6, 0)" }),
                            $(go.TextBlock,
                                    { text: "End", margin: 5,
                                        font: "bold 9pt Helvetica, Arial, sans-serif",
                                        stroke: "rgb(255, 255, 255)" })),
                    // three named ports, one on each side except the bottom, all input only:
                  //  makePort("T", go.Spot.Top, false, true),
                    makePort("L", go.Spot.Left, false, true),
                    makePort("R", go.Spot.Right, false, true),
                    makePort("T", go.Spot.Top, false, true),
                    makePort("B", go.Spot.Bottom, true, false)

            ));

    myDiagram.nodeTemplateMap.add("COMMENT",
            $(go.Node, go.Panel.Auto,
                    { locationSpot: go.Spot.Center, isShadowed: shadows, shadowColor: "#242424" },
                    new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                    $(go.Shape,
                            { figure: "File", fill: yellowgrad },
                            new go.Binding("figure", "figure")),
                    $(go.TextBlock,
                            { margin: 5,
                                maxSize: new go.Size(200, NaN),
                                wrap: go.TextBlock.WrapFit,
                                textAlign: "center",
                                editable: false,
                                font: "bold 9pt Helvetica, Arial, sans-serif" },
                            new go.Binding("text", "text").makeTwoWay())
                    // no ports, because no links are allowed to connect with a comment
           ));






    myDiagram.nodeTemplateMap.add("LISTENER",
            $(go.Node, go.Panel.Spot,
                    { locationSpot: go.Spot.Center, isShadowed: shadows, shadowColor: "#242424" },
                    new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                    { mouseEnter: function(e, obj) { showPorts(obj.part, true);},
                        mouseLeave: function(e, obj) { showPorts(obj.part, false);},
                        doubleClick: function(e, obj) {OpenListenerForm(BSSWorkflowId, obj.part.data.key, obj.part.data.category);}},
                    $(go.Panel, go.Panel.Auto,
                            $(go.Shape,
                                    { figure: "Ellipse", fill: blackgrad, stroke: "rgb(82, 6, 0)" }),
                            $(go.TextBlock,
                                    { text: "Listener", margin: 5,
                                        font: "bold 9pt Helvetica, Arial, sans-serif",
                                        stroke: "rgb(255, 255, 255)" }))
                    // three named ports, one on each side except the bottom, all input only:
                    //  makePort("T", go.Spot.Top, false, true),
                    //makePort("L", go.Spot.Left, false, true)
                    //   makePort("R", go.Spot.Right, false, true)
            ));




try{

    varNewNodeName = "EXTACTION";
    varNewNodeFigure = "Procedure";
    varNewNodeColor = "#FFAADD";

    myDiagram.nodeTemplateMap.add(varNewNodeName,  // the default category
            $(go.Node, go.Panel.Spot,
                    { locationSpot: go.Spot.Center, isShadowed: shadows, shadowColor: "#242424" },
                    new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                    { mouseEnter: function(e, obj) { showPorts(obj.part, true); },
                      mouseLeave: function(e, obj) { showPorts(obj.part, false); },
                      doubleClick: function(e, obj) {OpenNewNodeForm(varNewNodeName, BSSWorkflowId, obj.part.data.key, obj.part.data.category);}},
                    $(go.Panel, go.Panel.Auto,
                            $(go.Shape,
                                    { figure: varNewNodeFigure, fill: varNewNodeColor },
                                    new go.Binding("figure", "figure")),
                            $(go.TextBlock,
                                    { font: "bold 9pt Helvetica, Arial, sans-serif",
                                        stroke: "white",
                                        margin: 8,
                                        maxSize: new go.Size(100, NaN),
                                        wrap: go.TextBlock.WrapFit,
                                        editable: true },
                                    new go.Binding("text", "text").makeTwoWay())),
                    // four named ports, one on each side:
                    makePort("L", go.Spot.Left, true, true),
                    makePort("R", go.Spot.Right, true, true),
                    makePort("T", go.Spot.Top, false, true),
                    makePort("B", go.Spot.Bottom, true, false)
            ));
}
catch(e)
{alert("Node Creation ERROR: " + e.message);
}



    // replace the default Link template in the linkTemplateMap
    myDiagram.linkTemplate =
            $(go.Link,  // the whole link panel
                    { routing: go.Link.AvoidsNodes,
                        curve: go.Link.JumpOver,
                        corner: 5, toShortLength: 4,
                        relinkableFrom: false, relinkableTo: false, reshapable:true },
                    $(go.Shape,  // the link path shape
                            { isPanelMain: true,
                                stroke: "whitesmoke", strokeWidth: 2 }),
                    $(go.Shape,  // the arrowhead
                            { toArrow: "standard",
                                stroke: null, fill: "whitesmoke" }),
                    $(go.Panel, go.Panel.Auto,
                            { visible: false, name: "LABEL", segmentIndex: 2, segmentFraction: 0.5},
                            new go.Binding("visible", "visible").makeTwoWay(),
                            $(go.Shape,  // the link shape
                                    { figure: "RoundedRectangle", fill: "#F8F8F8", stroke: null }),
                            $(go.TextBlock,  // the label
                                    { textAlign: "center",
                                        font: "10pt helvetica, arial, sans-serif",
                                        stroke: "#919191",
                                        margin: 2, text: "Yes", editable: true }
                            )
                    )
            );


   myDiagram.addDiagramListener("ObjectContextClicked", function(eee) {

                var part = eee.subject.part;

                var r=confirm("Do you wish to delete the step?");
                    if (r==true)
                    {
                        myDiagram.remove(part);
                    }
                    else
                    {
                      //  "You pressed Cancel!";
                       return;
                    }

                alert("here1");

                    if((part instanceof go.Link)){
                    // Delete link

                        try{

                        alert("here3");

                        var varFrom = part.fromNode.data.key;
                        var varTo = part.toNode.data.key;

                        alert(varFrom);
                        alert(varTo);


                        var xmlHttp = null;
                        xmlHttp = new XMLHttpRequest();
                        xmlHttp.open( "GET", "BSSDeleteWorkflowLine.php?BSSWorkflowId=" + BSSWorkflowId + "&BSSFromNode=" + varFrom + "&BSSToNode=" + varTo, false );
                        xmlHttp.send(null);
                        alert("DATA: " + xmlHttp.responseText);
                        }catch(e){
                            alert(e);
                        }



                    }
                    else{
                    // Delete Step
                        alert("here2");

                    //    var obj =  myDiagram.selection.first();

                        if(BSSWorkflowId == 0){
                            alert("Select or create a workflow first.");
                            myDiagram.clear();
                            return;
                        }

                      //  var StatusType = obj.part.data.category;
                        var keyid = part.data.key;
                     //   var BSSLocation = obj.part.data.loc;


                        alert("here3");

                        var xmlHttp = null;
                        xmlHttp = new XMLHttpRequest();
                        xmlHttp.open( "GET", "BSSDeleteWorkflowStep.php?BSSWorkflowId=" + BSSWorkflowId + "&BSSKeyId=" + keyid, false );
                        xmlHttp.send(null);
                        alert("DATA: " + xmlHttp.responseText);


                    }


            });

    myDiagram.addDiagramListener("ExternalObjectsDropped",
            function(ee) {

                try{

                 var obj =  myDiagram.selection.first();

                if(BSSWorkflowId == 0){
                    alert("Select or create a workflow first.");
                    myDiagram.clear();
                    return;
                }

                var StatusType = obj.part.data.category;
                var keyid = obj.part.data.key;
                var BSSLocation = obj.part.data.loc;

               var xmlHttp = null;
                xmlHttp = new XMLHttpRequest();
                xmlHttp.open( "GET", "BSSCreateWorkflowStep.php?BSSWorkflowId=" + BSSWorkflowId + "&name=" + StatusType  + "&BSSKeyId=" + keyid + "&BSSLocation=" + BSSLocation + "&yloc=" + 100, false );
                xmlHttp.send(null);
                    alert("DATA: " + xmlHttp.responseText);

                }catch(e)
                {alert("Master Data Get ERROR: " + e.message);
                }
            });


    myDiagram.addDiagramListener("SelectionMoved",
            function(ee) {

                try{

                    var obj =  myDiagram.selection.first();

                    if(BSSWorkflowId == 0){
                        alert("Select or create a workflow first.");
                        myDiagram.clear();
                        return;
                    }

                    var StatusType = obj.part.data.category;
                    var keyid = obj.part.data.key;
                    var BSSLocation = obj.part.data.loc;

                    var xmlHttp = null;
                    xmlHttp = new XMLHttpRequest();
                    xmlHttp.open( "GET", "BSSUpdateWorkflowStep.php?BSSWorkflowId=" + BSSWorkflowId + "&name=" + StatusType  + "&BSSKeyId=" + keyid + "&BSSLocation=" + BSSLocation + "&yloc=" + 100, false );
                    xmlHttp.send(null);
                    alert("DATA: " + xmlHttp.responseText);

                }catch(e)
                {alert("Master Data Get ERROR: " + e.message);
                }
            });



    // make link labels visible if coming out of a "conditional" node
    myDiagram.addDiagramListener("LinkDrawn", function(e) {

        //       '{"from":1, "to":2, "fromPort":"B", "toPort":"T"},
        try{


        var varFrom = e.subject.fromNode.data.key;
        var varTo = e.subject.toNode.data.key;


            //alert(varFrom);
        //alert(varTo);

        var xmlHttp = null;
        xmlHttp = new XMLHttpRequest();
        xmlHttp.open( "GET", "BSSCreateWorkflowLine.php?BSSWorkflowId=" + BSSWorkflowId + "&BSSFromNode=" + varFrom  + "&BSSToNode=" + varTo, false );
        xmlHttp.send(null);
            alert("DATA: " + xmlHttp.responseText);

    }catch(e)
    {alert("Master Data Get ERROR: " + e.message);
    }

        if (e.subject.fromNode.data.figure === "Diamond") {
            var label = e.subject.findObject("LABEL");
            if (label !== null) label.visible = true;
        }
    })

    myDiagram.allowDrop = true;  // must be true to accept drops from the Palette
    // temporary links used by LinkingTool and RelinkingTool are also orthogonal:
    myDiagram.toolManager.linkingTool.temporaryLink.routing = go.Link.Orthogonal;
    myDiagram.toolManager.relinkingTool.temporaryLink.routing = go.Link.Orthogonal;

  //  load();  // load an initial diagram from some JSON text

    // initialize the Palette that is on the left side of the page
    myPalette = new go.Palette("myPalette");  // must name or refer to the DIV HTML element
    myPalette.nodeTemplateMap = myDiagram.nodeTemplateMap;  // share the templates used by myDiagram


    // Get addon nodes here
    var palExtModel = ',{"location": "15", "category": "EXTACTION",   "text": "TESTIT"}';

    var varModelString = '[' +
    '{"location": "1", "category": "LOAD",       "text": "Workflows"},  ' +
    '{"location": "2", "category": "SAVE",       "text": "Save"},  ' +
    '{"location": "3", "category": "CLOSE",      "text": "Close"},  ' +
    '{"location": "4", "category": "START",      "text": "Start"},  ' +
    '{"location": "5", "category": "SUBMIT",     "text": "Submit"},  ' +
    '{"location": "6", "category": "REVIEW",     "text": "Review"},  ' +
    '{"location": "7", "category": "REJECTED",   "text": "Rejected"},  ' +
    '{"location": "8", "category": "ACTION",     "text": "Action"},  ' +
    '{"location": "9", "category": "URL",        "text": "URL"},  ' +
    '{"location": "10", "category": "NOTIFY",    "text": "Notify"},  ' +
    '{"location": "11", "category": "TASK",       "text": "Task"},  ' +
    '{"location": "12", "category": "END",        "text": "End"},  ' +
    '{"location": "13", "category": "COMMENT",    "text": "Comment"},  ' +
    '{"location": "13", "category": "Enddd",    "text": "Enddd"},  ' +
    '{"location": "14", "category": "LISTENER",   "text": "Listener"}  ' +  palExtModel  + ']';

    var palModel =    new go.GraphLinksModel( eval(varModelString));

    myPalette.model = palModel;

    try{
        myPalette.layout.sorting = go.GridLayout.Forward;
}catch(e){
    alert(e);
}

function OpenTaskForm(WorkflowID, Key, Category){

    var BSSWorkflowStepName;
    BSSWorkflowId  = 1;
    BSSWorkflowStepId = -9;

    try{
        xmlHttp = new XMLHttpRequest();
        xmlHttp.open( "GET", "BSSGetAdvWorkflowStepData.php?BSSWorkflowId= " + BSSWorkflowId +  "&BSSWorkflowStepId=" +  BSSWorkflowStepId, false );
        xmlHttp.send( null );
              alert("DATA: " + xmlHttp.responseText);
        var wsdata =eval('[' + xmlHttp.responseText + ']');

        var BSSID = wsdata[0].id;
        var BSSXLOC = wsdata[0].xloc;
        var BSSYLOC = wsdata[0].yloc;
        var BSSTASKEE = parseInt(wsdata[0].ApproverUserId);   // Make sure its int
        var BSSstatustype = wsdata[0].statustype;
        if(BSSstatustype==''){BSSstatustype=1;}
        //           alert(BSSstatustype);
        var BSSstatustypeValue =  bssWorkflowStatusData[BSSstatustype - 1].value;
        var BSSStarted = wsdata[0].Started;
        var BSSCompleted = wsdata[0].Completed;
        var BSSInstructions = wsdata[0].Instructions;
        var BSSErrorResult = wsdata[0].ErrorResult;
        var BSSName = wsdata[0].name;
        var BSSDescription = wsdata[0].description;
        //  masterStore.loadData(newdata,false);
    }catch(e)
    {alert("Master Data Get ERROR: " + e.message);
    }

    try{
        var form = Ext.create('Ext.form.Panel', {
            id: 'idwsform',
            plain: false,
            border: 0,
            title: 'Status Detail',
            width: 360,
            bodyPadding: 5,
            url: 'BSSSaveWorkflowStep.php',
            fieldDefaults: {
                labelWidth: 70,
                anchor: '100%'
            },
            layout: {
                type: 'vbox',
                align: 'stretch'  // Child items are stretched to full width
            },
            items: [
                { //  id: 'id',
                    xtype: 'textfield',
                    fieldLabel: 'id',
                    name: 'id',
                    dataIndex: 'id',
                    value: Key,
                    disabled: true},
                { //  id: 'idxloc',
                    xtype: 'textfield',
                    fieldLabel: 'X',
                    name: 'xloc',
                    dataIndex: 'xloc',
                    value: BSSXLOC, //  valx / 70,
                    disabled: true},
                { //  id: 'idyloc',
                    xtype: 'textfield',
                    fieldLabel: 'Y',
                    name: 'yloc',
                    dataIndex: 'yloc',
                    value: BSSYLOC,   //valy / 35,
                    disabled: true},
                {
                   // id: 'idname',
                    xtype: 'textfield',
                    fieldLabel: 'Name',
                    name: 'name',
                    dataIndex: 'name',
                    value: BSSName
                },
                {   //id: 'iddescription',
                    xtype: 'textfield',
                    fieldLabel: 'Description',
                    name: 'description',
                    //         dataIndex: 'description',
                    value: BSSDescription},
                {   id: 'idstatustype',
                    xtype: 'combo',
                  //  store: bssWorkflowStatusListStore,
                    valueField:'id',
                    displayField:'value',
                    fieldLabel: 'Status Type',
                    queryMode: 'local',
                    //       selectOnTab: false,
                    name: 'statustype',
                    //dataIndex: 'statustype',
                    displayValue: 'Task',
                    submitValue : true,
                    //     hiddenName : 'id'
                    //  flex: 1,
                    forceSelection: false
                    //     disabled: true
                   },
     //           {
     //               id: 'idactontype',
     //               hidden: BSSISACTION,
     //               xtype: 'combo',
     //               store: bssWorkflowActionTypeStore,
     // /              valueField:'id',
     //               displayField:'value',
     //               fieldLabel: 'Action Type',
     //               queryMode: 'local',
     //               selectOnTab: false,
     //               name: 'actiontype',
     //               dataIndex: 'ActionType'
     //               //          value: BSSActionTypeValue
     //           },
     //           {
     //               id: 'idnotification',
     //               hidden: BSSISNOTIFICATION,
     //               xtype: 'combo',
     //               store: bssWorkflowNotificationListStore,
     //               valueField:'id',
      //              displayField:'value',
       //             fieldLabel: 'Notification',
        //            queryMode: 'local',
         //           selectOnTab: false,
          //          name: 'notification',
           //         dataIndex: 'notification'
           //         //   value: BSSNotificationValue
           //     },
      //          {
      //              id: 'idactionurl',
      //              hidden: BSSISACTION,
      //              xtype: 'textfield',
      //              fieldLabel: 'Action URL',
      //              name: 'ActionURL',
      //              dataIndex: 'ActionURL',
      //              value: BSSActionURL
      //
      //          },
                {
                  //  id: 'idinstructions',
                    xtype: 'textarea',
                    fieldLabel: 'Instructions',
                    hideLabel: false,
                    name: 'instructions',
                    dataIndex: 'instructions',
                    value: BSSInstructions,
                    style: 'margin:0', // Remove default margin
                    flex: 1  // Take up all *remaining* vertical space
                },

                {
                   // id: 'idtaskassignemnt',
                    xtype: 'combo',
                    store: userliststore,
                    valueField:'id',
                    displayField:'value',
                    fieldLabel: 'Task Assignmnt',
                    queryMode: 'local',
                    //       selectOnTab: false,
                    name: 'ApproverUserId',
                    //dataIndex: BSSTASKEE, // 'ApproverUserId',
                    value: BSSTASKEE,
                    submitValue : true,
                    //     hiddenName : 'id'
                    //  flex: 1,
                    forceSelection: false
                    //     disabled: true
                },
                {
                  //  id: 'idstart',
                    xtype: 'datefield',
                    fieldLabel: 'Start',
                    name: 'start',
                    dataIndex: 'start',
                    value: BSSStarted,
                    disabled: true
                },
                {
                  //  id: 'idcomplete',
                    xtype: 'datefield',
                    fieldLabel: 'Complete',
                    name: 'complete',
                    dataIndex: 'complete',
                    value: BSSCompleted,
                    disabled: true
                }
            ]
        });



        var tabs = Ext.create('Ext.tab.Panel', {
            //  renderTo: 'tabs1',
            width: 450,
            activeTab: 0,
            defaults :{
                bodyPadding: 10
            },
            items: [form]
        });


        Ext.getCmp('idstatustype').setValue(BSSstatustype);
        Ext.getCmp('idstatustype').setRawValue(BSSstatustypeValue);

   //     Ext.getCmp('idactontype').setRawValue(BSSActionType);
   //     Ext.getCmp('idactontype').setValue(BSSActionTypeValue);

   //     Ext.getCmp('idnotification').setRawValue(BSSNotification);
   //     Ext.getCmp('idnotification').setValue(BSSNotificationValue);

        //Ext.getCmp('idstatustype').valueField = BSSstatustype;

        var win = Ext.create('Ext.window.Window', {
            title: 'Workflow Step Description',
            collapsible: true,
            animCollapse: true,
            maximizable: true,
            width: 600,
            height: 400,
            minWidth: 300,
            minHeight: 200,
            layout: 'fit',
            items: tabs, //form,


            dockedItems: [{
                xtype: 'toolbar',
                dock: 'bottom',
                ui: 'footer',
                layout: {
                    pack: 'center'
                },
                items: [{
                    minWidth: 80,
                    text: 'Save',

                    handler: function(){

                        //    alert(bssWorkflowStatusData[BSSstatustype - 1].value);
                        //    alert(bssWorkflowStatusData[BSSstatustype - 1].id);

                        var BSSNewNotification = "";
                        var idactionurlval = "";
                        var BSSNewActionType = "";

                        var idval = Ext.getCmp('idwsform').getForm().findField("id").getValue();
                     //   var idxlocval = Ext.getCmp('idwsform').getForm().findField("idxloc").getValue();
                     //   var idylocval = Ext.getCmp('idwsform').getForm().findField("idyloc").getValue();
                        var idnameval = Ext.getCmp('idwsform').getForm().findField("idname").getValue();
                        var iddescriptionval = Ext.getCmp('idwsform').getForm().findField("iddescription").getValue();
              //          var idrevisionval = Ext.getCmp('idwsform').getForm().findField("idfrevision").getValue();
                 //       alert('1');

                        var idinstructionsval = Ext.getCmp('idwsform').getForm().findField("idinstructions").getValue();
                        var idapproveruser = Ext.getCmp('idwsform').getForm().findField("idtaskassignemnt").getValue();
                        alert(idapproveruser);
                        //   alert(Ext.getCmp('idwsform').getForm().findField("idstatustype").getRawValue());
                        //   alert(Ext.getCmp('idwsform').getForm().findField("idstatustype").getValue());
                        //    alert(Ext.getCmp('idwsform').getForm().findField("idstatustype").toString());

                        var r = bssWorkflowStatusListStore.find('value',Ext.getCmp('idwsform').getForm().findField("idstatustype").getRawValue());
                        var BSSNewStatusType = bssWorkflowStatusListStore.getAt(r).get('id');
                  //     alert('3');
                 //       alert(BSSNewStatusType);

                    //    if(BSSNewStatusType == 6){
                    //        var r = bssWorkflowActionTypeStore.find('value',Ext.getCmp('idwsform').getForm().findField("idactontype").getRawValue());
                    //        BSSNewActionType = bssWorkflowActionTypeStore.getAt(r).get('id');
                    //        idactionurlval = Ext.getCmp('idwsform').getForm().findField("idactionurl").getValue();
                    //    }
                    //    alert('4');
                        //  alert(Ext.getCmp('idwsform').getForm().findField("idnotification").getValue());
                   //     if(BSSNewStatusType == 7){
                   //         var r = bssWorkflowNotificationListStore.find('value',Ext.getCmp('idwsform').getForm().findField("idnotification").getRawValue());


                   //         if(r > -1){
                   //             BSSNewNotification = bssWorkflowNotificationListStore.getAt(r).get('id');
                   //         }else{BSSNewNotification=0}
                   //     }
                        //              alert('5');


                        //    function getCBSValue(cb, nameIn, nameOut){
                        //        try{
                        //            var r = cb.getStore().find(nameIn,cb.getValue());
                        //            return cb.getStore().getAt(r).get(nameOut);
                        //        }
                        //        catch(err){
                        //            return'error';
                        //        }
                        //    }

                        //    alert(bssWorkflowStatusData);
                        //    alert(bssWorkflowStatusData[BSSstatustype].id);
                        //    alert(bssWorkflowStatusData[Ext.getCmp('idwsform').getForm().findField("idstatustype").getValue()].id);
                        //    var idstatustypeval = bssWorkflowStatusData[Ext.getCmp('idwsform').getForm().findField("idstatustype").getValue()].id;
                        //    alert("in save1");                                                                                                                                                                                              //    var idactiontypeval = bssWorkflowActionTypeData[Ext.getCmp('idwsform').getForm().findField("idactontype").getValue()].id;
                        ///    alert("in save2");

                        //     var idnotificationval = Ext.getCmp('idwsform').getForm().findField("idnotification").getValue();


                        //     var idxlocval = Ext.getCmp('idwsform').getForm().findField("idxloc").getValue();
                        //     var idylocval = Ext.getCmp('idwsform').getForm().findField("idyloc").getValue();

                        // alert('in uypdate why?');

                        try{

                        var updSQLString = 'UPDATE AdvWorkflowSteps SET '
   //                             + ' xloc = ' + idxlocval  + ","
   //                             + ' yloc = ' + idylocval  + ","
                                + ' name = ' + "'" + idnameval  + "'" + ","
                                + ' description = ' + "'" + iddescriptionval + "'"  + ","
 //                               + ' statustype = ' + BSSNewStatusType  + ","
                                + ' Instructions = ' + "'" + idinstructionsval  + "'"  + ","
                                + ' ApproverUserId = ' + "'" + idapproveruser + "'"
                                + ' WHERE stepkey = ' + idval + ' AND WorkflowId = ' + BSSWorkflowId;

                 //       alert(updSQLString);

                        }catch(e){
                            alert(e);
                        }

                        BSSUserId = "0";

                        var xmlHttp = null;
                        xmlHttp = new XMLHttpRequest();
                        xmlHttp.open( "GET", "BSSPerformSQLCommand.php?BSSSQLCommand=" + updSQLString + "&userid=" + BSSUserId, false );
                        xmlHttp.send(null);

                        alert(xmlHttp.responseText);

                    }

                },{
                    minWidth: 80,
                    text: 'Cancel',
                    handler: function(){win.close(); win.destroy(); Ext.getCmp('idwsform').close();}
                }]
            }]



        });

        win.show();


    }catch(e){alert(e.message)}

}

function OpenSubmitForm(WorkflowID, Key, Category){

        var BSSWorkflowStepName;
        BSSWorkflowStepId = Key;

        try{
            xmlHttp = new XMLHttpRequest();
            xmlHttp.open( "GET", "BSSGetAdvWorkflowStepData.php?BSSWorkflowId= " + BSSWorkflowId +  "&BSSWorkflowStepId=" +  BSSWorkflowStepId, false );
            xmlHttp.send( null );
            alert("DATA: " + xmlHttp.responseText);
            var wsdata =eval('[' + xmlHttp.responseText + ']');

            var BSSID = wsdata[0].id;
            var BSSXLOC = wsdata[0].xloc;
            var BSSYLOC = wsdata[0].yloc;
            var BSSTASKEE = parseInt(wsdata[0].ApproverUserId);   // Make sure its int
            var BSSstatustype = wsdata[0].statustype;
            if(BSSstatustype==''){BSSstatustype=1;}
            //           alert(BSSstatustype);
            var BSSstatustypeValue =  bssWorkflowStatusData[BSSstatustype - 1].value;
            var BSSStarted = wsdata[0].Started;
            var BSSCompleted = wsdata[0].Completed;
            var BSSInstructions = wsdata[0].Instructions;
            var BSSErrorResult = wsdata[0].ErrorResult;
            var BSSName = wsdata[0].name;
            var BSSDescription = wsdata[0].description;
            //  masterStore.loadData(newdata,false);
        }catch(e)
        {alert("Master Data Get ERROR: " + e.message);
        }

        try{
            var form = Ext.create('Ext.form.Panel', {
                id: 'idwsform',
                plain: false,
                border: 0,
                title: 'Status Detail',
                width: 360,
                bodyPadding: 5,
                url: 'BSSSaveWorkflowStep.php',
                fieldDefaults: {
                    labelWidth: 70,
                    anchor: '100%'
                },
                layout: {
                    type: 'vbox',
                    align: 'stretch'  // Child items are stretched to full width
                },
                items: [
                    { //  id: 'id',
                        xtype: 'textfield',
                        fieldLabel: 'id',
                        name: 'id',
                        dataIndex: 'id',
                        value: Key,
                        disabled: true},
                    { //  id: 'idxloc',
                        xtype: 'textfield',
                        fieldLabel: 'X',
                        name: 'xloc',
                        dataIndex: 'xloc',
                        value: BSSXLOC, //  valx / 70,
                        disabled: true},
                    { //  id: 'idyloc',
                        xtype: 'textfield',
                        fieldLabel: 'Y',
                        name: 'yloc',
                        dataIndex: 'yloc',
                        value: BSSYLOC,   //valy / 35,
                        disabled: true},
                    {
                      //  id: 'idname',
                        xtype: 'textfield',
                        fieldLabel: 'Name',
                        name: 'name',
                        dataIndex: 'name',
                        value: BSSName
                    },
                    { //  id: 'iddescription',
                        xtype: 'textfield',
                        fieldLabel: 'Description',
                        name: 'description',
                        //         dataIndex: 'description',
                        value: BSSDescription},
                    {  id: 'idstatustype',
                        xtype: 'combo',
                        //  store: bssWorkflowStatusListStore,
                        valueField:'id',
                        displayField:'value',
                        fieldLabel: 'Status Type',
                        queryMode: 'local',
                        //       selectOnTab: false,
                        name: 'statustype',
                        //dataIndex: 'statustype',
                        displayValue: 'Task',
                        submitValue : true,
                        //     hiddenName : 'id'
                        //  flex: 1,
                        forceSelection: false
                        //     disabled: true
                    },
                    //           {
                    //               id: 'idactontype',
                    //               hidden: BSSISACTION,
                    //               xtype: 'combo',
                    //               store: bssWorkflowActionTypeStore,
                    // /              valueField:'id',
                    //               displayField:'value',
                    //               fieldLabel: 'Action Type',
                    //               queryMode: 'local',
                    //               selectOnTab: false,
                    //               name: 'actiontype',
                    //               dataIndex: 'ActionType'
                    //               //          value: BSSActionTypeValue
                    //           },
                    //           {
                    //               id: 'idnotification',
                    //               hidden: BSSISNOTIFICATION,
                    //               xtype: 'combo',
                    //               store: bssWorkflowNotificationListStore,
                    //               valueField:'id',
                    //              displayField:'value',
                    //             fieldLabel: 'Notification',
                    //            queryMode: 'local',
                    //           selectOnTab: false,
                    //          name: 'notification',
                    //         dataIndex: 'notification'
                    //         //   value: BSSNotificationValue
                    //     },
                    //          {
                    //              id: 'idactionurl',
                    //              hidden: BSSISACTION,
                    //              xtype: 'textfield',
                    //              fieldLabel: 'Action URL',
                    //              name: 'ActionURL',
                    //              dataIndex: 'ActionURL',
                    //              value: BSSActionURL
                    //
                    //          },
                    {
                      //  id: 'idinstructions',
                        xtype: 'textarea',
                        fieldLabel: 'Instructions',
                        hideLabel: false,
                        name: 'instructions',
                        dataIndex: 'instructions',
                        value: BSSInstructions,
                        style: 'margin:0', // Remove default margin
                        flex: 1  // Take up all *remaining* vertical space
                    },

                    {
                     //   id: 'idtaskassignemnt',
                        xtype: 'combo',
                        store: userliststore,
                        valueField:'id',
                        displayField:'value',
                        fieldLabel: 'Task Assignmnt',
                        queryMode: 'local',
                        //       selectOnTab: false,
                        name: 'ApproverUserId',
                        //dataIndex: BSSTASKEE, // 'ApproverUserId',
                        value: BSSTASKEE,
                        submitValue : true,
                        //     hiddenName : 'id'
                        //  flex: 1,
                        forceSelection: false
                        //     disabled: true
                    },
                    {
                     //   id: 'idstart',
                        xtype: 'datefield',
                        fieldLabel: 'Start',
                        name: 'start',
                        dataIndex: 'start',
                        value: BSSStarted,
                        disabled: true
                    },
                    {
                     //   id: 'idcomplete',
                        xtype: 'datefield',
                        fieldLabel: 'Complete',
                        name: 'complete',
                        dataIndex: 'complete',
                        value: BSSCompleted,
                        disabled: true
                    }
                ]
            });



            var tabs = Ext.create('Ext.tab.Panel', {
                //  renderTo: 'tabs1',
                width: 450,
                activeTab: 0,
                defaults :{
                    bodyPadding: 10
                },
                items: [form]
            });


            Ext.getCmp('idstatustype').setValue(BSSstatustype);
            Ext.getCmp('idstatustype').setRawValue(BSSstatustypeValue);

            //     Ext.getCmp('idactontype').setRawValue(BSSActionType);
            //     Ext.getCmp('idactontype').setValue(BSSActionTypeValue);

            //     Ext.getCmp('idnotification').setRawValue(BSSNotification);
            //     Ext.getCmp('idnotification').setValue(BSSNotificationValue);

            //Ext.getCmp('idstatustype').valueField = BSSstatustype;

            var win = Ext.create('Ext.window.Window', {
                title: 'Workflow Step Description',
                collapsible: true,
                animCollapse: true,
                maximizable: true,
                width: 600,
                height: 400,
                minWidth: 300,
                minHeight: 200,
                layout: 'fit',
                items: tabs, //form,


                dockedItems: [{
                    xtype: 'toolbar',
                    dock: 'bottom',
                    ui: 'footer',
                    layout: {
                        pack: 'center'
                    },
                    items: [{
                        minWidth: 80,
                        text: 'Save',

                        handler: function(){

                            //    alert(bssWorkflowStatusData[BSSstatustype - 1].value);
                            //    alert(bssWorkflowStatusData[BSSstatustype - 1].id);

                            var BSSNewNotification = "";
                            var idactionurlval = "";
                            var BSSNewActionType = "";

                            var idval = Ext.getCmp('idwsform').getForm().findField("id").getValue();
                            //   var idxlocval = Ext.getCmp('idwsform').getForm().findField("idxloc").getValue();
                            //   var idylocval = Ext.getCmp('idwsform').getForm().findField("idyloc").getValue();
                            var idnameval = Ext.getCmp('idwsform').getForm().findField("idname").getValue();
                            var iddescriptionval = Ext.getCmp('idwsform').getForm().findField("iddescription").getValue();
                            //          var idrevisionval = Ext.getCmp('idwsform').getForm().findField("idfrevision").getValue();
                            //       alert('1');

                            var idinstructionsval = Ext.getCmp('idwsform').getForm().findField("idinstructions").getValue();
                            var idapproveruser = Ext.getCmp('idwsform').getForm().findField("idtaskassignemnt").getValue();
                            alert(idapproveruser);
                            //   alert(Ext.getCmp('idwsform').getForm().findField("idstatustype").getRawValue());
                            //   alert(Ext.getCmp('idwsform').getForm().findField("idstatustype").getValue());
                            //    alert(Ext.getCmp('idwsform').getForm().findField("idstatustype").toString());

                            var r = bssWorkflowStatusListStore.find('value',Ext.getCmp('idwsform').getForm().findField("idstatustype").getRawValue());
                            var BSSNewStatusType = bssWorkflowStatusListStore.getAt(r).get('id');
                            //     alert('3');
                            //       alert(BSSNewStatusType);

                            //    if(BSSNewStatusType == 6){
                            //        var r = bssWorkflowActionTypeStore.find('value',Ext.getCmp('idwsform').getForm().findField("idactontype").getRawValue());
                            //        BSSNewActionType = bssWorkflowActionTypeStore.getAt(r).get('id');
                            //        idactionurlval = Ext.getCmp('idwsform').getForm().findField("idactionurl").getValue();
                            //    }
                            //    alert('4');
                            //  alert(Ext.getCmp('idwsform').getForm().findField("idnotification").getValue());
                            //     if(BSSNewStatusType == 7){
                            //         var r = bssWorkflowNotificationListStore.find('value',Ext.getCmp('idwsform').getForm().findField("idnotification").getRawValue());


                            //         if(r > -1){
                            //             BSSNewNotification = bssWorkflowNotificationListStore.getAt(r).get('id');
                            //         }else{BSSNewNotification=0}
                            //     }
                            //              alert('5');


                            //    function getCBSValue(cb, nameIn, nameOut){
                            //        try{
                            //            var r = cb.getStore().find(nameIn,cb.getValue());
                            //            return cb.getStore().getAt(r).get(nameOut);
                            //        }
                            //        catch(err){
                            //            return'error';
                            //        }
                            //    }

                            //    alert(bssWorkflowStatusData);
                            //    alert(bssWorkflowStatusData[BSSstatustype].id);
                            //    alert(bssWorkflowStatusData[Ext.getCmp('idwsform').getForm().findField("idstatustype").getValue()].id);
                            //    var idstatustypeval = bssWorkflowStatusData[Ext.getCmp('idwsform').getForm().findField("idstatustype").getValue()].id;
                            //    alert("in save1");                                                                                                                                                                                              //    var idactiontypeval = bssWorkflowActionTypeData[Ext.getCmp('idwsform').getForm().findField("idactontype").getValue()].id;
                            ///    alert("in save2");

                            //     var idnotificationval = Ext.getCmp('idwsform').getForm().findField("idnotification").getValue();


                            //     var idxlocval = Ext.getCmp('idwsform').getForm().findField("idxloc").getValue();
                            //     var idylocval = Ext.getCmp('idwsform').getForm().findField("idyloc").getValue();

                            // alert('in uypdate why?');

                            try{

                                var updSQLString = 'UPDATE AdvWorkflowSteps SET '
                                    //                             + ' xloc = ' + idxlocval  + ","
                                    //                             + ' yloc = ' + idylocval  + ","
                                        + ' name = ' + "'" + idnameval  + "'" + ","
                                        + ' description = ' + "'" + iddescriptionval + "'"  + ","
                                    //                               + ' statustype = ' + BSSNewStatusType  + ","
                                        + ' Instructions = ' + "'" + idinstructionsval  + "'"  + ","
                                        + ' ApproverUserId = ' + "'" + idapproveruser + "'"
                                        + ' WHERE stepkey = ' + idval + ' AND WorkflowId = ' + BSSWorkflowId;

                                //       alert(updSQLString);

                            }catch(e){
                                alert(e);
                            }

                            BSSUserId = "0";

                            var xmlHttp = null;
                            xmlHttp = new XMLHttpRequest();
                            xmlHttp.open( "GET", "BSSPerformSQLCommand.php?BSSSQLCommand=" + updSQLString + "&userid=" + BSSUserId, false );
                            xmlHttp.send(null);

                            alert(xmlHttp.responseText);

                        }

                    },{
                        minWidth: 80,
                        text: 'Cancel',
                        handler: function(){win.close(); win.destroy(); Ext.getCmp('idwsform').close();}
                    }]
                }]



            });

            win.show();


        }catch(e){alert(e.message)}


    }



    function nodeStyle() {
      return [
        // The Node.location comes from the "loc" property of the node data,
        // converted by the Point.parse static method.
        // If the Node.location is changed, it updates the "loc" property of the node data,
        // converting back using the Point.stringify static method.
        new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
        {
          // the Node.location is at the center of each node
          locationSpot: go.Spot.Center,
          //isShadowed: true,
          //shadowColor: "#888",
          // handle mouse enter/leave events to show/hide the ports
          mouseEnter: function (e, obj) { showPorts(obj.part, true); },
          mouseLeave: function (e, obj) { showPorts(obj.part, false); }
        }
      ];
    }





function OpenActionForm(WorkflowID, Key, Category){

    var BSSWorkflowStepName;
    BSSWorkflowStepId = Key;

    try{
        xmlHttp = new XMLHttpRequest();
        xmlHttp.open( "GET", "BSSGetAdvWorkflowStepData.php?BSSWorkflowId= " + BSSWorkflowId +  "&BSSWorkflowStepId=" +  BSSWorkflowStepId, false );
        xmlHttp.send( null );
    //    alert("DATA: " + xmlHttp.responseText);
        var wsdata =eval('[' + xmlHttp.responseText + ']');



        var BSSID = wsdata[0].id;
        var BSSXLOC = wsdata[0].xloc;
        var BSSYLOC = wsdata[0].yloc;
        var BSSTASKEE = parseInt(wsdata[0].ApproverUserId);   // Make sure its int
        var BSSstatustype = wsdata[0].statustype;
        if(BSSstatustype==''){BSSstatustype=1;}

        var BSSActionURL = wsdata[0].ActionURL;
        //           alert(BSSstatustype);
        var BSSstatustypeValue =  bssWorkflowStatusData[BSSstatustype - 1].value;
        var BSSStarted = wsdata[0].Started;
        var BSSCompleted = wsdata[0].Completed;
        var BSSInstructions = wsdata[0].Instructions;
        var BSSErrorResult = wsdata[0].ErrorResult;
        var BSSName = wsdata[0].name;
        var BSSDescription = wsdata[0].description;
        //  masterStore.loadData(newdata,false);
    }catch(e)
    {alert("Master Data Get ERROR: " + e.message);
    }

    try{

        var form = Ext.create('Ext.form.Panel', {
            id: 'idwsform',
            plain: false,
            border: 0,
            title: 'Status Detail',
            width: 360,
            bodyPadding: 5,
            url: 'BSSSaveWorkflowStep.php',
            fieldDefaults: {
                labelWidth: 70,
                anchor: '100%'
            },
            layout: {
                type: 'vbox',
                align: 'stretch'  // Child items are stretched to full width
            },
            items: [
                {   id: 'id',
                    xtype: 'textfield',
                    fieldLabel: 'id',
                    name: 'id',
                    dataIndex: 'id',
                    value: Key,
                    disabled: true},
                {   id: 'idxloc',
                    xtype: 'textfield',
                    fieldLabel: 'X',
                    name: 'xloc',
                    dataIndex: 'xloc',
                    value: BSSXLOC, //  valx / 70,
                    disabled: true},
                {   id: 'idyloc',
                    xtype: 'textfield',
                    fieldLabel: 'Y',
                    name: 'yloc',
                    dataIndex: 'yloc',
                    value: BSSYLOC,   //valy / 35,
                    disabled: true},
                {
                    id: 'idname',
                    xtype: 'textfield',
                    fieldLabel: 'Name',
                    name: 'name',
                    dataIndex: 'name',
                    value: BSSName
                },
                {   id: 'iddescription',
                    xtype: 'textfield',
                    fieldLabel: 'Description',
                    name: 'description',
                    //         dataIndex: 'description',
                    value: BSSDescription},
                {   id: 'idstatustype',
                    xtype: 'combo',
                    //  store: bssWorkflowStatusListStore,
                    valueField:'id',
                    displayField:'value',
                    fieldLabel: 'Status Type',
                    queryMode: 'local',
                    //       selectOnTab: false,
                    name: 'statustype',
                    //dataIndex: 'statustype',
                    displayValue: 'Task',
                    submitValue : true,
                    //     hiddenName : 'id'
                    //  flex: 1,
                    forceSelection: false
                    //     disabled: true
                },
           //                {
           //                    id: 'idactontype',
           //                    xtype: 'combo',
           //                    store: bssWorkflowActionTypeStore,
           //                   valueField:'id',
           //                    displayField:'value',
           //                    fieldLabel: 'Action Type',
           //                    queryMode: 'local',
           //                    selectOnTab: false,
           //                    name: 'actiontype',
           //                    dataIndex: 'ActionType'
                               //          value: BSSActionTypeValue
           //                },
                //           {
                //               id: 'idnotification',
                //               hidden: BSSISNOTIFICATION,
                //               xtype: 'combo',
                //               store: bssWorkflowNotificationListStore,
                //               valueField:'id',
                //              displayField:'value',
                //             fieldLabel: 'Notification',
                //            queryMode: 'local',
                //           selectOnTab: false,
                //          name: 'notification',
                //         dataIndex: 'notification'
                //         //   value: BSSNotificationValue
                //     },
                          {
                              id: 'idactionurl',
                              xtype: 'textfield',
                              fieldLabel: 'Action URL',
                              name: 'ActionURL',
                              dataIndex: 'ActionURL',
                              value: BSSActionURL

                          },
                {
                    id: 'idinstructions',
                    xtype: 'textarea',
                    fieldLabel: 'Notes',
                    hideLabel: false,
                    name: 'instructions',
                    dataIndex: 'instructions',
                    value: BSSInstructions,
                    style: 'margin:0', // Remove default margin
                    flex: 1  // Take up all *remaining* vertical space
                }

           //     {
           //         id: 'idtaskassignemnt',
           //         xtype: 'combo',
           //         store: userliststore,
           //         valueField:'id',
           //         displayField:'value',
           //         fieldLabel: 'Task Assignmnt',
           //         queryMode: 'local',
           //         //       selectOnTab: false,
           //         name: 'ApproverUserId',
           //         //dataIndex: BSSTASKEE, // 'ApproverUserId',
           //         value: BSSTASKEE,
           //         submitValue : true,
           //         //     hiddenName : 'id'
           //         //  flex: 1,
           //         forceSelection: false
           //         //     disabled: true
           //     },
     //           {
      //              id: 'idstart',
      //              xtype: 'datefield',
      //              fieldLabel: 'Start',
      //              name: 'start',
      //              dataIndex: 'start',
      //              value: BSSStarted,
      //              disabled: true
      //          },
      //          {
      //              id: 'idcomplete',
      //              xtype: 'datefield',
       //             fieldLabel: 'Complete',
       //             name: 'complete',
       //             dataIndex: 'complete',
       //             value: BSSCompleted,
       //             disabled: true
       //         }
            ]
        });

        var formprocessresult = Ext.create('Ext.form.Panel', {
            id: 'idwsformh',
            plain: false,
            border: 0,
            title: 'Process Result',
            width: 290,
            bodyPadding: 5,
            url: 'BSSSaveWorkflowStep.php',

            fieldDefaults: {
                labelWidth: 70,
                anchor: '100%'
            },

            layout: {
                type: 'vbox',
                align: 'stretch'  // Child items are stretched to full width
            },


            items: [
                {id: 'idstart',
                 xtype: 'datefield',
                 fieldLabel: 'Start',
                 name: 'start',
                 dataIndex: 'start',
                 value: BSSStarted,
                 disabled: true},
                {id: 'idcomplete',
                xtype: 'datefield',
                fieldLabel: 'Complete',
                name: 'complete',
                dataIndex: 'complete',
                value: BSSCompleted,
                disabled: true},
                {
                    id: 'iderrorresult',
                    xtype: 'textarea',
                    fieldLabel: 'Error Result',
                    hideLabel: false,
                    name: 'errorresult',
                    dataIndex: 'errorresult',
                    value: BSSErrorResult,
                    style: 'margin:0', // Remove default margin
                    flex: 1  // Take up all *remaining* vertical space
                }
            ]
        });


        var tabs = Ext.create('Ext.tab.Panel', {
            //  renderTo: 'tabs1',
            width: 450,
            activeTab: 0,
            defaults :{
                bodyPadding: 10
            },
            items: [form, formprocessresult]
        });


        Ext.getCmp('idstatustype').setValue(BSSstatustype);
        Ext.getCmp('idstatustype').setRawValue(BSSstatustypeValue);

        //     Ext.getCmp('idactontype').setRawValue(BSSActionType);
        //     Ext.getCmp('idactontype').setValue(BSSActionTypeValue);

        //     Ext.getCmp('idnotification').setRawValue(BSSNotification);
        //     Ext.getCmp('idnotification').setValue(BSSNotificationValue);

        //Ext.getCmp('idstatustype').valueField = BSSstatustype;

        var win = Ext.create('Ext.window.Window', {
            title: 'Workflow Step Description',
            collapsible: true,
            animCollapse: true,
            maximizable: true,
            width: 600,
            height: 400,
            minWidth: 300,
            minHeight: 200,
            layout: 'fit',
            items: tabs, //form,


            dockedItems: [{
                xtype: 'toolbar',
                dock: 'bottom',
                ui: 'footer',
                layout: {
                    pack: 'center'
                },
                items: [{
                    minWidth: 80,
                    text: 'Save',

                    handler: function(){

                        //    alert(bssWorkflowStatusData[BSSstatustype - 1].value);
                        //    alert(bssWorkflowStatusData[BSSstatustype - 1].id);

                        var BSSNewNotification = "";
                        var idactionurlval = "";
                        var BSSNewActionType = "";

                        var idval = Ext.getCmp('idwsform').getForm().findField("id").getValue();
                        //   var idxlocval = Ext.getCmp('idwsform').getForm().findField("idxloc").getValue();
                        //   var idylocval = Ext.getCmp('idwsform').getForm().findField("idyloc").getValue();
                        var idnameval = Ext.getCmp('idwsform').getForm().findField("idname").getValue();
                        var iddescriptionval = Ext.getCmp('idwsform').getForm().findField("iddescription").getValue();
                        //          var idrevisionval = Ext.getCmp('idwsform').getForm().findField("idfrevision").getValue();
                        //       alert('1');

                        var idinstructionsval = Ext.getCmp('idwsform').getForm().findField("idinstructions").getValue();
                        var idapproveruser = Ext.getCmp('idwsform').getForm().findField("idtaskassignemnt").getValue();
                        alert(idapproveruser);
                        //   alert(Ext.getCmp('idwsform').getForm().findField("idstatustype").getRawValue());
                        //   alert(Ext.getCmp('idwsform').getForm().findField("idstatustype").getValue());
                        //    alert(Ext.getCmp('idwsform').getForm().findField("idstatustype").toString());

                        var r = bssWorkflowStatusListStore.find('value',Ext.getCmp('idwsform').getForm().findField("idstatustype").getRawValue());
                        var BSSNewStatusType = bssWorkflowStatusListStore.getAt(r).get('id');
                        //     alert('3');
                        //       alert(BSSNewStatusType);

                        //    if(BSSNewStatusType == 6){
                        //        var r = bssWorkflowActionTypeStore.find('value',Ext.getCmp('idwsform').getForm().findField("idactontype").getRawValue());
                        //        BSSNewActionType = bssWorkflowActionTypeStore.getAt(r).get('id');
                        //        idactionurlval = Ext.getCmp('idwsform').getForm().findField("idactionurl").getValue();
                        //    }
                        //    alert('4');
                        //  alert(Ext.getCmp('idwsform').getForm().findField("idnotification").getValue());
                        //     if(BSSNewStatusType == 7){
                        //         var r = bssWorkflowNotificationListStore.find('value',Ext.getCmp('idwsform').getForm().findField("idnotification").getRawValue());


                        //         if(r > -1){
                        //             BSSNewNotification = bssWorkflowNotificationListStore.getAt(r).get('id');
                        //         }else{BSSNewNotification=0}
                        //     }
                        //              alert('5');


                        //    function getCBSValue(cb, nameIn, nameOut){
                        //        try{
                        //            var r = cb.getStore().find(nameIn,cb.getValue());
                        //            return cb.getStore().getAt(r).get(nameOut);
                        //        }
                        //        catch(err){
                        //            return'error';
                        //        }
                        //    }

                        //    alert(bssWorkflowStatusData);
                        //    alert(bssWorkflowStatusData[BSSstatustype].id);
                        //    alert(bssWorkflowStatusData[Ext.getCmp('idwsform').getForm().findField("idstatustype").getValue()].id);
                        //    var idstatustypeval = bssWorkflowStatusData[Ext.getCmp('idwsform').getForm().findField("idstatustype").getValue()].id;
                        //    alert("in save1");                                                                                                                                                                                              //    var idactiontypeval = bssWorkflowActionTypeData[Ext.getCmp('idwsform').getForm().findField("idactontype").getValue()].id;
                        ///    alert("in save2");

                        //     var idnotificationval = Ext.getCmp('idwsform').getForm().findField("idnotification").getValue();


                        //     var idxlocval = Ext.getCmp('idwsform').getForm().findField("idxloc").getValue();
                        //     var idylocval = Ext.getCmp('idwsform').getForm().findField("idyloc").getValue();

                        // alert('in uypdate why?');

                        try{

                            var updSQLString = 'UPDATE AdvWorkflowSteps SET '
                                //                             + ' xloc = ' + idxlocval  + ","
                                //                             + ' yloc = ' + idylocval  + ","
                                    + ' name = ' + "'" + idnameval  + "'" + ","
                                    + ' description = ' + "'" + iddescriptionval + "'"  + ","
                                //                               + ' statustype = ' + BSSNewStatusType  + ","
                                    + ' Instructions = ' + "'" + idinstructionsval  + "'"  + ","
                                    + ' ApproverUserId = ' + "'" + idapproveruser + "'"
                                    + ' WHERE stepkey = ' + idval + ' AND WorkflowId = ' + BSSWorkflowId;

                            //       alert(updSQLString);

                        }catch(e){
                            alert(e);
                        }

                        BSSUserId = "0";

                        var xmlHttp = null;
                        xmlHttp = new XMLHttpRequest();
                        xmlHttp.open( "GET", "BSSPerformSQLCommand.php?BSSSQLCommand=" + updSQLString + "&userid=" + BSSUserId, false );
                        xmlHttp.send(null);

                        alert(xmlHttp.responseText);

                    }

                },{
                    minWidth: 80,
                    text: 'Cancel',
                    handler: function(){win.close(); win.destroy(); Ext.getCmp('idwsform').close();}
                }]
            }]



        });

        win.show();


    }catch(e){alert(e.message)}










}

function OpenNotificationForm(WorkflowID, Key, Category){


        var BSSWorkflowStepName;
        BSSWorkflowStepId = Key;

        try{
            //Get the data
            xmlHttp = new XMLHttpRequest();
            xmlHttp.open( "GET", "BSSGetAdvWorkflowStepData.php?BSSWorkflowId= " + BSSWorkflowId +  "&BSSWorkflowStepId=" +  BSSWorkflowStepId, false );

            //    xmlHttp.open( "GET", "BSSGetAdvWorkflowStepData.php?BSSWorkflowStepId=" +  BSSWorkflowStepId, false );
            xmlHttp.send( null );
            alert("DATA: " + xmlHttp.responseText);
            var wsdata =eval('[' + xmlHttp.responseText + ']');

            //  var wsdata = JSON.parse(xmlHttp.responseText);


            /*

             alert(wsdata[0].id);
             alert(wsdata[1].ActionURL);
             alert(wsdata[2].xloc);
             alert(wsdata[3].yloc);
             alert(wsdata[4].ActionType);
             alert(wsdata[5].statustype);
             alert(wsdata[6].Notification);
             alert(wsdata[7].Revision);
             alert(wsdata[8].Started);
             alert(wsdata[9].Completed);
             alert(wsdata[10].Instructions);
             alert(wsdata[11].ErrorResult);
             alert(wsdata[12].name);
             alert(wsdata[13].description);



             {id:1, value: 'Pending'},
             {id:2, value: 'Submit'},
             {id:3, value: 'Review'},
             {id:4, value: 'Release'},
             {id:5, value: 'Complete'},
             {id:6, value: 'Notify'},
             {id:7, value: 'Action'}
             */

            var BSSISACTION = true;
            var BSSISNOTIFICATION = true;

            if(Category == 'ACTION')
            {
                BSSISACTION = false;
            }

            if(Category == 'NOTIFY')
            {
                BSSISNOTIFICATION = false;
            }

            var BSSID = wsdata[0].id;
            var BSSXLOC = wsdata[0].xloc;
            var BSSYLOC = wsdata[0].yloc;

            if(BSSISACTION == false){
                var BSSActionURL = wsdata[0].ActionURL;
                var BSSActionType = wsdata[0].ActionType;
                if(BSSActionType==''){BSSActionType=1;}
                var BSSActionTypeValue = bssWorkflowActionTypeData[BSSActionType - 1].value;
            }

            var BSSstatustype = wsdata[0].statustype;
            if(BSSstatustype==''){BSSstatustype=1;}
            //           alert(BSSstatustype);
            var BSSstatustypeValue =  bssWorkflowStatusData[BSSstatustype - 1].value;


            if(BSSISNOTIFICATION == false){
                var BSSNotification = wsdata[0].Notification;
                var BSSNotificationValue = "";
                var r = bssWorkflowNotificationListStore.find('id',BSSNotification);   // find the index of the id in the array
                // alert(r);
                if(BSSNotification != ''){
                    BSSNotificationValue = bssWorkflowNotificationListStore.getAt(r).get('value');  // get the value
                }
            }

            var BSSRevision = wsdata[0].Revision;
            var BSSStarted = wsdata[0].Started;
            var BSSCompleted = wsdata[0].Completed;
            var BSSInstructions = wsdata[0].Instructions;
            var BSSErrorResult = wsdata[0].ErrorResult;
            var BSSName = wsdata[0].name;
            var BSSDescription = wsdata[0].description;


            //  masterStore.loadData(newdata,false);
        }catch(e)
        {alert("Master Data Get ERROR: " + e.message);
        }


        try{

            var signoffs = Ext.create('Ext.grid.Panel', {
                id: 'signoffgrid',
                hidden: false,
                store: signoffsStore,
                //    listeners: {itemclick: function() {alert('SSS');}},
                listeners: {activate: function() {GetSignOffs();}},
                selModel: 'cellmodel',
                columns: [
                    {id: 'idsignoff',
                        header: 'Id',
                        disabled: true,
                        listeners: {
                            beforeedit: function(){
                                return false;
                            }},
                        width: 10,
                        dataIndex: 'id',
                        editor: {
                            allowBlank: false
                        }
                    },
                    {id: 'masteridsignoff',
                        header: 'Id',
                        disabled: true,
                        listeners: {
                            beforeedit: function(){
                                return false;
                            }},
                        width: 10,
                        dataIndex: 'masterid',
                        editor: {
                            allowBlank: false
                        }
                    },{id: 'sequenceasignoff',
                        header: 'Id',
                        disabled: true,
                        listeners: {
                            beforeedit: function(){
                                return false;
                            }},
                        width: 10,
                        dataIndex: 'sequence',
                        editor: {
                            allowBlank: false
                        }
                    },
                    {id: 'idWorkflowApprover',
                        header: 'Workflow Approver',
                        disabled: false,
                        width: 180,
                        dataIndex: 'WorkflowApprover',
                        editor:
                        { xtype: 'combobox',
                            typeAhead: true,
                            selectOnTab: true,
                            triggerAction: 'all',
                            fields:['id','value'],
                            store: userliststore, //[[1, 'GLOBAL'],[2, 'USER']],
                            valueField:'id',
                            displayField:'value',
                            multiSelect: false,
                            queryMode: 'local',
                            lazyRender: true,
                            listClass: 'x-combo-list-small'},
                        renderer: function(val) {var matching =  userliststore.queryBy( function(rec){ return rec.data.id == val; }); return (matching.items[0]) ? matching.items[0].data.value : ''}
                    },

                    {id: 'idSignoffDate',
                        header: 'Signoff Date',
                        disabled: false,
                        width: 100,
                        dataIndex: 'SignoffDate',
                        editor: {
                            allowBlank: false
                        }
                    },

                    {id: 'idSignoffResult',
                        header: 'Signoff Result',
                        disabled: false,
                        width: 100,
                        dataIndex: 'SignoffResult',
                        editor:
                        { xtype: 'combobox',
                            typeAhead: true,
                            selectOnTab: true,
                            triggerAction: 'all',
                            fields:['id','value'],
                            store: workflowapprovalstatusliststore, //[[1, 'GLOBAL'],[2, 'USER']],
                            valueField:'id',
                            displayField:'value',
                            multiSelect: false,
                            queryMode: 'local',
                            lazyRender: true,
                            listClass: 'x-combo-list-small'},
                        renderer: function(val) {var matching =  workflowapprovalstatusliststore.queryBy( function(rec){ return rec.data.id == val; }); return (matching.items[0]) ? matching.items[0].data.value : ''}


                    },
                    {id: 'idComments',
                        header: 'Comments',
                        disabled: false,
                        width: 100,
                        dataIndex: 'Comments',
                        editor: {
                            allowBlank: false
                        }
                    }],
                width: 350,
                height: 200,
                x: 2,
                y: 2,
                title: 'Notification List',
                frame: true,
                tbar: [{text: 'Approve', disabled: BSSSIGNOFF_FLAG, handler : function() {ApproveWorkflow("Workflows");}},
                    {text: 'Reject', disabled: BSSSIGNOFF_FLAG, handler : function() {RejectWorkflow("Workflows");}},
                    {text: 'Add Approver', disabled: BSSADDREMOVEAPPROVERS, handler : function() {AddApprovers();}},
                    {text: 'Remove Approver',disabled: BSSADDREMOVEAPPROVERS, handler : function() {removeApprovers();}}


                ],
                plugins: [cellEditing6]
            });




            //     alert(BSSISACTION);

            //       alert(BSSISNOTIFICATION);

            var form = Ext.create('Ext.form.Panel', {
                id: 'idwsform',
                plain: false,
                border: 0,
                title: 'Status Detail',
                width: 360,
                bodyPadding: 5,
                url: 'BSSSaveWorkflowStep.php',

                fieldDefaults: {
                    labelWidth: 70,
                    anchor: '100%'
                },

                layout: {
                    type: 'vbox',
                    align: 'stretch'  // Child items are stretched to full width
                },


                items: [
                    {
                        id: 'id',
                        xtype: 'textfield',
                        fieldLabel: 'id',
                        name: 'id',
                        dataIndex: 'id',
                        value: Key,
                        disabled: true
                    },
                    {
                        id: 'idxloc',
                        xtype: 'textfield',
                        fieldLabel: 'X',
                        name: 'xloc',
                        dataIndex: 'xloc',
                        value: BSSXLOC, //  valx / 70,
                        disabled: true
                    },
                    {
                        id: 'idyloc',
                        xtype: 'textfield',
                        fieldLabel: 'Y',
                        name: 'yloc',
                        dataIndex: 'yloc',
                        value: BSSYLOC,   //valy / 35,
                        disabled: true
                    },
                    {
                        id: 'idname',
                        xtype: 'textfield',
                        fieldLabel: 'Name',
                        name: 'name',
                        dataIndex: 'name',
                        value: BSSName
                    },
                    {
                        id: 'idsubject',
                        xtype: 'textfield',
                        fieldLabel: 'Subject',
                        name: 'description',
                        //         dataIndex: 'description',
                        value: BSSDescription
                    },
                    {
                        id: 'idfrevision',
                        name: 'txtrevision',
                        xtype: 'textfield',
                        fieldLabel: 'Revision',
                        dataIndex: 'revision',
                        hidden: true,
                        value: BSSRevision
                    },
                    {
                        id: 'idstatustype',
                        xtype: 'combo',
                        store: bssWorkflowStatusListStore,
                        valueField:'id',
                        displayField:'value',
                        fieldLabel: 'Status Type',
                        queryMode: 'local',
                        //       selectOnTab: false,
                        name: 'statustype',
                        dataIndex: 'statustype',
                        //        value: BSSstatustypeValue,
                        submitValue : true,
                        //     hiddenName : 'id'
                        //  flex: 1,
                        forceSelection: false
                        //     disabled: true



                    },
                    {
                        id: 'idactontype',
                        hidden: BSSISACTION,
                        xtype: 'combo',
                        store: bssWorkflowActionTypeStore,
                        valueField:'id',
                        displayField:'value',
                        fieldLabel: 'Action Type',
                        queryMode: 'local',
                        selectOnTab: false,
                        name: 'actiontype',
                        dataIndex: 'ActionType'
                        //          value: BSSActionTypeValue
                    },
        //            {
        //                id: 'idnotification',
        //                hidden: BSSISNOTIFICATION,
        //                xtype: 'combo',
        //                store: bssWorkflowNotificationListStore,
        //                valueField:'id',
        //                displayField:'value',
        //                fieldLabel: 'Notification',
        //                queryMode: 'local',
        //                selectOnTab: false,
        //                name: 'notification',
        //                dataIndex: 'notification'
        //                //   value: BSSNotificationValue
        //            },
                    {
                        id: 'idactionurl',
                        hidden: false,
                        xtype: 'textfield',
                        fieldLabel: 'MSG GEN URL',
                        name: 'ActionURL',
                        dataIndex: 'ActionURL',
                        value: BSSActionURL

                    },
                    {
                        id: 'idinstructions',
                        xtype: 'textarea',
                        fieldLabel: 'Body',
                        hideLabel: false,
                        name: 'instructions',
                        dataIndex: 'instructions',
                        value: BSSInstructions,
                        style: 'margin:0', // Remove default margin
                        flex: 1  // Take up all *remaining* vertical space
                    }

                    /* ,
                     {
                     id: 'iderrorresult',
                     xtype: 'textarea',
                     fieldLabel: 'Error Result',
                     hideLabel: false,
                     name: 'errorresult',
                     dataIndex: 'errorresult',
                     value: BSSErrorResult,
                     style: 'margin:0', // Remove default margin
                     flex: 1  // Take up all *remaining* vertical space
                     },
                     {
                     id: 'idstart',
                     xtype: 'datefield',
                     fieldLabel: 'Start',
                     name: 'start',
                     dataIndex: 'start',
                     value: BSSStarted,
                     disabled: true
                     },
                     {
                     id: 'idcomplete',
                     xtype: 'datefield',
                     fieldLabel: 'Complete',
                     name: 'complete',
                     dataIndex: 'complete',
                     value: BSSCompleted,
                     disabled: true
                     }    */
                ]
            });



            var form1 = Ext.create('Ext.form.Panel', {
                id: 'idwsformh',
                plain: false,
                border: 0,
                title: 'Process Result',
                width: 290,
                bodyPadding: 5,
                url: 'BSSSaveWorkflowStep.php',

                fieldDefaults: {
                    labelWidth: 70,
                    anchor: '100%'
                },

                layout: {
                    type: 'vbox',
                    align: 'stretch'  // Child items are stretched to full width
                },


                items: [

                    {
                        id: 'idstart',
                        xtype: 'datefield',
                        fieldLabel: 'Start',
                        name: 'start',
                        dataIndex: 'start',
                        value: BSSStarted,
                        disabled: true
                    },
                    {
                        id: 'idcomplete',
                        xtype: 'datefield',
                        fieldLabel: 'Complete',
                        name: 'complete',
                        dataIndex: 'complete',
                        value: BSSCompleted,
                        disabled: true
                    },
                    {
                        id: 'iderrorresult',
                        xtype: 'textarea',
                        fieldLabel: 'Error Result',
                        hideLabel: false,
                        name: 'errorresult',
                        dataIndex: 'errorresult',
                        value: BSSErrorResult,
                        style: 'margin:0', // Remove default margin
                        flex: 1  // Take up all *remaining* vertical space
                    }
                ]
            });



            var tabs = Ext.create('Ext.tab.Panel', {
                //  renderTo: 'tabs1',
                width: 450,
                activeTab: 0,
                defaults :{
                    bodyPadding: 10
                },
                items: [form, form1, signoffs]
            });


            Ext.getCmp('idstatustype').setValue(BSSstatustype);
            Ext.getCmp('idstatustype').setRawValue(BSSstatustypeValue);

            Ext.getCmp('idactontype').setRawValue(BSSActionType);
            Ext.getCmp('idactontype').setValue(BSSActionTypeValue);

    //        Ext.getCmp('idnotification').setRawValue(BSSNotification);
     //       Ext.getCmp('idnotification').setValue(BSSNotificationValue);

            //Ext.getCmp('idstatustype').valueField = BSSstatustype;

            var win = Ext.create('Ext.window.Window', {
                title: 'Workflow Step Description',
                collapsible: true,
                animCollapse: true,
                maximizable: true,
                width: 600,
                height: 400,
                minWidth: 300,
                minHeight: 200,
                layout: 'fit',
                items: tabs, //form,


                dockedItems: [{
                    xtype: 'toolbar',
                    dock: 'bottom',
                    ui: 'footer',
                    layout: {
                        pack: 'center'
                    },
                    items: [{
                        minWidth: 80,
                        text: 'Save',

                        handler: function(){

                            //    alert(bssWorkflowStatusData[BSSstatustype - 1].value);
                            //    alert(bssWorkflowStatusData[BSSstatustype - 1].id);
                            //               alert('1');

                            var BSSNewNotification = "";
                            var idactionurlval = "";
                            var BSSNewActionType = "";

                            var idval = Ext.getCmp('idwsform').getForm().findField("id").getValue();
                            var idxlocval = Ext.getCmp('idwsform').getForm().findField("idxloc").getValue();
                            var idylocval = Ext.getCmp('idwsform').getForm().findField("idyloc").getValue();
                            var idnameval = Ext.getCmp('idwsform').getForm().findField("idname").getValue();
                            var iddescriptionval = Ext.getCmp('idwsform').getForm().findField("iddescription").getValue();
                            var idrevisionval = Ext.getCmp('idwsform').getForm().findField("idfrevision").getValue();
                            var idinstructionsval = Ext.getCmp('idwsform').getForm().findField("idinstructions").getValue();
                            alert('2');
                            //   alert(Ext.getCmp('idwsform').getForm().findField("idstatustype").getRawValue());
                            //   alert(Ext.getCmp('idwsform').getForm().findField("idstatustype").getValue());
                            //    alert(Ext.getCmp('idwsform').getForm().findField("idstatustype").toString());

                            var r = bssWorkflowStatusListStore.find('value',Ext.getCmp('idwsform').getForm().findField("idstatustype").getRawValue());
                            var BSSNewStatusType = bssWorkflowStatusListStore.getAt(r).get('id');
                            alert('3');
                            alert(BSSNewStatusType);
                            if(BSSNewStatusType == 6){
                                var r = bssWorkflowActionTypeStore.find('value',Ext.getCmp('idwsform').getForm().findField("idactontype").getRawValue());
                                BSSNewActionType = bssWorkflowActionTypeStore.getAt(r).get('id');
                                idactionurlval = Ext.getCmp('idwsform').getForm().findField("idactionurl").getValue();
                            }
                            alert('4');
                            //  alert(Ext.getCmp('idwsform').getForm().findField("idnotification").getValue());
                            if(BSSNewStatusType == 7){
                                var r = bssWorkflowNotificationListStore.find('value',Ext.getCmp('idwsform').getForm().findField("idnotification").getRawValue());


                                if(r > -1){
                                    BSSNewNotification = bssWorkflowNotificationListStore.getAt(r).get('id');
                                }else{BSSNewNotification=0}
                            }
                            //              alert('5');


                            //    function getCBSValue(cb, nameIn, nameOut){
                            //        try{
                            //            var r = cb.getStore().find(nameIn,cb.getValue());
                            //            return cb.getStore().getAt(r).get(nameOut);
                            //        }
                            //        catch(err){
                            //            return'error';
                            //        }
                            //    }

                            //    alert(bssWorkflowStatusData);
                            //    alert(bssWorkflowStatusData[BSSstatustype].id);
                            //    alert(bssWorkflowStatusData[Ext.getCmp('idwsform').getForm().findField("idstatustype").getValue()].id);
                            //    var idstatustypeval = bssWorkflowStatusData[Ext.getCmp('idwsform').getForm().findField("idstatustype").getValue()].id;
                            //    alert("in save1");                                                                                                                                                                                              //    var idactiontypeval = bssWorkflowActionTypeData[Ext.getCmp('idwsform').getForm().findField("idactontype").getValue()].id;
                            ///    alert("in save2");

                            //     var idnotificationval = Ext.getCmp('idwsform').getForm().findField("idnotification").getValue();


                            //     var idxlocval = Ext.getCmp('idwsform').getForm().findField("idxloc").getValue();
                            //     var idylocval = Ext.getCmp('idwsform').getForm().findField("idyloc").getValue();

                            // alert('in uypdate why?');
                            var updSQLString = 'UPDATE AdvWorkflowSteps SET '
                                    + ' xloc = ' + idxlocval  + ","
                                    + ' yloc = ' + idylocval  + ","
                                    + ' name = ' + "'" + idnameval  + "'" + ","
                                    + ' description = ' + "'" + iddescriptionval + "'"  + ","
                                    + ' Revision = ' + "'" + idrevisionval + "'"  + ","
                                    + ' statustype = ' + BSSNewStatusType  + ","
                                    + ' ActionType = ' + "'" + BSSNewActionType  + "',"
                                    + ' Notification = ' + "'" + BSSNewNotification  + "',"
                                    + ' ActionURL = ' + "'" + idactionurlval  + "'"  + ","
                                    + ' Instructions = ' + "'" + idinstructionsval  + "'"
                                    + ' WHERE id = ' + idval;

                            alert(updSQLString);

                            BSSUserId = "0";

                            var xmlHttp = null;
                            xmlHttp = new XMLHttpRequest();
                            xmlHttp.open( "GET", "BSSPerformSQLCommand.php?BSSSQLCommand=" + updSQLString + "&userid=" + BSSUserId, false );
                            xmlHttp.send(null);

                            //alert(xmlHttp.responseText);

                        }



                    },{
                        minWidth: 80,
                        text: 'Cancel',
                        handler: function(){alert('test');}
                    }]
                }]



            });

            win.show();

        }catch(e){alert(e.message)}


    }

function OpenURLForm(WorkflowID, Key, Category){

        var BSSWorkflowStepName;
        BSSWorkflowStepId = Key;

        try{
            xmlHttp = new XMLHttpRequest();
            xmlHttp.open( "GET", "BSSGetAdvWorkflowStepData.php?BSSWorkflowId= " + BSSWorkflowId +  "&BSSWorkflowStepId=" +  BSSWorkflowStepId, false );
            xmlHttp.send( null );
            alert("DATA: " + xmlHttp.responseText);
            var wsdata =eval('[' + xmlHttp.responseText + ']');

            var BSSID = wsdata[0].id;
            var BSSXLOC = wsdata[0].xloc;
            var BSSYLOC = wsdata[0].yloc;
            var BSSTASKEE = parseInt(wsdata[0].ApproverUserId);   // Make sure its int
            var BSSstatustype = wsdata[0].statustype;
            var BSSActionURL = wsdata[0].ActionURL;
            if(BSSstatustype==''){BSSstatustype=1;}
            //           alert(BSSstatustype);
            var BSSstatustypeValue =  bssWorkflowStatusData[BSSstatustype - 1].value;
            var BSSStarted = wsdata[0].Started;
            var BSSCompleted = wsdata[0].Completed;
            var BSSInstructions = wsdata[0].Instructions;
            var BSSErrorResult = wsdata[0].ErrorResult;
            var BSSName = wsdata[0].name;
            var BSSDescription = wsdata[0].description;
            //  masterStore.loadData(newdata,false);
        }catch(e)
        {alert("Master Data Get ERROR: " + e.message);
        }

        try{
            var form = Ext.create('Ext.form.Panel', {
                id: 'idwsform',
                plain: false,
                border: 0,
                title: 'Status Detail',
                width: 360,
                bodyPadding: 5,
                url: 'BSSSaveWorkflowStep.php',
                fieldDefaults: {
                    labelWidth: 70,
                    anchor: '100%'
                },
                layout: {
                    type: 'vbox',
                    align: 'stretch'  // Child items are stretched to full width
                },
                items: [
                    {   id: 'id',
                        xtype: 'textfield',
                        fieldLabel: 'id',
                        name: 'id',
                        dataIndex: 'id',
                        value: Key,
                        disabled: true},
                    {   id: 'idxloc',
                        xtype: 'textfield',
                        fieldLabel: 'X',
                        name: 'xloc',
                        dataIndex: 'xloc',
                        value: BSSXLOC, //  valx / 70,
                        disabled: true},
                    {   id: 'idyloc',
                        xtype: 'textfield',
                        fieldLabel: 'Y',
                        name: 'yloc',
                        dataIndex: 'yloc',
                        value: BSSYLOC,   //valy / 35,
                        disabled: true},
                    {
                        id: 'idname',
                        xtype: 'textfield',
                        fieldLabel: 'Name',
                        name: 'name',
                        dataIndex: 'name',
                        value: BSSName
                    },
                    {   id: 'iddescription',
                        xtype: 'textfield',
                        fieldLabel: 'Description',
                        name: 'description',
                        //         dataIndex: 'description',
                        value: BSSDescription},
                    {   id: 'idstatustype',
                        xtype: 'combo',
                        //  store: bssWorkflowStatusListStore,
                        valueField:'id',
                        displayField:'value',
                        fieldLabel: 'Status Type',
                        queryMode: 'local',
                        //       selectOnTab: false,
                        name: 'statustype',
                        //dataIndex: 'statustype',
                        displayValue: 'Task',
                        submitValue : true,
                        //     hiddenName : 'id'
                        //  flex: 1,
                        forceSelection: false
                        //     disabled: true
                    },
                    //           {
                    //               id: 'idactontype',
                    //               hidden: BSSISACTION,
                    //               xtype: 'combo',
                    //               store: bssWorkflowActionTypeStore,
                    // /              valueField:'id',
                    //               displayField:'value',
                    //               fieldLabel: 'Action Type',
                    //               queryMode: 'local',
                    //               selectOnTab: false,
                    //               name: 'actiontype',
                    //               dataIndex: 'ActionType'
                    //               //          value: BSSActionTypeValue
                    //           },
                    //           {
                    //               id: 'idnotification',
                    //               hidden: BSSISNOTIFICATION,
                    //               xtype: 'combo',
                    //               store: bssWorkflowNotificationListStore,
                    //               valueField:'id',
                    //              displayField:'value',
                    //             fieldLabel: 'Notification',
                    //            queryMode: 'local',
                    //           selectOnTab: false,
                    //          name: 'notification',
                    //         dataIndex: 'notification'
                    //         //   value: BSSNotificationValue
                    //     },
                              {
                                  id: 'idactionurl',
                                  hidden: false,
                                  xtype: 'textfield',
                                  fieldLabel: 'Navigate To URL',
                                  name: 'ActionURL',
                                  dataIndex: 'ActionURL',
                                  value: BSSActionURL

                              },
                    {
                        id: 'idinstructions',
                        xtype: 'textarea',
                        fieldLabel: 'Instructions',
                        hideLabel: false,
                        name: 'instructions',
                        dataIndex: 'instructions',
                        value: BSSInstructions,
                        style: 'margin:0', // Remove default margin
                        flex: 1  // Take up all *remaining* vertical space
                    },

                    {
                        id: 'idtaskassignemnt',
                        xtype: 'combo',
                        store: userliststore,
                        valueField:'id',
                        displayField:'value',
                        fieldLabel: 'Task Assignmnt',
                        queryMode: 'local',
                        //       selectOnTab: false,
                        name: 'ApproverUserId',
                        //dataIndex: BSSTASKEE, // 'ApproverUserId',
                        value: BSSTASKEE,
                        submitValue : true,
                        //     hiddenName : 'id'
                        //  flex: 1,
                        forceSelection: false
                        //     disabled: true
                    },
                    {
                        id: 'idstart',
                        xtype: 'datefield',
                        fieldLabel: 'Start',
                        name: 'start',
                        dataIndex: 'start',
                        value: BSSStarted,
                        disabled: true
                    },
                    {
                        id: 'idcomplete',
                        xtype: 'datefield',
                        fieldLabel: 'Complete',
                        name: 'complete',
                        dataIndex: 'complete',
                        value: BSSCompleted,
                        disabled: true
                    }
                ]
            });



            var tabs = Ext.create('Ext.tab.Panel', {
                //  renderTo: 'tabs1',
                width: 450,
                activeTab: 0,
                defaults :{
                    bodyPadding: 10
                },
                items: [form]
            });


            Ext.getCmp('idstatustype').setValue(BSSstatustype);
            Ext.getCmp('idstatustype').setRawValue(BSSstatustypeValue);

            //     Ext.getCmp('idactontype').setRawValue(BSSActionType);
            //     Ext.getCmp('idactontype').setValue(BSSActionTypeValue);

            //     Ext.getCmp('idnotification').setRawValue(BSSNotification);
            //     Ext.getCmp('idnotification').setValue(BSSNotificationValue);

            //Ext.getCmp('idstatustype').valueField = BSSstatustype;

            var win = Ext.create('Ext.window.Window', {
                title: 'Workflow Step Description',
                collapsible: true,
                animCollapse: true,
                maximizable: true,
                width: 600,
                height: 400,
                minWidth: 300,
                minHeight: 200,
                layout: 'fit',
                items: tabs, //form,


                dockedItems: [{
                    xtype: 'toolbar',
                    dock: 'bottom',
                    ui: 'footer',
                    layout: {
                        pack: 'center'
                    },
                    items: [{
                        minWidth: 80,
                        text: 'Save',

                        handler: function(){

                            //    alert(bssWorkflowStatusData[BSSstatustype - 1].value);
                            //    alert(bssWorkflowStatusData[BSSstatustype - 1].id);

                            var BSSNewNotification = "";
                            var idactionurlval = "";
                            var BSSNewActionType = "";

                            var idval = Ext.getCmp('idwsform').getForm().findField("id").getValue();
                            //   var idxlocval = Ext.getCmp('idwsform').getForm().findField("idxloc").getValue();
                            //   var idylocval = Ext.getCmp('idwsform').getForm().findField("idyloc").getValue();
                            var idnameval = Ext.getCmp('idwsform').getForm().findField("idname").getValue();
                            var iddescriptionval = Ext.getCmp('idwsform').getForm().findField("iddescription").getValue();
                            //          var idrevisionval = Ext.getCmp('idwsform').getForm().findField("idfrevision").getValue();
                            //       alert('1');

                            var idinstructionsval = Ext.getCmp('idwsform').getForm().findField("idinstructions").getValue();
                            var idapproveruser = Ext.getCmp('idwsform').getForm().findField("idtaskassignemnt").getValue();
                            alert(idapproveruser);
                            //   alert(Ext.getCmp('idwsform').getForm().findField("idstatustype").getRawValue());
                            //   alert(Ext.getCmp('idwsform').getForm().findField("idstatustype").getValue());
                            //    alert(Ext.getCmp('idwsform').getForm().findField("idstatustype").toString());

                            var r = bssWorkflowStatusListStore.find('value',Ext.getCmp('idwsform').getForm().findField("idstatustype").getRawValue());
                            var BSSNewStatusType = bssWorkflowStatusListStore.getAt(r).get('id');
                            //     alert('3');
                            //       alert(BSSNewStatusType);

                            //    if(BSSNewStatusType == 6){
                            //        var r = bssWorkflowActionTypeStore.find('value',Ext.getCmp('idwsform').getForm().findField("idactontype").getRawValue());
                            //        BSSNewActionType = bssWorkflowActionTypeStore.getAt(r).get('id');
                            //        idactionurlval = Ext.getCmp('idwsform').getForm().findField("idactionurl").getValue();
                            //    }
                            //    alert('4');
                            //  alert(Ext.getCmp('idwsform').getForm().findField("idnotification").getValue());
                            //     if(BSSNewStatusType == 7){
                            //         var r = bssWorkflowNotificationListStore.find('value',Ext.getCmp('idwsform').getForm().findField("idnotification").getRawValue());


                            //         if(r > -1){
                            //             BSSNewNotification = bssWorkflowNotificationListStore.getAt(r).get('id');
                            //         }else{BSSNewNotification=0}
                            //     }
                            //              alert('5');


                            //    function getCBSValue(cb, nameIn, nameOut){
                            //        try{
                            //            var r = cb.getStore().find(nameIn,cb.getValue());
                            //            return cb.getStore().getAt(r).get(nameOut);
                            //        }
                            //        catch(err){
                            //            return'error';
                            //        }
                            //    }

                            //    alert(bssWorkflowStatusData);
                            //    alert(bssWorkflowStatusData[BSSstatustype].id);
                            //    alert(bssWorkflowStatusData[Ext.getCmp('idwsform').getForm().findField("idstatustype").getValue()].id);
                            //    var idstatustypeval = bssWorkflowStatusData[Ext.getCmp('idwsform').getForm().findField("idstatustype").getValue()].id;
                            //    alert("in save1");                                                                                                                                                                                              //    var idactiontypeval = bssWorkflowActionTypeData[Ext.getCmp('idwsform').getForm().findField("idactontype").getValue()].id;
                            ///    alert("in save2");

                            //     var idnotificationval = Ext.getCmp('idwsform').getForm().findField("idnotification").getValue();


                            //     var idxlocval = Ext.getCmp('idwsform').getForm().findField("idxloc").getValue();
                            //     var idylocval = Ext.getCmp('idwsform').getForm().findField("idyloc").getValue();

                            // alert('in uypdate why?');

                            try{

                                var updSQLString = 'UPDATE AdvWorkflowSteps SET '
                                    //                             + ' xloc = ' + idxlocval  + ","
                                    //                             + ' yloc = ' + idylocval  + ","
                                        + ' name = ' + "'" + idnameval  + "'" + ","
                                        + ' description = ' + "'" + iddescriptionval + "'"  + ","
                                    //                               + ' statustype = ' + BSSNewStatusType  + ","
                                        + ' Instructions = ' + "'" + idinstructionsval  + "'"  + ","
                                        + ' ApproverUserId = ' + "'" + idapproveruser + "'"
                                        + ' WHERE stepkey = ' + idval + ' AND WorkflowId = ' + BSSWorkflowId;

                                //       alert(updSQLString);

                            }catch(e){
                                alert(e);
                            }

                            BSSUserId = "0";

                            var xmlHttp = null;
                            xmlHttp = new XMLHttpRequest();
                            xmlHttp.open( "GET", "BSSPerformSQLCommand.php?BSSSQLCommand=" + updSQLString + "&userid=" + BSSUserId, false );
                            xmlHttp.send(null);

                            alert(xmlHttp.responseText);

                        }

                    },{
                        minWidth: 80,
                        text: 'Cancel',
                        handler: function(){win.close(); win.destroy(); Ext.getCmp('idwsform').close();}
                    }]
                }]



            });

            win.show();


        }catch(e){alert(e.message)}










    }

function OpenListenerForm(WorkflowID, Key, Category){

        var BSSWorkflowStepName;
        BSSWorkflowStepId = Key;

        try{
            xmlHttp = new XMLHttpRequest();
            xmlHttp.open( "GET", "BSSGetAdvWorkflowStepData.php?BSSWorkflowId= " + BSSWorkflowId +  "&BSSWorkflowStepId=" +  BSSWorkflowStepId, false );
            xmlHttp.send( null );
            //    alert("DATA: " + xmlHttp.responseText);
            var wsdata =eval('[' + xmlHttp.responseText + ']');



            var BSSID = wsdata[0].id;
            var BSSXLOC = wsdata[0].xloc;
            var BSSYLOC = wsdata[0].yloc;
            var BSSTASKEE = parseInt(wsdata[0].ApproverUserId);   // Make sure its int
            var BSSstatustype = wsdata[0].statustype;
            if(BSSstatustype==''){BSSstatustype=1;}

            var BSSActionURL = wsdata[0].ActionURL;
            //           alert(BSSstatustype);
            var BSSstatustypeValue =  bssWorkflowStatusData[BSSstatustype - 1].value;
            var BSSStarted = wsdata[0].Started;
            var BSSCompleted = wsdata[0].Completed;
            var BSSInstructions = wsdata[0].Instructions;
            var BSSErrorResult = wsdata[0].ErrorResult;
            var BSSName = wsdata[0].name;
            var BSSDescription = wsdata[0].description;
            //  masterStore.loadData(newdata,false);
        }catch(e)
        {alert("Master Data Get ERROR: " + e.message);
        }

        try{

            var form = Ext.create('Ext.form.Panel', {
                id: 'idwsform',
                plain: false,
                border: 0,
                title: 'Status Detail',
                width: 360,
                bodyPadding: 5,
                url: 'BSSSaveWorkflowStep.php',
                fieldDefaults: {
                    labelWidth: 70,
                    anchor: '100%'
                },
                layout: {
                    type: 'vbox',
                    align: 'stretch'  // Child items are stretched to full width
                },
                items: [
                    {   id: 'id',
                        xtype: 'textfield',
                        fieldLabel: 'id',
                        name: 'id',
                        dataIndex: 'id',
                        value: Key,
                        disabled: true},
                    {   id: 'idxloc',
                        xtype: 'textfield',
                        fieldLabel: 'X',
                        name: 'xloc',
                        dataIndex: 'xloc',
                        value: BSSXLOC, //  valx / 70,
                        disabled: true},
                    {   id: 'idyloc',
                        xtype: 'textfield',
                        fieldLabel: 'Y',
                        name: 'yloc',
                        dataIndex: 'yloc',
                        value: BSSYLOC,   //valy / 35,
                        disabled: true},
                    {
                        id: 'idname',
                        xtype: 'textfield',
                        fieldLabel: 'Name',
                        name: 'name',
                        dataIndex: 'name',
                        value: BSSName
                    },
                    {   id: 'iddescription',
                        xtype: 'textfield',
                        fieldLabel: 'Description',
                        name: 'description',
                        //         dataIndex: 'description',
                        value: BSSDescription},
                    {   id: 'idstatustype',
                        xtype: 'combo',
                        //  store: bssWorkflowStatusListStore,
                        valueField:'id',
                        displayField:'value',
                        fieldLabel: 'Status Type',
                        queryMode: 'local',
                        //       selectOnTab: false,
                        name: 'statustype',
                        //dataIndex: 'statustype',
                        displayValue: 'Task',
                        submitValue : true,
                        //     hiddenName : 'id'
                        //  flex: 1,
                        forceSelection: false
                        //     disabled: true
                    },
                    //                {
                    //                    id: 'idactontype',
                    //                    xtype: 'combo',
                    //                    store: bssWorkflowActionTypeStore,
                    //                   valueField:'id',
                    //                    displayField:'value',
                    //                    fieldLabel: 'Action Type',
                    //                    queryMode: 'local',
                    //                    selectOnTab: false,
                    //                    name: 'actiontype',
                    //                    dataIndex: 'ActionType'
                    //          value: BSSActionTypeValue
                    //                },
                    //           {
                    //               id: 'idnotification',
                    //               hidden: BSSISNOTIFICATION,
                    //               xtype: 'combo',
                    //               store: bssWorkflowNotificationListStore,
                    //               valueField:'id',
                    //              displayField:'value',
                    //             fieldLabel: 'Notification',
                    //            queryMode: 'local',
                    //           selectOnTab: false,
                    //          name: 'notification',
                    //         dataIndex: 'notification'
                    //         //   value: BSSNotificationValue
                    //     },
                    {
                        id: 'idactionurl',
                        xtype: 'textfield',
                        fieldLabel: 'Listener URL',
                        name: 'ActionURL',
                        dataIndex: 'ActionURL',
                        value: BSSActionURL

                    },
                    {
                        id: 'idinstructions',
                        xtype: 'textarea',
                        fieldLabel: 'Notes',
                        hideLabel: false,
                        name: 'instructions',
                        dataIndex: 'instructions',
                        value: BSSInstructions,
                        style: 'margin:0', // Remove default margin
                        flex: 1  // Take up all *remaining* vertical space
                    }

                    //     {
                    //         id: 'idtaskassignemnt',
                    //         xtype: 'combo',
                    //         store: userliststore,
                    //         valueField:'id',
                    //         displayField:'value',
                    //         fieldLabel: 'Task Assignmnt',
                    //         queryMode: 'local',
                    //         //       selectOnTab: false,
                    //         name: 'ApproverUserId',
                    //         //dataIndex: BSSTASKEE, // 'ApproverUserId',
                    //         value: BSSTASKEE,
                    //         submitValue : true,
                    //         //     hiddenName : 'id'
                    //         //  flex: 1,
                    //         forceSelection: false
                    //         //     disabled: true
                    //     },
                    //           {
                    //              id: 'idstart',
                    //              xtype: 'datefield',
                    //              fieldLabel: 'Start',
                    //              name: 'start',
                    //              dataIndex: 'start',
                    //              value: BSSStarted,
                    //              disabled: true
                    //          },
                    //          {
                    //              id: 'idcomplete',
                    //              xtype: 'datefield',
                    //             fieldLabel: 'Complete',
                    //             name: 'complete',
                    //             dataIndex: 'complete',
                    //             value: BSSCompleted,
                    //             disabled: true
                    //         }
                ]
            });

            var formprocessresult = Ext.create('Ext.form.Panel', {
                id: 'idwsformh',
                plain: false,
                border: 0,
                title: 'Process Result',
                width: 290,
                bodyPadding: 5,
                url: 'BSSSaveWorkflowStep.php',

                fieldDefaults: {
                    labelWidth: 70,
                    anchor: '100%'
                },

                layout: {
                    type: 'vbox',
                    align: 'stretch'  // Child items are stretched to full width
                },


                items: [
                    {id: 'idstart',
                        xtype: 'datefield',
                        fieldLabel: 'Start',
                        name: 'start',
                        dataIndex: 'start',
                        value: BSSStarted,
                        disabled: true},
                    {id: 'idcomplete',
                        xtype: 'datefield',
                        fieldLabel: 'Complete',
                        name: 'complete',
                        dataIndex: 'complete',
                        value: BSSCompleted,
                        disabled: true},
                    {
                        id: 'iderrorresult',
                        xtype: 'textarea',
                        fieldLabel: 'Error Result',
                        hideLabel: false,
                        name: 'errorresult',
                        dataIndex: 'errorresult',
                        value: BSSErrorResult,
                        style: 'margin:0', // Remove default margin
                        flex: 1  // Take up all *remaining* vertical space
                    }
                ]
            });


            var tabs = Ext.create('Ext.tab.Panel', {
                //  renderTo: 'tabs1',
                width: 450,
                activeTab: 0,
                defaults :{
                    bodyPadding: 10
                },
                items: [form, formprocessresult]
            });


            Ext.getCmp('idstatustype').setValue(BSSstatustype);
            Ext.getCmp('idstatustype').setRawValue(BSSstatustypeValue);

            //     Ext.getCmp('idactontype').setRawValue(BSSActionType);
            //     Ext.getCmp('idactontype').setValue(BSSActionTypeValue);

            //     Ext.getCmp('idnotification').setRawValue(BSSNotification);
            //     Ext.getCmp('idnotification').setValue(BSSNotificationValue);

            //Ext.getCmp('idstatustype').valueField = BSSstatustype;

            var win = Ext.create('Ext.window.Window', {
                title: 'Workflow Step Description',
                collapsible: true,
                animCollapse: true,
                maximizable: true,
                width: 600,
                height: 400,
                minWidth: 300,
                minHeight: 200,
                layout: 'fit',
                items: tabs, //form,


                dockedItems: [{
                    xtype: 'toolbar',
                    dock: 'bottom',
                    ui: 'footer',
                    layout: {
                        pack: 'center'
                    },
                    items: [{
                        minWidth: 80,
                        text: 'Save',

                        handler: function(){

                            //    alert(bssWorkflowStatusData[BSSstatustype - 1].value);
                            //    alert(bssWorkflowStatusData[BSSstatustype - 1].id);

                            var BSSNewNotification = "";
                            var idactionurlval = "";
                            var BSSNewActionType = "";

                            var idval = Ext.getCmp('idwsform').getForm().findField("id").getValue();
                            //   var idxlocval = Ext.getCmp('idwsform').getForm().findField("idxloc").getValue();
                            //   var idylocval = Ext.getCmp('idwsform').getForm().findField("idyloc").getValue();
                            var idnameval = Ext.getCmp('idwsform').getForm().findField("idname").getValue();
                            var iddescriptionval = Ext.getCmp('idwsform').getForm().findField("iddescription").getValue();
                            //          var idrevisionval = Ext.getCmp('idwsform').getForm().findField("idfrevision").getValue();
                            //       alert('1');

                            var idinstructionsval = Ext.getCmp('idwsform').getForm().findField("idinstructions").getValue();
                            var idapproveruser = Ext.getCmp('idwsform').getForm().findField("idtaskassignemnt").getValue();
                            alert(idapproveruser);
                            //   alert(Ext.getCmp('idwsform').getForm().findField("idstatustype").getRawValue());
                            //   alert(Ext.getCmp('idwsform').getForm().findField("idstatustype").getValue());
                            //    alert(Ext.getCmp('idwsform').getForm().findField("idstatustype").toString());

                            var r = bssWorkflowStatusListStore.find('value',Ext.getCmp('idwsform').getForm().findField("idstatustype").getRawValue());
                            var BSSNewStatusType = bssWorkflowStatusListStore.getAt(r).get('id');
                            //     alert('3');
                            //       alert(BSSNewStatusType);

                            //    if(BSSNewStatusType == 6){
                            //        var r = bssWorkflowActionTypeStore.find('value',Ext.getCmp('idwsform').getForm().findField("idactontype").getRawValue());
                            //        BSSNewActionType = bssWorkflowActionTypeStore.getAt(r).get('id');
                            //        idactionurlval = Ext.getCmp('idwsform').getForm().findField("idactionurl").getValue();
                            //    }
                            //    alert('4');
                            //  alert(Ext.getCmp('idwsform').getForm().findField("idnotification").getValue());
                            //     if(BSSNewStatusType == 7){
                            //         var r = bssWorkflowNotificationListStore.find('value',Ext.getCmp('idwsform').getForm().findField("idnotification").getRawValue());


                            //         if(r > -1){
                            //             BSSNewNotification = bssWorkflowNotificationListStore.getAt(r).get('id');
                            //         }else{BSSNewNotification=0}
                            //     }
                            //              alert('5');


                            //    function getCBSValue(cb, nameIn, nameOut){
                            //        try{
                            //            var r = cb.getStore().find(nameIn,cb.getValue());
                            //            return cb.getStore().getAt(r).get(nameOut);
                            //        }
                            //        catch(err){
                            //            return'error';
                            //        }
                            //    }

                            //    alert(bssWorkflowStatusData);
                            //    alert(bssWorkflowStatusData[BSSstatustype].id);
                            //    alert(bssWorkflowStatusData[Ext.getCmp('idwsform').getForm().findField("idstatustype").getValue()].id);
                            //    var idstatustypeval = bssWorkflowStatusData[Ext.getCmp('idwsform').getForm().findField("idstatustype").getValue()].id;
                            //    alert("in save1");                                                                                                                                                                                              //    var idactiontypeval = bssWorkflowActionTypeData[Ext.getCmp('idwsform').getForm().findField("idactontype").getValue()].id;
                            ///    alert("in save2");

                            //     var idnotificationval = Ext.getCmp('idwsform').getForm().findField("idnotification").getValue();


                            //     var idxlocval = Ext.getCmp('idwsform').getForm().findField("idxloc").getValue();
                            //     var idylocval = Ext.getCmp('idwsform').getForm().findField("idyloc").getValue();

                            // alert('in uypdate why?');

                            try{

                                var updSQLString = 'UPDATE AdvWorkflowSteps SET '
                                    //                             + ' xloc = ' + idxlocval  + ","
                                    //                             + ' yloc = ' + idylocval  + ","
                                        + ' name = ' + "'" + idnameval  + "'" + ","
                                        + ' description = ' + "'" + iddescriptionval + "'"  + ","
                                    //                               + ' statustype = ' + BSSNewStatusType  + ","
                                        + ' Instructions = ' + "'" + idinstructionsval  + "'"  + ","
                                        + ' ApproverUserId = ' + "'" + idapproveruser + "'"
                                        + ' WHERE stepkey = ' + idval + ' AND WorkflowId = ' + BSSWorkflowId;

                                //       alert(updSQLString);

                            }catch(e){
                                alert(e);
                            }

                            BSSUserId = "0";

                            var xmlHttp = null;
                            xmlHttp = new XMLHttpRequest();
                            xmlHttp.open( "GET", "BSSPerformSQLCommand.php?BSSSQLCommand=" + updSQLString + "&userid=" + BSSUserId, false );
                            xmlHttp.send(null);

                            alert(xmlHttp.responseText);

                        }

                    },{
                        minWidth: 80,
                        text: 'Cancel',
                        handler: function(){win.close(); win.destroy(); Ext.getCmp('idwsform').close();}
                    }]
                }]



            });

            win.show();


        }catch(e){alert(e.message)}










    }

function OpenReviewForm(WorkflowID, Key, Category){


        var BSSWorkflowStepName;
        BSSWorkflowStepId = Key;

                try{
                    //Get the data
                    xmlHttp = new XMLHttpRequest();
                    xmlHttp.open( "GET", "BSSGetAdvWorkflowStepData.php?BSSWorkflowId= " + BSSWorkflowId +  "&BSSWorkflowStepId=" +  BSSWorkflowStepId, false );

                //    xmlHttp.open( "GET", "BSSGetAdvWorkflowStepData.php?BSSWorkflowStepId=" +  BSSWorkflowStepId, false );
                    xmlHttp.send( null );
                    alert("DATA: " + xmlHttp.responseText);
                    var wsdata =eval('[' + xmlHttp.responseText + ']');

                    //  var wsdata = JSON.parse(xmlHttp.responseText);


                    /*

                     alert(wsdata[0].id);
                     alert(wsdata[1].ActionURL);
                     alert(wsdata[2].xloc);
                     alert(wsdata[3].yloc);
                     alert(wsdata[4].ActionType);
                     alert(wsdata[5].statustype);
                     alert(wsdata[6].Notification);
                     alert(wsdata[7].Revision);
                     alert(wsdata[8].Started);
                     alert(wsdata[9].Completed);
                     alert(wsdata[10].Instructions);
                     alert(wsdata[11].ErrorResult);
                     alert(wsdata[12].name);
                     alert(wsdata[13].description);



                     {id:1, value: 'Pending'},
                     {id:2, value: 'Submit'},
                     {id:3, value: 'Review'},
                     {id:4, value: 'Release'},
                     {id:5, value: 'Complete'},
                     {id:6, value: 'Notify'},
                     {id:7, value: 'Action'}
                     */

                    var BSSISACTION = true;
                    var BSSISNOTIFICATION = true;

                    if(Category == 'ACTION')
                    {
                        BSSISACTION = false;
                    }

                    if(Category == 'NOTIFY')
                    {
                        BSSISNOTIFICATION = false;
                    }

                    var BSSID = wsdata[0].id;
                    var BSSXLOC = wsdata[0].xloc;
                    var BSSYLOC = wsdata[0].yloc;

                    if(BSSISACTION == false){
                        var BSSActionURL = wsdata[0].ActionURL;
                        var BSSActionType = wsdata[0].ActionType;
                        if(BSSActionType==''){BSSActionType=1;}
                        var BSSActionTypeValue = bssWorkflowActionTypeData[BSSActionType - 1].value;
                    }

                    var BSSstatustype = wsdata[0].statustype;
                    if(BSSstatustype==''){BSSstatustype=1;}
                    //           alert(BSSstatustype);
                    var BSSstatustypeValue =  bssWorkflowStatusData[BSSstatustype - 1].value;


                    if(BSSISNOTIFICATION == false){
                        var BSSNotification = wsdata[0].Notification;
                        var BSSNotificationValue = "";
                        var r = bssWorkflowNotificationListStore.find('id',BSSNotification);   // find the index of the id in the array
                        // alert(r);
                        if(BSSNotification != ''){
                            BSSNotificationValue = bssWorkflowNotificationListStore.getAt(r).get('value');  // get the value
                        }
                    }

                    var BSSRevision = wsdata[0].Revision;
                    var BSSStarted = wsdata[0].Started;
                    var BSSCompleted = wsdata[0].Completed;
                    var BSSInstructions = wsdata[0].Instructions;
                    var BSSErrorResult = wsdata[0].ErrorResult;
                    var BSSName = wsdata[0].name;
                    var BSSDescription = wsdata[0].description;


                    //  masterStore.loadData(newdata,false);
                }catch(e)
                {alert("Master Data Get ERROR: " + e.message);
                }

                var BSSHideApprovalTab = true;


  //      alert("Review Category is " + Category);

                if(Category == 'REVIEW'){
                    BSSHideApprovalTab = false;
                }

                try{

                    var signoffs = Ext.create('Ext.grid.Panel', {
                    //    id: 'signoffgrid',
                        hidden: BSSHideApprovalTab,
                        store: signoffsStore,
                        //    listeners: {itemclick: function() {alert('SSS');}},
                        listeners: {activate: function() {GetSignOffs();}},
                        selModel: 'cellmodel',
                        columns: [
                            { //id: 'idsignoff',
                                header: 'Id',
                                disabled: true,
                                listeners: {
                                    beforeedit: function(){
                                        return false;
                                    }},
                                width: 10,
                                dataIndex: 'id',
                                editor: {
                                    allowBlank: false
                                }
                            },
                            {//id: 'masteridsignoff',
                                header: 'Id',
                                disabled: true,
                                listeners: {
                                    beforeedit: function(){
                                        return false;
                                    }},
                                width: 10,
                                dataIndex: 'masterid',
                                editor: {
                                    allowBlank: false
                                }
                            },{//id: 'sequenceasignoff',
                                header: 'Id',
                                disabled: true,
                                listeners: {
                                    beforeedit: function(){
                                        return false;
                                    }},
                                width: 10,
                                dataIndex: 'sequence',
                                editor: {
                                    allowBlank: false
                                }
                            },
                            {//id: 'idWorkflowApprover',
                                header: 'Workflow Approver',
                                disabled: false,
                                width: 180,
                                dataIndex: 'WorkflowApprover',
                                editor:
                                { xtype: 'combobox',
                                    typeAhead: true,
                                    selectOnTab: true,
                                    triggerAction: 'all',
                                    fields:['id','value'],
                                    store: userliststore, //[[1, 'GLOBAL'],[2, 'USER']],
                                    valueField:'id',
                                    displayField:'value',
                                    multiSelect: false,
                                    queryMode: 'local',
                                    lazyRender: true,
                                    listClass: 'x-combo-list-small'},
                                renderer: function(val) {var matching =  userliststore.queryBy( function(rec){ return rec.data.id == val; }); return (matching.items[0]) ? matching.items[0].data.value : ''}
                            },

                            {//id: 'idSignoffDate',
                                header: 'Signoff Date',
                                disabled: false,
                                width: 100,
                                dataIndex: 'SignoffDate',
                                editor: {
                                    allowBlank: false
                                }
                            },

                            {//id: 'idSignoffResult',
                                header: 'Signoff Result',
                                disabled: false,
                                width: 100,
                                dataIndex: 'SignoffResult',
                                editor:
                                { xtype: 'combobox',
                                    typeAhead: true,
                                    selectOnTab: true,
                                    triggerAction: 'all',
                                    fields:['id','value'],
                                    store: workflowapprovalstatusliststore, //[[1, 'GLOBAL'],[2, 'USER']],
                                    valueField:'id',
                                    displayField:'value',
                                    multiSelect: false,
                                    queryMode: 'local',
                                    lazyRender: true,
                                    listClass: 'x-combo-list-small'},
                                renderer: function(val) {var matching =  workflowapprovalstatusliststore.queryBy( function(rec){ return rec.data.id == val; }); return (matching.items[0]) ? matching.items[0].data.value : ''}


                            },
                            {//id: 'idComments',
                                header: 'Comments',
                                disabled: false,
                                width: 100,
                                dataIndex: 'Comments',
                                editor: {
                                    allowBlank: false
                                }
                            }],
                        width: 350,
                        height: 200,
                        x: 2,
                        y: 2,
                        title: 'Approval Status',
                        frame: true,
                        tbar: [{text: 'Approve', disabled: BSSSIGNOFF_FLAG, handler : function() {ApproveWorkflow("Workflows");}},
                            {text: 'Reject', disabled: BSSSIGNOFF_FLAG, handler : function() {RejectWorkflow("Workflows");}},
                            {text: 'Add Approver', disabled: BSSADDREMOVEAPPROVERS, handler : function() {AddApprovers();}},
                            {text: 'Remove Approver',disabled: BSSADDREMOVEAPPROVERS, handler : function() {removeApprovers();}}


                        ],
                        plugins: [cellEditing6]
                    });




                    //     alert(BSSISACTION);

                    //       alert(BSSISNOTIFICATION);

                    var form = Ext.create('Ext.form.Panel', {
                      //  id: 'idwsform',
                        plain: false,
                        border: 0,
                        title: 'Status Detail',
                        width: 360,
                        bodyPadding: 5,
                        url: 'BSSSaveWorkflowStep.php',

                        fieldDefaults: {
                            labelWidth: 70,
                            anchor: '100%'
                        },

                        layout: {
                            type: 'vbox',
                            align: 'stretch'  // Child items are stretched to full width
                        },


                        items: [
                            {
                               // id: 'id',
                                xtype: 'textfield',
                                fieldLabel: 'id',
                                name: 'id',
                                dataIndex: 'id',
                                value: Key,
                                disabled: true
                            },
                            {
                              //  id: 'idxloc',
                                xtype: 'textfield',
                                fieldLabel: 'X',
                                name: 'xloc',
                                dataIndex: 'xloc',
                                value: BSSXLOC, //  valx / 70,
                                disabled: true
                            },
                            {
                               // id: 'idyloc',
                                xtype: 'textfield',
                                fieldLabel: 'Y',
                                name: 'yloc',
                                dataIndex: 'yloc',
                                value: BSSYLOC,   //valy / 35,
                                disabled: true
                            },
                            {
                              //  id: 'idname',
                                xtype: 'textfield',
                                fieldLabel: 'Name',
                                name: 'name',
                                dataIndex: 'name',
                                value: BSSName
                            },
                            {
                             //   id: 'iddescription',
                                xtype: 'textfield',
                                fieldLabel: 'Description',
                                name: 'description',
                                //         dataIndex: 'description',
                                value: BSSDescription
                            },
                            {
                             //   id: 'idfrevision',
                                name: 'txtrevision',
                                xtype: 'textfield',
                                fieldLabel: 'Revision',
                                dataIndex: 'revision',
                                hidden: true,
                                value: BSSRevision
                            },
                            {
                                id: 'idstatustype',
                                xtype: 'combo',
                                store: bssWorkflowStatusListStore,
                                valueField:'id',
                                displayField:'value',
                                fieldLabel: 'Status Type',
                                queryMode: 'local',
                                //       selectOnTab: false,
                                name: 'statustype',
                                dataIndex: 'statustype',
                                //        value: BSSstatustypeValue,
                                submitValue : true,
                                //     hiddenName : 'id'
                                //  flex: 1,
                                forceSelection: false
                                //     disabled: true



                            },
                            {
                                id: 'idactontype',
                                hidden: BSSISACTION,
                                xtype: 'combo',
                                store: bssWorkflowActionTypeStore,
                                valueField:'id',
                                displayField:'value',
                                fieldLabel: 'Action Type',
                                queryMode: 'local',
                                selectOnTab: false,
                                name: 'actiontype',
                                dataIndex: 'ActionType'
                                //          value: BSSActionTypeValue
                            },
                            {
                                id: 'idnotification',
                                hidden: BSSISNOTIFICATION,
                                xtype: 'combo',
                                store: bssWorkflowNotificationListStore,
                                valueField:'id',
                                displayField:'value',
                                fieldLabel: 'Notification',
                                queryMode: 'local',
                                selectOnTab: false,
                                name: 'notification',
                                dataIndex: 'notification'
                                //   value: BSSNotificationValue
                            },
                            {
                            //    id: 'idactionurl',
                                hidden: BSSISACTION,
                                xtype: 'textfield',
                                fieldLabel: 'Action URL',
                                name: 'ActionURL',
                                dataIndex: 'ActionURL',
                                value: BSSActionURL

                            },
                            {
                             //   id: 'idinstructions',
                                xtype: 'textarea',
                                fieldLabel: 'Instructions',
                                hideLabel: false,
                                name: 'instructions',
                                dataIndex: 'instructions',
                                value: BSSInstructions,
                                style: 'margin:0', // Remove default margin
                                flex: 1  // Take up all *remaining* vertical space
                            }

                            /* ,
                             {
                             id: 'iderrorresult',
                             xtype: 'textarea',
                             fieldLabel: 'Error Result',
                             hideLabel: false,
                             name: 'errorresult',
                             dataIndex: 'errorresult',
                             value: BSSErrorResult,
                             style: 'margin:0', // Remove default margin
                             flex: 1  // Take up all *remaining* vertical space
                             },
                             {
                             id: 'idstart',
                             xtype: 'datefield',
                             fieldLabel: 'Start',
                             name: 'start',
                             dataIndex: 'start',
                             value: BSSStarted,
                             disabled: true
                             },
                             {
                             id: 'idcomplete',
                             xtype: 'datefield',
                             fieldLabel: 'Complete',
                             name: 'complete',
                             dataIndex: 'complete',
                             value: BSSCompleted,
                             disabled: true
                             }    */
                        ]
                    });



                    var form1 = Ext.create('Ext.form.Panel', {
                        id: 'idwsformh',
                        plain: false,
                        border: 0,
                        title: 'Process Result',
                        width: 290,
                        bodyPadding: 5,
                        url: 'BSSSaveWorkflowStep.php',

                        fieldDefaults: {
                            labelWidth: 70,
                            anchor: '100%'
                        },

                        layout: {
                            type: 'vbox',
                            align: 'stretch'  // Child items are stretched to full width
                        },


                        items: [

                            {
                            //    id: 'idstart',
                                xtype: 'datefield',
                                fieldLabel: 'Start',
                                name: 'start',
                                dataIndex: 'start',
                                value: BSSStarted,
                                disabled: true
                            },
                            {
                            //    id: 'idcomplete',
                                xtype: 'datefield',
                                fieldLabel: 'Complete',
                                name: 'complete',
                                dataIndex: 'complete',
                                value: BSSCompleted,
                                disabled: true
                            },
                            {
                            //    id: 'iderrorresult',
                                xtype: 'textarea',
                                fieldLabel: 'Error Result',
                                hideLabel: false,
                                name: 'errorresult',
                                dataIndex: 'errorresult',
                                value: BSSErrorResult,
                                style: 'margin:0', // Remove default margin
                                flex: 1  // Take up all *remaining* vertical space
                            }
                        ]
                    });






                    var tabs = Ext.create('Ext.tab.Panel', {
                        //  renderTo: 'tabs1',
                        width: 450,
                        activeTab: 0,
                        defaults :{
                            bodyPadding: 10
                        },
                        items: [form, form1, signoffs]
                    });


                    Ext.getCmp('idstatustype').setValue(BSSstatustype);
                    Ext.getCmp('idstatustype').setRawValue(BSSstatustypeValue);

                    Ext.getCmp('idactontype').setRawValue(BSSActionType);
                    Ext.getCmp('idactontype').setValue(BSSActionTypeValue);

                    Ext.getCmp('idnotification').setRawValue(BSSNotification);
                    Ext.getCmp('idnotification').setValue(BSSNotificationValue);

                    //Ext.getCmp('idstatustype').valueField = BSSstatustype;

                    var win = Ext.create('Ext.window.Window', {
                        title: 'Workflow Step Description',
                        collapsible: true,
                        animCollapse: true,
                        maximizable: true,
                        width: 600,
                        height: 400,
                        minWidth: 300,
                        minHeight: 200,
                        layout: 'fit',
                        items: tabs, //form,


                        dockedItems: [{
                            xtype: 'toolbar',
                            dock: 'bottom',
                            ui: 'footer',
                            layout: {
                                pack: 'center'
                            },
                            items: [{
                                minWidth: 80,
                                text: 'Save',

                                handler: function(){

                                    //    alert(bssWorkflowStatusData[BSSstatustype - 1].value);
                                    //    alert(bssWorkflowStatusData[BSSstatustype - 1].id);
                     //               alert('1');

                                    var BSSNewNotification = "";
                                    var idactionurlval = "";
                                    var BSSNewActionType = "";

                                    var idval = Ext.getCmp('idwsform').getForm().findField("id").getValue();
                                    var idxlocval = Ext.getCmp('idwsform').getForm().findField("idxloc").getValue();
                                    var idylocval = Ext.getCmp('idwsform').getForm().findField("idyloc").getValue();
                                    var idnameval = Ext.getCmp('idwsform').getForm().findField("idname").getValue();
                                    var iddescriptionval = Ext.getCmp('idwsform').getForm().findField("iddescription").getValue();
                                    var idrevisionval = Ext.getCmp('idwsform').getForm().findField("idfrevision").getValue();
                                    var idinstructionsval = Ext.getCmp('idwsform').getForm().findField("idinstructions").getValue();
                                    alert('2');
                                    //   alert(Ext.getCmp('idwsform').getForm().findField("idstatustype").getRawValue());
                                    //   alert(Ext.getCmp('idwsform').getForm().findField("idstatustype").getValue());
                                    //    alert(Ext.getCmp('idwsform').getForm().findField("idstatustype").toString());

                                    var r = bssWorkflowStatusListStore.find('value',Ext.getCmp('idwsform').getForm().findField("idstatustype").getRawValue());
                                    var BSSNewStatusType = bssWorkflowStatusListStore.getAt(r).get('id');
                                    alert('3');
                                    alert(BSSNewStatusType);
                                    if(BSSNewStatusType == 6){
                                        var r = bssWorkflowActionTypeStore.find('value',Ext.getCmp('idwsform').getForm().findField("idactontype").getRawValue());
                                        BSSNewActionType = bssWorkflowActionTypeStore.getAt(r).get('id');
                                        idactionurlval = Ext.getCmp('idwsform').getForm().findField("idactionurl").getValue();
                                    }
                                    alert('4');
                                    //  alert(Ext.getCmp('idwsform').getForm().findField("idnotification").getValue());
                                    if(BSSNewStatusType == 7){
                                        var r = bssWorkflowNotificationListStore.find('value',Ext.getCmp('idwsform').getForm().findField("idnotification").getRawValue());


                                        if(r > -1){
                                            BSSNewNotification = bssWorkflowNotificationListStore.getAt(r).get('id');
                                        }else{BSSNewNotification=0}
                                    }
                      //              alert('5');


                                    //    function getCBSValue(cb, nameIn, nameOut){
                                    //        try{
                                    //            var r = cb.getStore().find(nameIn,cb.getValue());
                                    //            return cb.getStore().getAt(r).get(nameOut);
                                    //        }
                                    //        catch(err){
                                    //            return'error';
                                    //        }
                                    //    }

                                    //    alert(bssWorkflowStatusData);
                                    //    alert(bssWorkflowStatusData[BSSstatustype].id);
                                    //    alert(bssWorkflowStatusData[Ext.getCmp('idwsform').getForm().findField("idstatustype").getValue()].id);
                                    //    var idstatustypeval = bssWorkflowStatusData[Ext.getCmp('idwsform').getForm().findField("idstatustype").getValue()].id;
                                    //    alert("in save1");                                                                                                                                                                                              //    var idactiontypeval = bssWorkflowActionTypeData[Ext.getCmp('idwsform').getForm().findField("idactontype").getValue()].id;
                                    ///    alert("in save2");

                                    //     var idnotificationval = Ext.getCmp('idwsform').getForm().findField("idnotification").getValue();


                                    //     var idxlocval = Ext.getCmp('idwsform').getForm().findField("idxloc").getValue();
                                    //     var idylocval = Ext.getCmp('idwsform').getForm().findField("idyloc").getValue();

                                    // alert('in uypdate why?');
                                    var updSQLString = 'UPDATE AdvWorkflowSteps SET '
                                            + ' xloc = ' + idxlocval  + ","
                                            + ' yloc = ' + idylocval  + ","
                                            + ' name = ' + "'" + idnameval  + "'" + ","
                                            + ' description = ' + "'" + iddescriptionval + "'"  + ","
                                            + ' Revision = ' + "'" + idrevisionval + "'"  + ","
                                            + ' statustype = ' + BSSNewStatusType  + ","
                                            + ' ActionType = ' + "'" + BSSNewActionType  + "',"
                                            + ' Notification = ' + "'" + BSSNewNotification  + "',"
                                            + ' ActionURL = ' + "'" + idactionurlval  + "'"  + ","
                                            + ' Instructions = ' + "'" + idinstructionsval  + "'"
                                            + ' WHERE id = ' + idval;

                                    alert(updSQLString);

                                    BSSUserId = "0";

                                    var xmlHttp = null;
                                    xmlHttp = new XMLHttpRequest();
                                    xmlHttp.open( "GET", "BSSPerformSQLCommand.php?BSSSQLCommand=" + updSQLString + "&userid=" + BSSUserId, false );
                                    xmlHttp.send(null);

                                    //alert(xmlHttp.responseText);

                                }



                            },{
                                minWidth: 80,
                                text: 'Cancel',
                                handler: function(){alert('test');}
                            }]
                        }]



                    });

                    win.show();

                }catch(e){alert(e.message)}














}


// Define a function for creating a "port" that is normally transparent.
// The "name" is used as the GraphObject.portId, the "spot" is used to control how links connect
// and where the port is positioned on the node, and the boolean "output" and "input" arguments
// control whether the user can draw links from or to the port.
function makePort(name, spot, output, input) {
    // the port is basically just a small circle that has a white stroke when it is made visible
    return go.GraphObject.make(go.Shape,
            {
                figure: "Circle",
                fill: "transparent",
                stroke: null,  // this is changed to "white" in the showPorts function
                desiredSize: new go.Size(6, 6),
                alignment: spot, alignmentFocus: spot,  // align the port on the main Shape
                portId: name,  // declare this object to be a "port"
                fromSpot: spot, toSpot: spot,  // declare where links may connect at this port
                fromLinkable: output, toLinkable: input,  // declare whether the user may draw links to/from here
                cursor: "pointer"  // show a different cursor to indicate potential link point
            });
}

// Make all ports on a node visible when the mouse is over the node
function showPorts(node, show) {
    var diagram = node.diagram;
    if (!diagram || diagram.isReadOnly || !diagram.allowLink) return;
    var it = node.ports;
    while (it.next()) {
        var port = it.value;
        port.stroke = (show ? "white" : null);
    }
}

// Show the diagram's model in JSON format that the user may have edited
function save() {
    var str = myDiagram.model.toJson();

    var xmlHttp = null;
    xmlHttp = new XMLHttpRequest();
    xmlHttp.open( "GET", "BSSSaveWorkflowGOJSData.php?$BSSWorkflowModel=" + str, false );
    xmlHttp.send(null);

    alert(xmlHttp.responseText);

   // document.getElementById("mySavedModel").value = str;
}
function load() {

   alert('load');

    var xmlHttp = null;
    xmlHttp = new XMLHttpRequest();
    xmlHttp.open( "GET", "BSSGetWorkflowGOJSData.php", false ); //?BSSWorkflowStepId=" + xstepbox.getAttrs().id + "&name=" + StatusType  + "$statustype=" + StatusType + "&xloc=" + curx + "&yloc=" + cury, false );
    xmlHttp.send(null);


    str =  xmlHttp.responseText;

    myDiagram.model = go.Model.fromJson(str);
    myDiagram.undoManager.isEnabled = true;
}


function GetWorkFlowList(){


        var childgrid;
        var notificationgrid;
        var actiongrid;
        var BSSCREATEMASTER_FLAG = false
        var BSSREADMASTER_FLAG = false
        var BSSUPDATEMASTER_FLAG = false
        var BSSDELETEMASTER_FLAG = false
        var BSSCREATECHILD_FLAG = false
        var BSSREADCHILD_FLAG = false
        var BSSUPDATECHILD_FLAG = false
        var BSSDELETECHILD_FLAG = false

        var BSSChildConfigName = "WorkflowApprovers";
        var BSSWorkflowNotificationConfigName = "WorkflowNotifications";
        var BSSWorkflowActionConfigName = "WorkflowActions";
        var bssNewFieldNameData;
        var bssNewFlowManagerData;

        bssFieldNameData = [ { id:1, value: 'AGLOBAL'},{ id:2, value: 'AUSER'}];
        bssNewFlowManagerData = [ { id:1, value: 'AG'},{ id:2, value: 'AU'}];


        fieldStore = Ext.create('Ext.data.Store', {
                    fields: [{name: 'id'}, {name: 'value'} ],
                    data: bssFieldNameData
                }
        );



        var cellEditing = Ext.create('Ext.grid.plugin.CellEditing', {
            clicksToEdit: 1
        });


        // create the data store
        var workflowstore = Ext.create('Ext.data.Store', {
            fields: [
                {name: 'id', type: 'string'},
                {name: 'sequence', type: 'string'},
                {name: 'masterid', type: 'string'},
                {name: 'WorkflowName', type: 'string'},
                {name: 'Workflowdescription', type: 'string'}
                //    {name: 'WorkflowAvailableFor', type: 'string'}
            ],
            data:
                    [['1','','','','','','','','','','']]
        });


    usermanagerStore = Ext.create('Ext.data.Store', {
                fields: [{name: 'id'}, {name: 'value'} ],
                data: bssNewFlowManagerData
            }
    );
        usermanagerStore = Ext.create('Ext.data.Store', {
                    fields: [{name: 'id'}, {name: 'value'} ],
                    data: bssNewFlowManagerData
                }
        );

        //Get the data
        xmlHttp = new XMLHttpRequest();
        xmlHttp.open( "GET", "BSSGetComboStore.php?BSSSQLString=SELECT id, QueryName AS value FROM Queries", false );
        xmlHttp.send( null );
        //      alert("DATA: " + xmlHttp.responseText);
        var bssNewFieldNameData = eval('[' + xmlHttp.responseText + ']');
        fieldStore.loadData(bssNewFieldNameData,false);

        //Get the data
        xmlHttp = new XMLHttpRequest();
        xmlHttp.open( "GET", "BSSGetComboStore.php?BSSSQLString=SELECT id, Email AS value FROM users", false );
        xmlHttp.send( null );
        //        alert("DATA: " + xmlHttp.responseText);
        var bssNewFlowManagerData = eval('[' + xmlHttp.responseText + ']');
        usermanagerStore.loadData(bssNewFlowManagerData,false);


        try{
            //Get the data
            xmlHttp = new XMLHttpRequest();
            xmlHttp.open( "GET", "BSSGetJSData.php?BSSConfigName=" + "AdvWorkflows" + "&BSSWhereClause=" + "id>0 ORDER BY sequence,id", false );
            xmlHttp.send( null );
            //           alert("DATA: " + xmlHttp.responseText);
            var newdata = eval('[' + xmlHttp.responseText + ']');
            workflowstore.loadData(newdata,false);
        }catch(e)
        {document.write("<p>" + "ERROR: " + e.message + "</p>");
        }


        workflowgrid = Ext.create('Ext.grid.Panel', {
            store: workflowstore,
            selModel: 'cellmodel',
            listeners: {
                itemclick: function() {
                    // ProcessChildTab();
                }},
            columns: [
                {id: 'id1',
                    header: 'Id',
                    disabled: true,
                    listeners: {
                        beforeedit: function(){
                            return false;
                        }},
                    width: 40,
                    dataIndex: 'id',
                    editor: {
                        allowBlank: false
                    }
                },
                {id: 'sequence1',
                    header: 'Sequence',
                    disabled: false,
                    width: 0,
                    dataIndex: 'sequence',
                    editor: {
                        allowBlank: false
                    }
                },
                {id: 'masterid1',
                    header: 'Master Id',
                    disabled: false,
                    width: 0,
                    dataIndex: 'masterid',
                    editor: {
                        allowBlank: false
                    }

                },
                {id: 'WorkflowName',
                    header: 'Workflow Name',
                    width: 150,
                    editable: false,
                    dataIndex: 'WorkflowName',
                    editor: {
                        allowBlank: true
                    }
                },
                {
                    id: 'Workflowdescription',
                    header: 'Workflow Description',
                    width: 300,
                    dataIndex: 'Workflowdescription',
                    editor: {
                        allowBlank: false
                    }
                }

                /*,
                 { header:'Workflow Available For Query', dataIndex:'WorkflowAvailableFor', width: 200,
                 editor:
                 { xtype: 'combobox',
                 typeAhead: true,
                 selectOnTab: true,
                 triggerAction: 'all',
                 fields:['id','value'],
                 store: fieldStore, //[[1, 'GLOBAL'],[2, 'USER']],
                 valueField:'id',
                 displayField:'value',
                 multiSelect: false,
                 queryMode: 'local',
                 lazyRender: true,
                 listClass: 'x-combo-list-small'},
                 renderer: function(val) {var matching =  fieldStore.queryBy( function(rec){ return rec.data.id == val; }); return (matching.items[0]) ? matching.items[0].data.value : ''}

                 //       renderer: function(val) { var CodesStore = Ext.create('Ext.data.Store', { fields: [ {name: 'id'}, {name: 'value'} ], data: bssFieldNameData }); var matching = CodesStore.queryBy( function(rec){ return rec.data.id == val; }); return (matching.items[0]) ? matching.items[0].data.value : ''} },


                 } */
            ],
            width: 520,
            height: 350,
            x: 0,
            y: 0,
            //     title: 'Workflows',
            frame: true,
            tbar: [{text: 'Add',    handler : function() {processInsert("AdvWorkflows",workflowgrid,workflowstore);}},
                {text: 'Save',   handler : function() {processUpdate("AdvWorkflows",workflowgrid,workflowstore);}},
                {text: 'Delete', handler : function() {processDelete("AdvWorkflows",workflowgrid,workflowstore);}},
                {text: 'Get Workflow Steps', handler : function() {GetWorkflowSteps("AdvWorkflows",workflowgrid,workflowstore);}}
            ]
            , plugins: [cellEditing]
        });

        absolute1 = Ext.create('Ext.window.Window', {
            title: 'Workflow Maintenance',
            x:50,
            y:50,
            width: 550,
            height: 450,
            //        layout:'absolute',
            defaults: {
                bodyStyle: 'padding:10px'
            },
            items: [workflowgrid]
        });

        absolute1.show();


    }

function processInsert(BSSConfigName, BSSGrid, BSSStore)
{
        //  Get default data from config array

        try{
            idval = 0;
            var sm = workflowgrid.getSelectionModel();
            var selrecords = sm.getSelection();
            if(sm.getCount() > 0){
                var fieldname = "id";
                var idval = selrecords[0].get('id')
                // alert(idval);
            }

            //   return;

            var xmlHttp = null;
            xmlHttp = new XMLHttpRequest();
            xmlHttp.open( "GET", "BSSPerformInsert.php?BSSConfigName=" + BSSConfigName+ "&masterid=" + idval, false );
            xmlHttp.send(null);

            // document.write("<p>"+ xmlHttp.responseText + "</p>");

            newdata = eval('[' + xmlHttp.responseText + ']');

            BSSStore.add(newdata);
        }catch(e)
        {document.write("<p>" + e.message + "</p>");
        }

    }

function processDelete(BSSConfigName, BSSGrid, BSSStore)
{

        var sm = BSSGrid.getSelectionModel();
        BSSStore.remove(sm.getSelection());

        if (BSSStore.getCount() > 0) {
            sm.select(0);
        }

        var delrecords = BSSStore.getRemovedRecords();

        var fieldname = "id";




        //"&id=" + delrecords[0].get('id'),

        try{
            var xmlHttp = null;
            xmlHttp = new XMLHttpRequest();
            xmlHttp.open( "GET", "BSSPerformDelete.php?BSSConfigName=" + BSSConfigName + "&id=" + delrecords[0].get('id'), false);
            xmlHttp.send(null);

            //alert(xmlHttp.responseText);

            BSSStore.removed = [];


        }catch(e)
        {    alert(e.message); //document.write("<p>" + e.message + "</p>");
        }


    }

function processUpdate(BSSConfigName, BSSGrid, BSSStore)
{


        var updrecords = BSSStore.getUpdatedRecords();

        var fieldname = "phone_type";
        var rec = new BSSStore.model();

        jsenc = "";
        var fieldcount = rec.fields.getCount();

        var xfieldtype;
        var xfieldname;


        for(x = 0; x < fieldcount; x++){
            xfieldtype = rec.fields.getAt(x).type.type;
            xfieldname = rec.fields.getAt(x).name;

            switch(xfieldtype){
                case "date":
                    jsenc = jsenc + formatDate(updrecords[0].get(xfieldname)) + "|";
                    break;
                case "bool":
                    if(updrecords[0].get(xfieldname).toString()=='true'){
                        jsenc = jsenc + "1" + "|";
                    }else{
                        jsenc = jsenc + "0" + "|";
                    }
                    break;
                default:
                    jsenc = jsenc + updrecords[0].get(xfieldname) + "|";
            }
        }


        try{
            var xmlHttp = null;
            xmlHttp = new XMLHttpRequest();
            xmlHttp.open( "GET", "BSSPerformUpdate.php?BSSConfigName=" + BSSConfigName + "&id=" + jsenc, false);
            xmlHttp.send(null);
            //alert(xmlHttp.responseText);

            //REmove the red triangle
            BSSStore.each(function(r){
                r.commit();
            });


        }catch(e)
        {alert(e.getMessage());}


    }

function GetWorkflowSteps(BSSConfigName, BSSGrid, BSSStore)
{
    try{

        alert("here");

        idval = 0;
        var sm = BSSGrid.getSelectionModel();
        var selrecords = sm.getSelection();
        if(sm.getCount() > 0){
            var fieldname = "id";
            BSSWorkflowId = selrecords[0].get('id');
            BSSWorkflowName = selrecords[0].get('WorkflowName');
            //alert(idval);
        }

        var xmlHttp = null;
        xmlHttp = new XMLHttpRequest();
        xmlHttp.open( "GET", "BSSGetWorkflowGOJSData.php?BSSWorkflowId=" + BSSWorkflowId, false ); //?BSSWorkflowStepId=" + xstepbox.getAttrs().id + "&name=" + StatusType  + "$statustype=" + StatusType + "&xloc=" + curx + "&yloc=" + cury, false );
        xmlHttp.send(null);

        str =  xmlHttp.responseText;

        alert(str);

        myDiagram.clear();
        myDiagram.model = go.Model.fromJson(str);
        myDiagram.undoManager.isEnabled = true;

        myDiagram.add(
                $(go.Node, go.Panel.Vertical,
                        $(go.TextBlock, {name: 'txtWFSelected', text: "Selected Workflow: "+ BSSWorkflowName, font: "12pt sans-serif", editable: false }) ));


}catch(e)
    {alert(e.getMessage());}


}


function addworkflowsteptoform(){
    alert('Dropped');
}



}

function inspect(obj, maxLevels, level)
{
    var str = '', type, msg;

    // Start Input Validations
    // Don't touch, we start iterating at level zero
    if(level == null)  level = 0;

    // At least you want to show the first level
    if(maxLevels == null) maxLevels = 1;
    if(maxLevels < 1)
        return '<font color="red">Error: Levels number must be > 0</font>';

    // We start with a non null object
    if(obj == null)
        return '<font color="red">Error: Object <b>NULL</b></font>';
    // End Input Validations

    // Each Iteration must be indented
    str += '<ul>';

    // Start iterations for all objects in obj
    for(property in obj)
    {
        try
        {
            // Show "property" and "type property"
            type =  typeof(obj[property]);
            str += '<li>(' + type + ') ' + property +
                    ( (obj[property]==null)?(': <b>null</b>'):('')) + '</li>';

            // We keep iterating if this property is an Object, non null
            // and we are inside the required number of levels
            if((type == 'object') && (obj[property] != null) && (level+1 < maxLevels))
                str += inspect(obj[property], maxLevels, level+1);
        }
        catch(err)
        {
            // Is there some properties in obj we can't access? Print it red.
            if(typeof(err) == 'string') msg = err;
            else if(err.message)        msg = err.message;
            else if(err.description)    msg = err.description;
            else                        msg = 'Unknown';

            str += '<li><font color="red">(Error) ' + property + ': ' + msg +'</font></li>';
        }
    }

    // Close indent
    str += '</ul>';

    return str;
}


</script>


<div id="sample">
    <div style="width:100%; white-space:nowrap;">
    <span style="display: inline-block; vertical-align: top; padding: 5px; width:110px">
      <div id="myPalette" style="background-color: #9999CC; border: solid 1px black; height: 1000px"></div>
    </span>
    <span style="display: inline-block; vertical-align: top; padding: 5px; width:80%">
      <div id="myDiagram" style="background-color: #6699BC; border: solid 1px black; height: 1000px"></div>
    </span>
    </div>

    <br>

</div>


</body>
</html>