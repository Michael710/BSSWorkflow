<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>



<link rel="stylesheet" type="text/css" href="../resources/css/ext-all.css" />
<link rel="stylesheet" type="text/css" href="../shared/example.css" />
<link rel="stylesheet" type="text/css" href="../ux/css/CheckHeader.css" />

<script type="text/javascript" src="../bootstrap.js"></script>
<script type="text/javascript" src="JSON.js"></script>

<script type="text/javascript" src="go-debug.js"></script>
<script type="text/javascript" src="CustomNodeHandler.js"></script>


<body onload="init()">

<script>



Ext.Loader.setConfig({enabled: true});
Ext.Loader.setPath('Ext.ux', '../ux/');
Ext.require([
    'Ext.form.*',
    'Ext.window.Window',
    'Ext.data.*',
    'Ext.ux.FieldReplicator'
]);


var stage;
var layer;

var BSSWorkflowName = "No Workflow Selected";

var BSSWorkflowId = 0;
var BSSWorkflowStepId = 1;

var BSSStatusInd = 1;

var workflowgrid;
var bssWorkflowStatusData;
var bssWorkflowStatusListStore;
var bssWorkflowActionTypeData;
var bssWorkflowActionTypeStore;
var bssWorkflowNotificationListStore;
var bssWorkflowPolicyData;
var bssWorkflowPolicyDataStore;

var bsslinedrawmode = 'OFF';
var startlinedrawx;
var startlinedrawy;
var endlinedrawx;
var endlinedrawy;

var BSSUserId = "0";


var BSSFormMode = "";
var BSSInstanceMode = "";

processForm();

//alert(BSSFormMode);

if(BSSFormMode=="Instance"){
    BSSInstanceMode = "Instance";
}else{
    BSSInstanceMode = "";
}


bssWorkflowStatusData = [
    {id:1, value: 'Start'},
    {id:2, value: 'Submit'},
    {id:3, value: 'Review'},
    {id:4, value: 'Rejected'},
    {id:5, value: 'Approved'},
    {id:6, value: 'Action'},
    {id:7, value: 'Notify'},
    {id:8, value: 'Task'},
    {id:9, value: 'End'}
];




bssWorkflowStatusListStore = Ext.create('Ext.data.Store', {
            fields: [{name: 'id'}, {name: 'value'}],
            data: bssWorkflowStatusData,
            listeners: {
                load: function () {
                    //this sets the default value to USA after the store loads
                    //   var combo = Ext.getCmp('idstatustype');
                    //   combo.setValue('2');
                }
            }
        }
);


bssWorkflowPolicyData = [
    {id:1, value: 'All'},
    {id:2, value: 'Majority'},
    {id:3, value: 'First'}
];

bssWorkflowPolicyDataStore = Ext.create('Ext.data.Store', {
            fields: [{name: 'id'}, {name: 'value'}],
            data: bssWorkflowPolicyData
          //  listeners: {
          //      load: function () {
                    //this sets the default value
                   // var combo = Ext.getCmp('idworkflowpolicy');
                   // combo.setValue('1');
          //      }
        //    }
        }
);

bssWorkflowActionTypeData = [
    { id:1, value: 'Action'},
    { id:2, value: 'URL'}
];


bssWorkflowEnabledData = [
    { id:0, value: 'No'},
    { id:1, value: 'Yes'}
];


// create the data store
var workflowstore = Ext.create('Ext.data.Store', {
    fields: [
        {name: 'id', type: 'string'},
        {name: 'sequence', type: 'string'},
        {name: 'masterid', type: 'string'},
        {name: 'WorkflowName', type: 'string'},
        {name: 'Workflowdescription', type: 'string'},
        {name: 'Enabled', type: 'string'}
    ],
    data:
            [['1','','','','','','','','','','']]
});



bssWorkflowEnabledStore = Ext.create('Ext.data.Store', {
            fields: [{name: 'id'}, {name: 'value'} ],
            data: bssWorkflowEnabledData
        }
);

bssWorkflowActionTypeStore = Ext.create('Ext.data.Store', {
            fields: [{name: 'id'}, {name: 'value'} ],
            data: bssWorkflowActionTypeData
        }
);

bssWorkflowNotificationListStore = Ext.create('Ext.data.Store', {
            fields: [{name: 'id'}, {name: 'value'} ],
            data: bssWorkflowActionTypeData
        }
);



bssWorkflowApprovalStatusData = [ { id:1, value: 'Approved'},{ id:2, value: 'Rejected'}];

workflowapprovalstatusliststore = Ext.create('Ext.data.Store', {
            fields: [{name: 'id'}, {name: 'value'} ],
            data: bssWorkflowApprovalStatusData
        }
);

var BSSSIGNOFF_FLAG = false;
var BSSADDREMOVEAPPROVERS = false;


var BSSENABLECOMPLETETASK = false;
var BSSENABLEREJECTTASK = false;
var BSSENABLELAUNCHURLTASK = false;
var BSSENABLECOMPLETEURLTASK = false;
var BSSENABLEREJECTURLTASK = false;

var signoffsStore = Ext.create('Ext.data.Store', {
    fields: [
        {name: 'id', type: 'string'},
        {name: 'masterid', type: 'string'},
        {name: 'sequence', type: 'string'},
        {name: 'WorkflowApprover', type: 'string'},
        {name: 'SignoffDate', type: 'date'},
        {name: 'SignoffResult', type: 'string'},
        {name: 'Comments', type: 'string'}
    ],
    data:
            [['1','','','','','','']]
});

bssUserData = [ { id:1, value: 'A'},{ id:2, value: 'B'}];

userliststore = Ext.create('Ext.data.Store', {
            fields: [{name: 'id'}, {name: 'value'} ],
            data: bssUserData
        }
);


//Get the data
xmlHttp = new XMLHttpRequest();
xmlHttp.open( "GET", "DBServices/BSSGetComboStore.php?BSSSQLString=SELECT id, Email AS value FROM users", false );
xmlHttp.send( null );
//        alert("DATA: " + xmlHttp.responseText);
var bssNewFlowManagerData = eval('[' + xmlHttp.responseText + ']');
userliststore.loadData(bssNewFlowManagerData,false);


var cellEditing5 = Ext.create('Ext.grid.plugin.CellEditing', {
    clicksToEdit: 1
});

var cellEditing6 = Ext.create('Ext.grid.plugin.CellEditing', {
    clicksToEdit: 1
});

//Get the data
xmlHttp = new XMLHttpRequest();
xmlHttp.open( "GET", "DBServices/BSSGetComboStore.php?BSSSQLString=SELECT id, NotificationName AS value FROM Notifications", false );
xmlHttp.send( null );
//alert("DATA: " + xmlHttp.responseText);
var bssNotificationData = eval('[' + xmlHttp.responseText + ']');
bssWorkflowNotificationListStore.loadData(bssNotificationData,false);

Ext.Loader.setConfig({
    enabled: true
});
Ext.Loader.setPath('Ext.ux', '../ux');

Ext.require([
    'Ext.selection.CellModel',
    'Ext.grid.*',
    'Ext.data.*',
    'Ext.util.*',
    'Ext.state.*',
    'Ext.form.*',
    'Ext.ux.CheckColumn', '*'
]);


function init() {

   // if (window.goSamples) goSamples();  // init for these samples -- you don't need to call this
    var $ = go.GraphObject.make;  // for conciseness in defining templates

    myDiagram = new go.Diagram("myDiagram");// must name or refer to the DIV HTML element
    myDiagram.allowVerticalScroll = false;
    myDiagram.allowSelect = true;
    myDiagram.allowGroup = false;
    myDiagram.maxSelectionCount = 1;

    // define several shared Brushes
    var graygrad = $(go.Brush, go.Brush.Linear, { 0: "rgb(150, 150, 150)", 0.5: "rgb(86, 86, 86)", 1: "rgb(86, 86, 86)" });
    var greengrad = $(go.Brush, go.Brush.Linear, { 0: "rgb(98, 199, 79)", 1: "rgb(17, 51, 6)" });
    var bluegrad = $(go.Brush, go.Brush.Linear, { 0: "rgb(50, 50, 150)", 1: "rgb(51, 102, 255)" });
    var orggrad = $(go.Brush, go.Brush.Linear, { 0: "rgb(255, 81, 0)", 1: "rgb(153, 50, 0)" });
    var redgrad = $(go.Brush, go.Brush.Linear, { 0: "rgb(255, 0, 0)", 1: "rgb(100, 0, 0)" });
    var yellowgrad = $(go.Brush, go.Brush.Linear, { 0: "rgb(254, 201, 0)", 1: "rgb(254, 162, 0)" });
    var blackgrad = $(go.Brush, go.Brush.Linear, { 0: "rgb(0, 0, 0)", 1: "rgb(120, 120, 120)" });
    var purplegrad = $(go.Brush, go.Brush.Linear, { 0: "rgb(99, 0, 99)", 1: "rgb(153, 51, 153)" });


    var BSSReviewBrush =  purplegrad;


    // Don't show shadows on mobile devices for performance reasons
    var shadows = !("ontouchstart" in window);

    // define the Node template for regular nodes

 //   myDiagram.add(
 //           $(go.Node, go.Panel.Vertical,
 //                   $(go.TextBlock, {name: 'txtWFSelected', text: "Selected Workflow: "+ BSSWorkflowName, font: "12pt sans-serif" }) ));

 //   var s = "TEST ME";
 //   myDiagram.nodeTemplateMap.add("SELECTEDWF",
 //           $(go.Node, "Vertical",
 //           $(go.TextBlock,
 //           { font: "12pt sans-serif" },
 //           new go.Binding("text", "wfname", function(s) { return "Selected Workflow: " + s; }))));

    myDiagram.nodeTemplateMap.add("",  // the default category
            $(go.Node, go.Panel.Spot,
                    // the Node.location is at the center of each node
                    { locationSpot: go.Spot.Center, isShadowed: shadows, shadowColor: "#242424" },
                    // The Node.location comes from the "loc" property of the node data,
                    // converted by the Point.parse method.
                    // If the Node.location is changed, it updates the "loc" property of the node data,
                    // converting back using the Point.stringify method.
                    new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                    // handle mouse enter/leave events to show/hide the ports
                    { mouseEnter: function(e, obj) { showPorts(obj.part, true); },
                      mouseLeave: function(e, obj) { showPorts(obj.part, false); },
                  mouseDragLeave: function(e, obj) {addworkflowsteptoform(); },
                     doubleClick: function(e, obj) { alert(obj); }},
                    // the main object is a Panel that surrounds a TextBlock with a rectangular Shape
                    $(go.Panel, go.Panel.Auto,
                            $(go.Shape,
                                    { figure: "RoundedRectangle", fill: graygrad },
                                    new go.Binding("figure", "figure")),
                            $(go.TextBlock,
                                    { font: "bold 9pt Helvetica, Arial, sans-serif",
                                        stroke: "white",
                                        margin: 8,
                                        maxSize: new go.Size(100, NaN),
                                        wrap: go.TextBlock.WrapFit,
                                        editable: true },
                                    new go.Binding("text", "text").makeTwoWay())),
                    // four named ports, one on each side:
                    makePort("L", go.Spot.Left, true, true),
                    makePort("R", go.Spot.Right, true, true),
                    makePort("T", go.Spot.Top, false, true),
                    makePort("B", go.Spot.Bottom, true, false)
            ));


  /*
    myDiagram.nodeTemplateMap.add("LOAD",  // the default category
            $(go.Node, go.Panel.Spot,
                    { locationSpot: go.Spot.Center, isShadowed: shadows, shadowColor: "#242424", selectable: false },
                    new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                    { mouseEnter: function(e, obj) { showPorts(obj.part, true); },
                      mouseLeave: function(e, obj) { showPorts(obj.part, false); },
                      doubleClick: function(e, obj) {GetWorkFlowList(); }},
                    $(go.Panel, go.Panel.Auto,
                            $(go.Shape,
                                    { figure: "RoundedRectangle", fill: bluegrad },
                                    new go.Binding("figure", "figure")),
                            $(go.TextBlock,
                                    { font: "bold 9pt Helvetica, Arial, sans-serif",
                                        stroke: "white",
                                        margin: 8,
                                        maxSize: new go.Size(100, NaN),
                                        wrap: go.TextBlock.WrapFit,
                                        editable: true },
                                    new go.Binding("text", "text").makeTwoWay()))
               //     makePort("L", go.Spot.Left, true, true),
               //     makePort("R", go.Spot.Right, true, true)

            ));

    */


    var lightText = 'whitesmoke';
    myDiagram.nodeTemplateMap.add("LOAD",
            $(go.Node, "Spot", menuStyle(),     {doubleClick: function(e, obj) {GetWorkFlowList(); }},
                    $(go.Panel, "Auto",
                            $(go.Shape, "Square",
                                    { minSize: new go.Size(10, 15), fill: bluegrad, /* "#DC3C00",*/ stroke: null }),
                            $(go.TextBlock, "Workflows",
                                    { margin: 5, font: "bold 11pt Helvetica, Arial, sans-serif", stroke: lightText })
                    )
            ));

    myDiagram.nodeTemplateMap.add("INFO",
            $(go.Node, "Spot", menuStyle(),     {doubleClick: function(e, obj) {GetWorkFlowList(); }},
                    $(go.Panel, "Auto",
                            $(go.Shape, "Square",
                                    { minSize: new go.Size(10, 15), fill: bluegrad, /* "#DC3C00",*/ stroke: null }),
                            $(go.TextBlock, "WF Details",
                                    { margin: 5, font: "bold 11pt Helvetica, Arial, sans-serif", stroke: lightText })
                    )

                    // three named ports, one on each side except the bottom, all input only:
                  //  makePort("T", go.Spot.Top, false, true),
                  //  makePort("L", go.Spot.Left, false, true),
                  //  makePort("R", go.Spot.Right, false, true)
            ));


       /*
    myDiagram.nodeTemplateMap.add("CLEAR",  // the default category
            $(go.Node, go.Panel.Spot,
                    { locationSpot: go.Spot.Center, isShadowed: shadows, shadowColor: "#242424", selectable: false },
                    new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                    { mouseEnter: function(e, obj) { showPorts(obj.part, true); },
                        mouseLeave: function(e, obj) { showPorts(obj.part, false); },
                        doubleClick: function(e, obj) {clear(); }},
                    $(go.Panel, go.Panel.Auto,
                            $(go.Shape,
                                    { figure: "RoundedRectangle", fill: greengrad },
                                    new go.Binding("figure", "figure")),
                            $(go.TextBlock,
                                    { font: "bold 9pt Helvetica, Arial, sans-serif",
                                        stroke: "white",
                                        margin: 8,
                                        maxSize: new go.Size(100, NaN),
                                        wrap: go.TextBlock.WrapFit,
                                        editable: true },
                                    new go.Binding("text", "text").makeTwoWay()))
                    //     makePort("L", go.Spot.Left, true, true),
                    //     makePort("R", go.Spot.Right, true, true)
            ));

         */

    //var lightText = 'whitesmoke'; minSize: new go.Size(20, 15),

    myDiagram.nodeTemplateMap.add("CLEAR",
            $(go.Node, "Auto", menuStyle(), {doubleClick: function(e, obj) {clear(); }},
                    $(go.Panel, "Auto",
                            $(go.Shape, "Square",
                                    {  maxSize: new go.Size(100, 45), fill: greengrad /* "#DC3C00" */, stroke: null }),
                            $(go.TextBlock, "Clear",
                                    { margin: 5, font: "bold 11pt Helvetica, Arial, sans-serif", stroke: lightText })
                    )
                    // three named ports, one on each side except the bottom, all input only:
                    //  makePort("T", go.Spot.Top, false, true),
                    //  makePort("L", go.Spot.Left, false, true),
                    //  makePort("R", go.Spot.Right, false, true)
            ));



        /*

    myDiagram.nodeTemplateMap.add("AUDIT",  // the default category
            $(go.Node, go.Panel.Spot,
                    { locationSpot: go.Spot.Center, isShadowed: shadows, shadowColor: "#242424", selectable: false },
                    new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                    { mouseEnter: function(e, obj) { showPorts(obj.part, true); },
                        mouseLeave: function(e, obj) { showPorts(obj.part, false); },
                        doubleClick: function(e, obj) {audit(); }},
                    $(go.Panel, go.Panel.Auto,
                            $(go.Shape,
                                    { figure: "RoundedRectangle", fill: redgrad },
                                    new go.Binding("figure", "figure")),
                            $(go.TextBlock,
                                    { font: "bold 9pt Helvetica, Arial, sans-serif",
                                        stroke: "white",
                                        margin: 8,
                                        maxSize: new go.Size(100, NaN),
                                        wrap: go.TextBlock.WrapFit,
                                        editable: true },
                                    new go.Binding("text", "text").makeTwoWay()))
                    //     makePort("L", go.Spot.Left, true, true),
                    //     makePort("R", go.Spot.Right, true, true)
            ));

          */

    //var lightText = 'whitesmoke';
    myDiagram.nodeTemplateMap.add("AUDIT",
            $(go.Node, "Spot",  menuStyle(), {doubleClick: function(e, obj) {audit(); }},
                    $(go.Panel, "Auto",
                            $(go.Shape, "Square",
                                    { minSize: new go.Size(10, 15), fill: redgrad /* "#DC3C00" */, stroke: null }),
                            $(go.TextBlock, "Audit",
                                    { margin: 5, font: "bold 11pt Helvetica, Arial, sans-serif", stroke: lightText })
                    )
                    // three named ports, one on each side except the bottom, all input only:
                    //  makePort("T", go.Spot.Top, false, true),
                    //  makePort("L", go.Spot.Left, false, true),
                    //  makePort("R", go.Spot.Right, false, true)
            ));



    /*
    myDiagram.nodeTemplateMap.add("SUBMIT",  // the default category
            $(go.Node, go.Panel.Spot,
                    { locationSpot: go.Spot.Center, isShadowed: shadows, shadowColor: "#242424"},
                    new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                    { mouseEnter: function(e, obj) { showPorts(obj.part, true); },
                      mouseLeave: function(e, obj) { showPorts(obj.part, false); },
                      doubleClick: function(e, obj) {OpenSubmitForm(BSSWorkflowId, obj.part.data.key, obj.part.data.category); }},
                    $(go.Panel, go.Panel.Auto,
                            $(go.Shape,
                                    { figure: "RoundedRectangle", fill: bluegrad },
                                    new go.Binding("figure", "figure")),
                            $(go.TextBlock,
                                    { font: "bold 9pt Helvetica, Arial, sans-serif",
                                        stroke: "white",
                                        margin: 12,
                                        maxSize: new go.Size(100, NaN),
                                        wrap: go.TextBlock.WrapFit,
                                        editable: true },
                                    new go.Binding("text", "text").makeTwoWay())),
                    $(go.Shape, "Circle",
                            { alignment: go.Spot.TopCenter, //alignmentFocus: go.Spot.TopRight,
                                width: 10, height: 10, fill: "rgb(0, 0, 0)", background: "red", visible: true  },
                            new go.Binding("visible", "", nodeStatusVisibleConverter).ofObject(),
                            new go.Binding("fill", "status",nodeStatusConverter)),
                 //   new go.Binding("parameter1", "parameter1", function(v) { alert('par is ' + v); BSSStatusInd = v; }),
                    makePort("L", go.Spot.Left, true, true),
                    makePort("R", go.Spot.Right, true, true),
                    makePort("T", go.Spot.Top, false, true),
                    makePort("B", go.Spot.Bottom, true, false)
            ));

      */


    //var lightText = 'whitesmoke';
    myDiagram.nodeTemplateMap.add("SUBMIT",
            $(go.Node, "Spot", nodeStyle(),
                    { mouseEnter: function(e, obj) { showPorts(obj.part, true); },
                        mouseLeave: function(e, obj) { showPorts(obj.part, false); },
                        doubleClick: function(e, obj) {OpenSubmitForm(BSSWorkflowId, obj.part.data.key, obj.part.data.category); }},
                    $(go.Panel, "Auto",
                            $(go.Shape, "Rectangle",
                                    { minSize: new go.Size(10, 25), fill: bluegrad /* "#DC3C00" */, stroke: null }),
                            $(go.TextBlock, "Submit",
                                    { margin: 5, font: "bold 11pt Helvetica, Arial, sans-serif", stroke: lightText },
                                      new go.Binding("text", "text").makeTwoWay())),
                    $(go.Shape, "Circle",
                            { alignment: go.Spot.TopCenter, //alignmentFocus: go.Spot.TopRight,
                                width: 10, height: 10, fill: "rgb(0, 0, 0)", background: "red", visible: true  },
                            new go.Binding("visible", "", nodeStatusVisibleConverter).ofObject(),
                            new go.Binding("fill", "status",nodeStatusConverter)),
                    // three named ports, one on each side except the bottom, all input only:

                    makePort("T", go.Spot.Top, false, true),
                    makePort("L", go.Spot.Left, false, true),
                    makePort("R", go.Spot.Right, false, true),
                    makePort("B", go.Spot.Bottom, true, false)
            ));



    myDiagram.nodeTemplateMap.add("URL",  // the default category
            $(go.Node, go.Panel.Spot,
                    { locationSpot: go.Spot.Center, isShadowed: shadows, shadowColor: "#242424" },
                    new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                    { mouseEnter: function(e, obj) { showPorts(obj.part, true); },
                        mouseLeave: function(e, obj) { showPorts(obj.part, false); },
                        doubleClick: function(e, obj) {OpenURLForm(BSSWorkflowId, obj.part.data.key, obj.part.data.category); }},
                    $(go.Panel, go.Panel.Auto,
                            $(go.Shape,
                                    { figure: "Cloud", fill: bluegrad },
                                    new go.Binding("figure", "figure")),
                            $(go.TextBlock,
                                    { font: "bold 9pt Helvetica, Arial, sans-serif",
                                        stroke: "white",
                                        margin: 8,
                                        maxSize: new go.Size(100, NaN),
                                        wrap: go.TextBlock.WrapFit,
                                        editable: true },
                                    new go.Binding("text", "text").makeTwoWay())),
                    $(go.Shape, "Circle",
                            { alignment: go.Spot.TopCenter, // alignmentFocus: go.Spot.TopRight,
                                width: 10, height: 10, fill: "rgb(0, 0, 0)", background: "red", visible: true  },
                            new go.Binding("visible", "", nodeStatusVisibleConverter).ofObject(),
                            new go.Binding("fill", "status",nodeStatusConverter)),
                    makePort("L", go.Spot.Left, true, true),
                    makePort("R", go.Spot.Right, true, true),
                    makePort("T", go.Spot.Top, false, true),
                    makePort("B", go.Spot.Bottom, true, false)
            ));

    /*
    myDiagram.nodeTemplateMap.add("REVIEW",  // the default category
            $(go.Node, go.Panel.Spot,
                    { locationSpot: go.Spot.Center, isShadowed: shadows, shadowColor: "#242424" },
                    new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                    { mouseEnter: function(e, obj) { showPorts(obj.part, true); },
                      mouseLeave: function(e, obj) { showPorts(obj.part, false); },
                      doubleClick: function(e, obj) {OpenReviewForm(BSSWorkflowId, obj.part.data.key, obj.part.data.category,obj); }},
                    $(go.Panel, go.Panel.Auto,
                            $(go.Shape,
                                    { figure: "RoundedRectangle", fill: BSSReviewBrush },
                                    new go.Binding("figure", "figure")),
                            $(go.TextBlock,
                                    { font: "bold 9pt Helvetica, Arial, sans-serif",
                                        stroke: "white",
                                        margin: 8,
                                        maxSize: new go.Size(100, NaN),
                                        wrap: go.TextBlock.WrapFit,
                                        editable: true },
                                    new go.Binding("text", "text").makeTwoWay())),
                            $(go.Shape, "Circle",
                            { alignment: go.Spot.TopCenter, //alignmentFocus: go.Spot.TopRight,
                                width: 10, height: 10, fill: "rgb(0, 0, 0)", background: "red", visible: true  },
                            new go.Binding("visible", "", nodeStatusVisibleConverter).ofObject(),
                            new go.Binding("fill", "status",nodeStatusConverter)),
                    makePort("L", go.Spot.Left, true, true),
                    makePort("R", go.Spot.Right, true, true),
                    makePort("T", go.Spot.Top, false, true),
                    makePort("B", go.Spot.Bottom, true, false)

            ));
      */

    //var lightText = 'whitesmoke';
    myDiagram.nodeTemplateMap.add("REVIEW",
            $(go.Node, "Spot", nodeStyle(),
                    { mouseEnter: function(e, obj) { showPorts(obj.part, true); },
                      mouseLeave: function(e, obj) { showPorts(obj.part, false); },
                      doubleClick: function(e, obj) {OpenReviewForm(BSSWorkflowId, obj.part.data.key, obj.part.data.category,obj); }},
                    $(go.Panel, "Auto",
                            $(go.Shape, "Rectangle",
                                    { minSize: new go.Size(10, 25), fill: greengrad /* "#DC3C00" */, stroke: null }),
                            $(go.TextBlock, "Review",
                                    { margin: 5, font: "bold 11pt Helvetica, Arial, sans-serif", stroke: lightText },
                                    new go.Binding("text", "text").makeTwoWay())),

                    $(go.Shape, "Circle",
                            { alignment: go.Spot.TopCenter, //alignmentFocus: go.Spot.TopRight,
                                width: 10, height: 10, fill: "rgb(0, 0, 0)", background: "red", visible: true  },
                            new go.Binding("visible", "", nodeStatusVisibleConverter).ofObject(),
                            new go.Binding("fill", "status",nodeStatusConverter)),
                    // three named ports, one on each side except the bottom, all input only:

                      makePort("T", go.Spot.Top, false, true),
                      makePort("L", go.Spot.Left, false, true),
                      makePort("R", go.Spot.Right, false, true),
                      makePort("B", go.Spot.Bottom, true, false)
            ));



             /*
    myDiagram.nodeTemplateMap.add("NOTIFY",  // the default category
            $(go.Node, go.Panel.Spot,
                    { locationSpot: go.Spot.Center, isShadowed: shadows, shadowColor: "#242424" },
                    new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                    { mouseEnter: function(e, obj) { showPorts(obj.part, true); },
                      mouseLeave: function(e, obj) { showPorts(obj.part, false); },
                      doubleClick: function(e, obj) {OpenNotificationForm(BSSWorkflowId, obj.part.data.key, obj.part.data.category); }},
                    $(go.Panel, go.Panel.Auto,
                            $(go.Shape,
                                    { figure: "File", fill: yellowgrad },
                                    new go.Binding("figure", "figure")),
                            $(go.TextBlock,
                                    { font: "bold 9pt Helvetica, Arial, sans-serif",
                                        stroke: "black",
                                        margin: 8,
                                        maxSize: new go.Size(100, NaN),
                                        wrap: go.TextBlock.WrapFit,
                                        editable: true },
                                    new go.Binding("text", "text").makeTwoWay())),
                    $(go.Shape, "Circle",
                            { alignment: go.Spot.TopCenter, //alignmentFocus: go.Spot.TopRight,
                                width: 10, height: 10, fill: "rgb(0, 0, 0)", background: "red", visible: true  },
                            new go.Binding("visible", "", nodeStatusVisibleConverter).ofObject(),
                            new go.Binding("fill", "status",nodeStatusConverter)),
                    makePort("L", go.Spot.Left, true, true),
                    makePort("R", go.Spot.Right, true, true),
                    makePort("T", go.Spot.Top, false, true),
                    makePort("B", go.Spot.Bottom, true, false)

            ));

               */

    myDiagram.nodeTemplateMap.add("NOTIFY",
            $(go.Node, "Spot", nodeStyle(),
                    { mouseEnter: function(e, obj) { showPorts(obj.part, true); },
                        mouseLeave: function(e, obj) { showPorts(obj.part, false); },
                        doubleClick: function(e, obj) {OpenReviewForm(BSSWorkflowId, obj.part.data.key, obj.part.data.category,obj); }},
                    $(go.Panel, "Auto",
                            $(go.Shape, "Rectangle",
                                    { minSize: new go.Size(10, 25), fill: yellowgrad /* "#DC3C00" */, stroke: null }),
                            $(go.TextBlock, "Notify",
                                    { margin: 5, font: "bold 11pt Helvetica, Arial, sans-serif", stroke: lightText },
                                    new go.Binding("text", "text").makeTwoWay())),


                    $(go.Shape, "Circle",
                            { alignment: go.Spot.TopCenter, //alignmentFocus: go.Spot.TopRight,
                                width: 10, height: 10, fill: "rgb(0, 0, 0)", background: "red", visible: true  },
                            new go.Binding("visible", "", nodeStatusVisibleConverter).ofObject(),
                            new go.Binding("fill", "status",nodeStatusConverter)),
                    // three named ports, one on each side except the bottom, all input only:

                    makePort("T", go.Spot.Top, false, true),
                    makePort("L", go.Spot.Left, false, true),
                    makePort("R", go.Spot.Right, false, true),
                    makePort("B", go.Spot.Bottom, true, false)
            ));




    myDiagram.nodeTemplateMap.add("TASK",  // the default category
            $(go.Node, go.Panel.Spot,
                    { locationSpot: go.Spot.Center, isShadowed: shadows, shadowColor: "#242424" },
                    new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                    { mouseEnter: function(e, obj) { showPorts(obj.part, true); },
                        mouseLeave: function(e, obj) { showPorts(obj.part, false); },
                        doubleClick: function(e, obj) {OpenTaskForm(BSSWorkflowId, obj.part.data.key, obj.part.data.category); }},
                    $(go.Panel, go.Panel.Auto,
                            $(go.Shape,
                                    { figure: "Actor", fill: bluegrad },
                                    new go.Binding("figure", "figure")),
                            $(go.TextBlock,
                                    { font: "bold 9pt Helvetica, Arial, sans-serif",
                                        stroke: "white",
                                        margin: 8,
                                        maxSize: new go.Size(100, NaN),
                                        wrap: go.TextBlock.WrapFit,
                                        editable: true },
                                    new go.Binding("text", "text").makeTwoWay())),
                    $(go.Shape, "Circle",
                            {   alignment: go.Spot.TopCenter, //alignmentFocus: go.Spot.TopRight,   //position: go.Point(1,1), //
                                width: 10, height: 10, fill: "rgb(0, 0, 0)", background: "red", visible: true},
                            new go.Binding("visible", "", nodeStatusVisibleConverter).ofObject(),
                            new go.Binding("fill", "status",nodeStatusConverter)),
                    makePort("L", go.Spot.Left, true, true),
                    makePort("R", go.Spot.Right, true, true),
                    makePort("T", go.Spot.Top, false, true),
                    makePort("B", go.Spot.Bottom, true, false)

            ));

    /*
    myDiagram.nodeTemplateMap.add("REJECTED",  // the default category
            $(go.Node, go.Panel.Spot,
                    { locationSpot: go.Spot.Center, isShadowed: shadows, shadowColor: "#242424" },
                    new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                    { mouseEnter: function(e, obj) { showPorts(obj.part, true); },
                      mouseLeave: function(e, obj) { showPorts(obj.part, false); },
                      doubleClick: function(e, obj) {OpenRejectForm(BSSWorkflowId, obj.part.data.key, obj.part.data.category);}
                    },
                    $(go.Panel, go.Panel.Auto,
                            $(go.Shape,
                                    { figure: "RoundedRectangle", fill: graygrad },
                                    new go.Binding("fill", "status", RejectStatusConverter),
                                    new go.Binding("figure", "figure")),
                            $(go.TextBlock,
                                    { font: "bold 9pt Helvetica, Arial, sans-serif",
                                        stroke: "white",
                                        margin: 8,
                                        maxSize: new go.Size(100, NaN),
                                        wrap: go.TextBlock.WrapFit,
                                        editable: true },
                                    new go.Binding("text", "text").makeTwoWay())),
                    // four named ports, one on each side:
                    //       makePort("T", go.Spot.Top, false, true),
                    makePort("L", go.Spot.Left, true, true),
                    makePort("R", go.Spot.Right, true, true),
                    makePort("T", go.Spot.Top, false, true),
                    makePort("B", go.Spot.Bottom, true, false)

                    //      makePort("B", go.Spot.Bottom, true, false)
            ));

      */



    //var lightText = 'whitesmoke';
    myDiagram.nodeTemplateMap.add("REJECTED",
            $(go.Node, "Spot", nodeStyle(),
                    { mouseEnter: function(e, obj) { showPorts(obj.part, true); },
                        mouseLeave: function(e, obj) { showPorts(obj.part, false); },
                        doubleClick: function(e, obj) {OpenRejectForm(BSSWorkflowId, obj.part.data.key, obj.part.data.category,obj); }},
                    $(go.Panel, "Auto",
                            $(go.Shape, "Rectangle",
                                    { minSize: new go.Size(10, 25), fill: redgrad /* "#DC3C00" */, stroke: null }),
                            $(go.TextBlock, "Rejected",
                                    { margin: 5, font: "bold 11pt Helvetica, Arial, sans-serif", stroke: lightText },
                                    new go.Binding("text", "text").makeTwoWay())),


                    $(go.Shape, "Circle",
                            { alignment: go.Spot.TopCenter, //alignmentFocus: go.Spot.TopRight,
                                width: 10, height: 10, fill: "rgb(0, 0, 0)", background: "red", visible: true  },
                            new go.Binding("visible", "", nodeStatusVisibleConverter).ofObject(),
                            new go.Binding("fill", "status",nodeStatusConverter)),
                    // three named ports, one on each side except the bottom, all input only:

                    makePort("T", go.Spot.Top, false, true),
                    makePort("L", go.Spot.Left, false, true),
                    makePort("R", go.Spot.Right, false, true),
                    makePort("B", go.Spot.Bottom, true, false)
            ));



    myDiagram.nodeTemplateMap.add("ACTION",  // the default category
            $(go.Node, go.Panel.Spot,
                    { locationSpot: go.Spot.Center, isShadowed: shadows, shadowColor: "#242424" },
                    new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                    { mouseEnter: function(e, obj) { showPorts(obj.part, true); },
                        mouseLeave: function(e, obj) { showPorts(obj.part, false); },
                        doubleClick: function(e, obj) {OpenActionForm(BSSWorkflowId, obj.part.data.key, obj.part.data.category); }},
                    $(go.Panel, go.Panel.Auto,
                            $(go.Shape,
                                    { figure: "Procedure", fill: orggrad },
                                    new go.Binding("figure", "figure")),
                            $(go.TextBlock,
                                    { font: "bold 9pt Helvetica, Arial, sans-serif",
                                        stroke: "white",
                                        margin: 8,
                                        maxSize: new go.Size(100, NaN),
                                        wrap: go.TextBlock.WrapFit,
                                        editable: true },
                                    new go.Binding("text", "text").makeTwoWay())),
                    $(go.Shape, "Circle",
                            {   alignment: go.Spot.TopCenter, //alignmentFocus: go.Spot.TopRight,   //position: go.Point(1,1), //
                                width: 10, height: 10, fill: "rgb(0, 0, 0)", background: "red", visible: true },
                            new go.Binding("visible", "", nodeStatusVisibleConverter).ofObject(),
                            new go.Binding("fill", "status", nodeStatusConverter)
                            ),
                    // four named ports, one on each side:
                    makePort("L", go.Spot.Left, true, true),
                    makePort("R", go.Spot.Right, true, true),
                    makePort("T", go.Spot.Top, false, true),
                    makePort("B", go.Spot.Bottom, true, false)

            ));



    myDiagram.nodeTemplateMap.add("START",
            $(go.Node, go.Panel.Spot,
                    { locationSpot: go.Spot.Center, isShadowed: shadows, shadowColor: "#242424" },
                    new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                    { mouseEnter: function(e, obj) { showPorts(obj.part, true); },
                        mouseLeave: function(e, obj) { showPorts(obj.part, false);},
                        doubleClick: function(e, obj) {OpenForm(BSSWorkflowId, obj.part.data.key, obj.part.data.category);}
                    },
                    $(go.Panel, go.Panel.Auto,
                            $(go.Shape,
                                    { figure: "Ellipse", fill: greengrad, stroke: "rgb(17, 51, 6)" }),
                            $(go.TextBlock,
                                    { text: "Start", margin: 5,
                                        font: "bold 9pt Helvetica, Arial, sans-serif",
                                        stroke: "rgb(255, 255, 255)" })),
                    // three named ports, one on each side except the top, all output only:
                    makePort("L", go.Spot.Left, true, false),
                    makePort("R", go.Spot.Right, true, false),
                    makePort("T", go.Spot.Top, false, true),
                    makePort("B", go.Spot.Bottom, true, false)

            ));

    myDiagram.nodeTemplateMap.add("END",
            $(go.Node, go.Panel.Spot,
                    { locationSpot: go.Spot.Center, isShadowed: shadows, shadowColor: "#242424" },
                    new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                    { mouseEnter: function(e, obj) { showPorts(obj.part, true);},
                      mouseLeave: function(e, obj) { showPorts(obj.part, false);},
                      doubleClick: function(e, obj) {OpenForm(BSSWorkflowId, obj.part.data.key, obj.part.data.category);}},
                    $(go.Panel, go.Panel.Auto,
                            $(go.Shape,
                                    { figure: "Ellipse", fill: blackgrad, stroke: "rgb(82, 6, 0)" }),
                            $(go.TextBlock,
                                    { text: "End", margin: 5,
                                        font: "bold 9pt Helvetica, Arial, sans-serif",
                                        stroke: "rgb(255, 255, 255)" })),
                    // three named ports, one on each side except the bottom, all input only:
                  //  makePort("T", go.Spot.Top, false, true),
                    makePort("L", go.Spot.Left, false, true),
                    makePort("R", go.Spot.Right, false, true),
                    makePort("T", go.Spot.Top, false, true),
                    makePort("B", go.Spot.Bottom, true, false)

            ));

    myDiagram.nodeTemplateMap.add("COMMENT",
            $(go.Node, go.Panel.Auto,
                    { locationSpot: go.Spot.Center, isShadowed: shadows, shadowColor: "#242424" },
                    new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                    $(go.Shape,
                            { figure: "File", fill: yellowgrad },
                            new go.Binding("figure", "figure")),
                    $(go.TextBlock,
                            { margin: 5,
                                maxSize: new go.Size(200, NaN),
                                wrap: go.TextBlock.WrapFit,
                                textAlign: "center",
                                editable: true,
                                font: "bold 9pt Helvetica, Arial, sans-serif" },
                            new go.Binding("text", "text").makeTwoWay())
                    // no ports, because no links are allowed to connect with a comment
           ));



    myDiagram.nodeTemplateMap.add("LISTENER",
            $(go.Node, go.Panel.Spot,
                    { locationSpot: go.Spot.Center, isShadowed: shadows, shadowColor: "#242424" },
                    new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                    { mouseEnter: function(e, obj) { showPorts(obj.part, true);},
                        mouseLeave: function(e, obj) { showPorts(obj.part, false);},
                        doubleClick: function(e, obj) {OpenListenerForm(BSSWorkflowId, obj.part.data.key, obj.part.data.category);}},
                    $(go.Panel, go.Panel.Auto,
                            $(go.Shape,
                                    { figure: "Ellipse", fill: blackgrad, stroke: "rgb(82, 6, 0)" }),
                            $(go.TextBlock,
                                    { text: "Listener", margin: 5,
                                        font: "bold 9pt Helvetica, Arial, sans-serif",
                                        stroke: "rgb(255, 255, 255)" }))
                    // three named ports, one on each side except the bottom, all input only:
                    //  makePort("T", go.Spot.Top, false, true),
                    //makePort("L", go.Spot.Left, false, true)
                    //   makePort("R", go.Spot.Right, false, true)
            ));


    myDiagram.nodeTemplateMap.add("TEST",
            $(go.Node, go.Panel.Spot,
                    { locationSpot: go.Spot.Center, isShadowed: shadows, shadowColor: "#242424" },
                    new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                    { mouseEnter: function(e, obj) { showPorts(obj.part, true);},
                        mouseLeave: function(e, obj) { showPorts(obj.part, false);},
                        doubleClick: function(e, obj) {TestWorkflow(BSSWorkflowId);}},
                    $(go.Panel, go.Panel.Auto,
                            $(go.Shape,
                                    { figure: "Power", fill: greengrad, width: 65,height: 65,  stroke: "rgb(82, 6, 0)" }),
                            $(go.TextBlock,
                                    { text: "Test", margin: 0,
                                        font: "bold 9pt Helvetica, Arial, sans-serif",
                                        stroke: "rgb(255, 255, 255)" }))
            ));


    myDiagram.nodeTemplateMap.add("RESET",
            $(go.Node, go.Panel.Spot,
                    { locationSpot: go.Spot.Center, isShadowed: shadows, shadowColor: "#242424" },
                    new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                    { mouseEnter: function(e, obj) { showPorts(obj.part, true);},
                        mouseLeave: function(e, obj) { showPorts(obj.part, false);},
                        doubleClick: function(e, obj) {ResetWorkflow(BSSWorkflowId);}},
                    $(go.Panel, go.Panel.Auto,
                            $(go.Shape,
                                    { figure: "BpmnEventError", fill: redgrad, width: 65,height: 65,  stroke: "rgb(82, 6, 0)" }),
                            $(go.TextBlock,
                                    { text: "Reset", margin: 0,
                                        font: "bold 9pt Helvetica, Arial, sans-serif",
                                        stroke: "rgb(255, 255, 255)" }))
            ));

try{



  //  xmlHttp = new XMLHttpRequest();
  //  xmlHttp.open( "GET", "Workflow/BSSGetWorkflowCustomActionGOJSData.php" , false);
  //  xmlHttp.send( null );
    //   alert("DATA: " + xmlHttp.responseText);
//    var wsdata =eval('[' + xmlHttp.responseText + ']');

//    var BSSCAID = wsdata[0].id;
//    var BSSCALOC = wsdata[0].Location;
//    var BSSCACategory = wsdata[0].Category;
//    var BSSCAText = wsdata[0].Text;
//    var BSSCAFigure = wsdata[0].Figure;
//    var BSSCAColor = wsdata[0].Color;

    varNewNodeName = "EXTACTION";
    varNewNodeFigure = "Procedure";
    varNewNodeColor = "#33AAFF";

   // alert(varNewNodeName);
   // alert(varNewNodeFigure);
   // alert(varNewNodeColor);

    myDiagram.nodeTemplateMap.add(varNewNodeName,  // the default category
            $(go.Node, go.Panel.Spot,
                    { locationSpot: go.Spot.Center, isShadowed: shadows, shadowColor: "#242424" },
                    new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                    { mouseEnter: function(e, obj) { showPorts(obj.part, true); },
                      mouseLeave: function(e, obj) { showPorts(obj.part, false); },
                      doubleClick: function(e, obj) {alert(obj.part.data.key); OpenExtNodeForm(BSSWorkflowId, obj.part.data.key, obj.part.data.category);}},
                    $(go.Panel, go.Panel.Auto,
                            $(go.Shape,
                                    { figure: varNewNodeFigure, fill: varNewNodeColor },
                                    new go.Binding("figure", "figure"),
                                    new go.Binding("fill", "fill")),
                            $(go.TextBlock,
                                    { font: "bold 9pt Helvetica, Arial, sans-serif",
                                        stroke: "white",
                                        margin: 8,
                                        maxSize: new go.Size(100, NaN),
                                        wrap: go.TextBlock.WrapFit,
                                        editable: true },
                                    new go.Binding("text", "text").makeTwoWay())),
                    // four named ports, one on each side:
                    makePort("L", go.Spot.Left, true, true),
                    makePort("R", go.Spot.Right, true, true),
                    makePort("T", go.Spot.Top, false, true),
                    makePort("B", go.Spot.Bottom, true, false)
            ));

}

catch(e)
{alert("Node Creation ERROR: " + e.message);
}



    // replace the default Link template in the linkTemplateMap
    myDiagram.linkTemplate =
            $(go.Link,  // the whole link panel
                    { routing: go.Link.AvoidsNodes,
                        curve: go.Link.JumpOver,
                        corner: 5, toShortLength: 4,
                        relinkableFrom: false, relinkableTo: false, reshapable:true },
                    $(go.Shape,  // the link path shape
                            { isPanelMain: true,
                                stroke: "whitesmoke", strokeWidth: 2 }),
                    $(go.Shape,  // the arrowhead
                            { toArrow: "standard",
                                stroke: null, fill: "whitesmoke" }),
                    $(go.Panel, go.Panel.Auto,
                            { visible: false, name: "LABEL", segmentIndex: 2, segmentFraction: 0.5},
                            new go.Binding("visible", "visible").makeTwoWay(),
                            $(go.Shape,  // the link shape
                                    { figure: "RoundedRectangle", fill: "#F8F8F8", stroke: null }),
                            $(go.TextBlock,  // the label
                                    { textAlign: "center",
                                        font: "10pt helvetica, arial, sans-serif",
                                        stroke: "#919191",
                                        margin: 2, text: "Yes", editable: true }
                            )
                    )
            );



   myDiagram.addDiagramListener("ObjectContextClicked", function(eee) {

                var part = eee.subject.part;

                var r=confirm("Do you wish to delete the step?");
                    if (r==true)
                    {
                        myDiagram.remove(part);
                    }
                    else
                    {
                      //  "You pressed Cancel!";
                       return;
                    }


                    if((part instanceof go.Link)){
                    // Delete link

                        try{

                        var varFrom = part.fromNode.data.key;
                        var varTo = part.toNode.data.key;



                        var xmlHttp = null;
                        xmlHttp = new XMLHttpRequest();
                        xmlHttp.open( "GET", "Workflow/BSSDeleteWorkflowLine.php?BSSWorkflowId=" + BSSWorkflowId + "&BSSFromNode=" + varFrom + "&BSSToNode=" + varTo, false );
                        xmlHttp.send(null);
              //          alert("DATA: " + xmlHttp.responseText);
                        }catch(e){
                            alert(e);
                        }



                    }
                    else{
                    // Delete Step

                    //    var obj =  myDiagram.selection.first();

                        if(BSSWorkflowId == 0){
                            alert("Select or create a workflow first.");
                            myDiagram.clear();
                            return;
                        }

                      //  var StatusType = obj.part.data.category;
                        var keyid = part.data.key;
                     //   var BSSLocation = obj.part.data.loc;


                        var xmlHttp = null;
                        xmlHttp = new XMLHttpRequest();
                        xmlHttp.open( "GET", "Workflow/BSSDeleteWorkflowStep.php?BSSWorkflowId=" + BSSWorkflowId + "&BSSKeyId=" + keyid, false );
                        xmlHttp.send(null);
                      //  alert("DATA: " + xmlHttp.responseText);


                    }

            });

    myDiagram.addDiagramListener("ExternalObjectsDropped",
            function(ee) {

                try{

                 var obj =  myDiagram.selection.first();

                if(BSSWorkflowId == 0){
                    alert("Select or create a workflow first.");
                    myDiagram.clear();
                    return;
                }

                var StatusType = obj.part.data.category;
                var keyid = obj.part.data.key;
                var BSSLocation = obj.part.data.loc;

                   // alert(keyid);

               var xmlHttp = null;
                xmlHttp = new XMLHttpRequest();
                xmlHttp.open( "GET", "Workflow/BSSCreateWorkflowStep.php?BSSWorkflowId=" + BSSWorkflowId + "&name=" + StatusType  + "&BSSKeyId=" + keyid + "&BSSLocation=" + BSSLocation + "&yloc=" + 100, false );
                xmlHttp.send(null);
             //       alert("DATA: " + xmlHttp.responseText);

                }catch(e)
                {alert("Master Data Get ERROR: " + e.message);
                }
            });


    myDiagram.addDiagramListener("SelectionMoved",
            function(ee) {

                try{

                    var obj =  myDiagram.selection.first();

                    if(BSSWorkflowId == 0){
                        alert("Select or create a workflow first.");
                        myDiagram.clear();
                        return;
                    }

                    var StatusType = obj.part.data.category;
                    var keyid = obj.part.data.key;
                    var BSSLocation = obj.part.data.loc;
                    var BSSStatusText = obj.part.data.text;

                   // alert(BSSStatusText);

                   // alert("BSSUpdateWorkflowStep.php?BSSWorkflowId=" + BSSWorkflowId + "&name=" + StatusType  + "&BSSKeyId=" + keyid + "&BSSLocation=" + BSSLocation + "&yloc=" + 100);

                    var xmlHttp = null;
                    xmlHttp = new XMLHttpRequest();
                    xmlHttp.open( "GET", "Workflow/BSSUpdateWorkflowStep.php?BSSWorkflowId=" + BSSWorkflowId + "&name=" + BSSStatusText  + "&BSSKeyId=" + keyid + "&BSSLocation=" + BSSLocation + "&yloc=" + 100, false );
                    xmlHttp.send(null);
                   // alert("DATA: " + xmlHttp.responseText);

                }catch(e)
                {alert("Master Data Get ERROR: " + e.message);
                }
            });



    // make link labels visible if coming out of a "conditional" node
    myDiagram.addDiagramListener("LinkDrawn", function(e) {

        //       '{"from":1, "to":2, "fromPort":"B", "toPort":"T"},
        try{


        var varFrom = e.subject.fromNode.data.key;
        var varTo = e.subject.toNode.data.key;


        var xmlHttp = null;
        xmlHttp = new XMLHttpRequest();
        xmlHttp.open( "GET", "Workflow/BSSCreateWorkflowLine.php?BSSWorkflowId=" + BSSWorkflowId + "&BSSFromNode=" + varFrom  + "&BSSToNode=" + varTo, false );
        xmlHttp.send(null);
         //   alert("DATA: " + xmlHttp.responseText);

    }catch(e)
    {alert("Master Data Get ERROR: " + e.message);
    }

        if (e.subject.fromNode.data.figure === "Diamond") {
            var label = e.subject.findObject("LABEL");
            if (label !== null) label.visible = true;
        }
    })

    if(BSSFormMode == "Instance") {
        myDiagram.allowDrop = false;  // must be true to accept drops from the Palette
        myDiagram.allowDrag = false;
        myDiagram.allowSelect = false;
    }else{
        myDiagram.allowDrop = true;  // must be true to accept drops from the Palette
        myDiagram.allowDrag = true;
        myDiagram.allowSelect = true;

    }

    // temporary links used by LinkingTool and RelinkingTool are also orthogonal:
    myDiagram.toolManager.linkingTool.temporaryLink.routing = go.Link.Orthogonal;
    myDiagram.toolManager.relinkingTool.temporaryLink.routing = go.Link.Orthogonal;

  //  load();  // load an initial diagram from some JSON text

    // initialize the Palette that is on the left side of the page
    myPalette = new go.Palette("myPalette");  // must name or refer to the DIV HTML element
    myPalette.nodeTemplateMap = myDiagram.nodeTemplateMap;  // share the templates used by myDiagram


    // Get addon nodes here

    xmlHttp = new XMLHttpRequest();
    xmlHttp.open( "GET", "Workflow/BSSGetWorkflowCustomActionGOJSData.php" , false);
    xmlHttp.send( null );
      //alert("DATA: " + xmlHttp.responseText);
    var wsdata =eval('[' + xmlHttp.responseText + ']');

    var palExtModel = "";
    var objCount=0;
    for(_obj in wsdata) objCount++;

    //alert(objCount);

    //alert(wsdata.records.count);

    for(xx = 0; xx < objCount; xx++){

    var BSSCAID = wsdata[xx].id;
    var BSSCALOC = wsdata[xx].Location;
    var BSSCACategory = wsdata[xx].Category;
    var BSSCAText = wsdata[xx].Text;
    var BSSCAFigure = wsdata[xx].Figure;
    var BSSCAColor = wsdata[xx].Color;

    var newExtModel = ',{"location": "' + BSSCALOC + '",  "category": "EXTACTION",   "text": "' + BSSCAText + '",  "figure": "' + BSSCAFigure + '",  "fill": "' + BSSCAColor + '" }';

    palExtModel = palExtModel + newExtModel;

    }

    //alert(palExtModel);


    var varModelString = '[' +
    '{"location": "1", "category": "LOAD",       "text": "Workflows"},  ' +
    '{"location": "2", "category": "CLEAR",       "text": "Clear"},  ' +
    '{"location": "3", "category": "AUDIT",      "text": "Audit"},  ' +
    '{"location": "4", "category": "TEST",      "text": "Test"},  ' +
    '{"location": "4", "category": "RESET",      "text": "Reset"},  ' +
    '{"location": "5", "category": "START",      "text": "Start"},  ' +
    '{"location": "6", "category": "SUBMIT",     "text": "Submit", "status": "0"},  ' +                         //bssstatus = "Errored"
    '{"location": "7", "category": "REVIEW",     "text": "Review", "status": "0"},  ' +
    '{"location": "8", "category": "REJECTED",   "text": "Rejected", "status": "1"},  ' +
    '{"location": "9", "category": "ACTION",     "text": "Action"},  ' +
    '{"location": "10", "category": "URL",        "text": "URL"},  ' +
    '{"location": "11", "category": "NOTIFY",    "text": "Notify"},  ' +
    '{"location": "12", "category": "TASK",       "text": "Task"},  ' +
    '{"location": "13", "category": "END",        "text": "End"},  ' +
    '{"location": "14", "category": "COMMENT",    "text": "Comment"},  ' +
    '{"location": "15", "category": "LISTENER",   "text": "Listener"}  ' +  palExtModel  + ']';


    if(BSSFormMode=="Instance"){
        varModelString = '[' + '{"location": "1", "category": "INFO",       "text": "Workflow"} ' + ']';
    }

    var palModel =    new go.GraphLinksModel( eval(varModelString));

    try{
    myPalette.model = palModel;
}catch(e){
    alert(e);
}

    try{
        myPalette.layout.sorting = go.GridLayout.Forward;
}catch(e){
    alert(e);
}

    if(BSSInstanceMode == "Instance"){
        GetInstanceView();
    }



    function nodeStatusConverter(s) {

        if (s >= 3) return "red";                // Failed / Rejected
        if (s >= 2) return "rgb(20, 240, 20)";             // Completed
        if (s >= 1) return "yellow";   // In Process
        return "black";                          // Not Started
    }

    function RejectStatusConverter(s) {
               // Failed / Rejected
        if (s >= 3) return redgrad;             // Redjected
        return graygrad;                          // Not Started
    }
    function nodeStatusVisibleConverter(t) {

        if(t.diagram instanceof go.Palette){
            return false;
        }
        else
        {
            return true;
        }

    }


function OpenTaskForm(WorkflowID, Key, Category){

    var BSSWorkflowStepName;
    BSSWorkflowStepId = Key;

    try{
        xmlHttp = new XMLHttpRequest();
        xmlHttp.open( "GET", "Workflow/BSSGetAdvWorkflowStepData.php?BSSWorkflowId= " + BSSWorkflowId +  "&BSSWorkflowStepId=" +  BSSWorkflowStepId +  "&BSSInstanceMode=" +  BSSFormMode, false ); //BSSInstanceMode
        xmlHttp.send( null );
          //   alert("DATA: " + xmlHttp.responseText);
        var wsdata =eval('[' + xmlHttp.responseText + ']');

        var BSSID = wsdata[0].id;
        var BSSLOC = wsdata[0].location;
        var BSSName = wsdata[0].name;
        var BSSDescription = wsdata[0].description;
        var BSSTASKEE = parseInt(wsdata[0].ApproverUserId);   // Make sure its int
        var BSSInstructions = wsdata[0].Instructions;
        var BSSStarted = wsdata[0].Started;
        var BSSCompleted = wsdata[0].Completed;
        var BSSCategory = wsdata[0].category;
        var BSSStatus = wsdata[0].status;


        var BSSDisableStep = true;
        if(BSSStatus == 1 || BSSStatus == 3){
            BSSDisableStep = false;  //Enabled if in process or rejected
        }

  //      if(BSSUserId != BSSTASKEE){
  //          BSSDisableStep = true;  // Disable if the user is not the taskee
  //      }

       // alert(BSSCompleted);

    }catch(e)
    {alert("Master Data Get ERROR: " + e.message);
    }

    try{
        var form = Ext.create('Ext.form.Panel', {
            id: 'idwsform',
            plain: false,
            border: 0,
            title: 'Status Detail',
            width: 360,
            bodyPadding: 5,

            url: 'Workflow/BSSSaveWorkflowStep.php',
            fieldDefaults: {
                labelWidth: 70,
                anchor: '100%'
            },
            layout: {
                type: 'vbox',
                align: 'stretch'  // Child items are stretched to full width
            },
            items: [
                { //  id: 'id',
                    xtype: 'textfield',
                    fieldLabel: 'id',
                    name: 'id',
                    dataIndex: 'id',
                    value: Key,
                    disabled: true},
                { //  id: 'idxloc',
                    xtype: 'textfield',
                    fieldLabel: 'Location',
                    name: 'location',
                    dataIndex: 'location',
                    value: BSSLOC, //  valx / 70,
                    disabled: true},

                {
                   // id: 'idname',
                    xtype: 'textfield',
                    fieldLabel: 'Name',
                    name: 'name',
                    dataIndex: 'name',
                    value: BSSName
                },
                {   //id: 'iddescription',
                    xtype: 'textfield',
                    fieldLabel: 'Description',
                    name: 'description',
                    //         dataIndex: 'description',
                    value: BSSDescription},

                { //  id: 'iddescription',
                    xtype: 'textfield',
                    fieldLabel: 'Category',
                    name: 'category',
                    dataIndex: 'category',
                    readOnly: true,
                    value: BSSCategory},
                {
                  //  id: 'idinstructions',
                    xtype: 'textarea',
                    fieldLabel: 'Instructions',
                    hideLabel: false,
                    name: 'instructions',
                    dataIndex: 'instructions',
                    value: BSSInstructions,
                    style: 'margin:0', // Remove default margin
                    flex: 1  // Take up all *remaining* vertical space
                },

                {
                   // id: 'idtaskassignemnt',
                    xtype: 'combo',
                    store: userliststore,
                    valueField:'id',
                    displayField:'value',
                    fieldLabel: 'Task Assignmnt',
                    queryMode: 'local',
                    //       selectOnTab: false,
                    name: 'ApproverUserId',
                    //dataIndex: BSSTASKEE, // 'ApproverUserId',
                    value: BSSTASKEE,
                    submitValue : true,
                    //     hiddenName : 'id'
                    //  flex: 1,
                    forceSelection: false
                    //     disabled: true
                },
                {
                  //  id: 'idstart',
                    xtype: 'datefield',
                    fieldLabel: 'Start',
                    name: 'start',
                    dataIndex: 'start',
                    value: BSSStarted,
                    disabled: true
                },
                {
                  //  id: 'idcomplete',
                    xtype: 'textfield',
                    fieldLabel: 'Complete',
                    name: 'complete',
                    dataIndex: 'complete',
                    value: BSSCompleted,
                    disabled: true
                }
            ]
        });


        var historyform = gethistorydata(BSSWorkflowId,BSSWorkflowStepId);

        var tabs = Ext.create('Ext.tab.Panel', {
            //  renderTo: 'tabs1',
            width: 450,
            activeTab: 0,
            defaults :{
                bodyPadding: 10
            },
            items: [form, historyform],
            tbar: [
                {text: 'Complete Task', disabled: BSSDisableStep, handler : function() {ProcessTask("APPROVE",BSSWorkflowId,BSSWorkflowStepId);}},
                {text: 'Reject Task',disabled: BSSDisableStep, handler : function() {ProcessTask("REJECT",BSSWorkflowId,BSSWorkflowStepId);}}
            ]
        });

        var win = Ext.create('Ext.window.Window', {
            title: 'Workflow Step Description',
            collapsible: true,
            animCollapse: true,
            maximizable: true,
            width: 600,
            height: 400,
            minWidth: 300,
            minHeight: 200,
            layout: 'fit',
            items: tabs, //form,


            dockedItems: [{
                xtype: 'toolbar',
                dock: 'bottom',
                ui: 'footer',
                layout: {
                    pack: 'center'
                },
                items: [{
                    minWidth: 80,
                    text: 'Save',

                    handler: function(){

                        try{

                            var BSSNewNotification = "";
                            var idactionurlval = "";
                            var BSSNewActionType = "";
                            var idval = Ext.getCmp('idwsform').getForm().findField("id").getValue();
                            var idnameval = Ext.getCmp('idwsform').getForm().findField("name").getValue();
                            var iddescriptionval = Ext.getCmp('idwsform').getForm().findField("description").getValue();
                            var idinstructionsval = Ext.getCmp('idwsform').getForm().findField("instructions").getValue();
                            var idapproveruser = Ext.getCmp('idwsform').getForm().findField("ApproverUserId").getValue();

                            var updSQLString = 'UPDATE AdvWorkflowStep' + BSSInstanceMode + ' SET '
                                + ' name = ' + "'" + idnameval  + "'" + ","
                                + ' description = ' + "'" + iddescriptionval + "'"  + ","
                                + ' Instructions = ' + "'" + idinstructionsval  + "'"  + ","
                                + ' ApproverUserId = ' + "'" + idapproveruser + "'"
                                + ' WHERE stepkey = ' + idval + ' AND WorkflowId = ' + BSSWorkflowId;

                   //     alert(updSQLString);

                        }catch(e){
                            alert(e);
                        }

                        BSSUserId = "0";

                        var xmlHttp = null;
                        xmlHttp = new XMLHttpRequest();
                        xmlHttp.open( "GET", "DBServices/BSSPerformSQLCommand.php?BSSSQLCommand=" + updSQLString + "&userid=" + BSSUserId, false );
                        xmlHttp.send(null);

                       // alert(xmlHttp.responseText);

                    }

                },{
                    minWidth: 80,
                    text: 'Cancel',
                    handler: function(){win.close(); win.destroy(); Ext.getCmp('idwsform').close();}
                }]
            }]



        });

        win.show();


    }catch(e){alert(e.message)}

}

function OpenSubmitForm(WorkflowID, Key, Category){


        var BSSWorkflowStepName;
        BSSWorkflowStepId = Key;

        try{
            xmlHttp = new XMLHttpRequest();
            xmlHttp.open( "GET", "Workflow/BSSGetAdvWorkflowStepData.php?BSSWorkflowId=" + BSSWorkflowId +  "&BSSWorkflowStepId=" +  BSSWorkflowStepId +  "&BSSInstanceMode=" +  BSSFormMode, false );
            xmlHttp.send( null );

      //      alert("Workflow/BSSGetAdvWorkflowStepData.php?BSSWorkflowId=" + BSSWorkflowId +  "&BSSWorkflowStepId=" +  BSSWorkflowStepId +  "&BSSInstanceMode=" +  BSSFormMode);

     //       alert("DATA1: " + BSSFormMode +  xmlHttp.responseText);
            var wsdata =eval('[' + xmlHttp.responseText + ']');

            var BSSID = wsdata[0].id;
            var BSSLOC = wsdata[0].location;
            var BSSName = wsdata[0].name;
            var BSSDescription = wsdata[0].description;
            var BSSCategory = wsdata[0].category;
            var BSSInstructions = wsdata[0].Instructions;
            var BSSTASKEE = parseInt(wsdata[0].ApproverUserId);   // Make sure its int
            var BSSStarted = wsdata[0].Started;
            var BSSCompleted = wsdata[0].Completed;
            var BSSStatus =  wsdata[0].status;

          //  var BSSErrorResult = wsdata[0].ErrorResult;
            //  masterStore.loadData(newdata,false);
        }catch(e)
        {alert("Submit Step Data Get ERROR: " + e.message);
        }

    var BSSStatus =  wsdata[0].status;
    var BSSDisableStep = true;
    if(BSSStatus == 1 || BSSStatus == 2){
        BSSDisableStep = false;  //Enabled if in process or rejected
    }

    // only for instnaces
  //  if(BSSUserId != BSSTASKEE){
  //      BSSDisableStep = true;  // Disable if the user is not the taskee
  //  }

        try{
            var form = Ext.create('Ext.form.Panel', {
                id: 'idwssubmitform',
                plain: false,
                border: 0,
                title: 'Status Detail',
                width: 360,
                bodyPadding: 5,
                url: 'Workflow/BSSSaveWorkflowStep.php',
                fieldDefaults: {
                    labelWidth: 70,
                    anchor: '100%'
                },
                layout: {
                    type: 'vbox',
                    align: 'stretch'  // Child items are stretched to full width
                },
                items: [
                    { //  id: 'id',
                        xtype: 'textfield',
                        fieldLabel: 'id',
                        name: 'id',
                        dataIndex: 'id',
                        value: Key,
                        disabled: true},
                    { //  id: 'idxloc',
                        xtype: 'textfield',
                        fieldLabel: 'Location',
                        name: 'location',
                        dataIndex: 'location',
                        value: BSSLOC, //  valx / 70,
                        disabled: true},
                    {
                      //  id: 'idname',
                        xtype: 'textfield',
                        fieldLabel: 'Name',
                        name: 'name',
                        dataIndex: 'name',
                        value: BSSName
                    },
                    { //  id: 'iddescription',
                        xtype: 'textfield',
                        fieldLabel: 'Description',
                        name: 'description',
                        //         dataIndex: 'description',
                        value: BSSDescription},
                    { //  id: 'iddescription',
                        xtype: 'textfield',
                        fieldLabel: 'Category',
                        name: 'category',
                        dataIndex: 'category',
                        readOnly: true,
                        value: BSSCategory},
                    {
                      //  id: 'idinstructions',
                        xtype: 'textarea',
                        fieldLabel: 'Instructions',
                        hideLabel: false,
                        name: 'instructions',
                        dataIndex: 'instructions',
                        value: BSSInstructions,
                        style: 'margin:0', // Remove default margin
                        flex: 1  // Take up all *remaining* vertical space
                    },

                    {
                     //   id: 'idtaskassignemnt',
                        xtype: 'combo',
                        store: userliststore,
                        valueField:'id',
                        displayField:'value',
                        fieldLabel: 'Submitted To',
                        queryMode: 'local',
                        //       selectOnTab: false,
                        name: 'submittedtouser',
                        //dataIndex: BSSTASKEE, // 'ApproverUserId',
                        value: BSSTASKEE,
                        submitValue : true,
                        //     hiddenName : 'id'
                        //  flex: 1,
                        forceSelection: false
                        //     disabled: true
                    },
                    {
                     //   id: 'idstart',
                        xtype: 'datefield',
                        fieldLabel: 'Start',
                        name: 'start',
                        dataIndex: 'start',
                        value: BSSStarted,
                        disabled: true
                    },
                    {
                     //   id: 'idcomplete',
                        xtype: 'datefield',
                        fieldLabel: 'Complete',
                        name: 'complete',
                        dataIndex: 'complete',
                        value: BSSCompleted,
                        disabled: true
                    }
                ]
            });



            var historyform = gethistorydata(BSSWorkflowId,BSSWorkflowStepId);


            var tabs = Ext.create('Ext.tab.Panel', {
                //renderTo: 'tabs1',
                width: 450,
                activeTab: 0,
                defaults :{
                    bodyPadding: 10
                },
                tbar: [//{text: 'Approve', disabled: BSSSIGNOFF_FLAG, handler : function() {ApproveWorkflow("Workflows");}},
                    //{text: 'Reject', disabled: BSSSIGNOFF_FLAG, handler : function() {RejectWorkflow("Workflows");}},
                    {text: 'Approve Submission', disabled: BSSDisableStep, handler : function() {ProcessSubmission("Approve",BSSWorkflowId,BSSWorkflowStepId);}},
                    {text: 'Reject Submission',disabled: BSSDisableStep, handler : function() {ProcessSubmission("Reject",BSSWorkflowId,BSSWorkflowStepId);}}
                ],
                items: [form, historyform]
            });


            var win = Ext.create('Ext.window.Window', {
                title: 'Workflow Step Description',
                collapsible: true,
                animCollapse: true,
                maximizable: true,
                width: 600,
                height: 400,
                minWidth: 300,
                minHeight: 200,
                layout: 'fit',
                items: tabs,

                dockedItems: [{
                    xtype: 'toolbar',
                    dock: 'bottom',
                    ui: 'footer',
                    layout: {
                        pack: 'center'
                    },
                    items: [{
                        minWidth: 80,
                        text: 'Save',

                        handler: function(){

                            try{

                                var idval = Ext.getCmp('idwssubmitform').getForm().findField("id").getValue();
                                var idnameval = Ext.getCmp('idwssubmitform').getForm().findField("name").getValue();
                                var iddescriptionval = Ext.getCmp('idwssubmitform').getForm().findField("description").getValue();
                                var idinstructionsval = Ext.getCmp('idwssubmitform').getForm().findField("instructions").getValue();
                                var idapproveruser = Ext.getCmp('idwssubmitform').getForm().findField("submittedtouser").getValue();
                                //alert(idinstructionsval);

                                var updSQLString = 'UPDATE AdvWorkflowStep' + BSSFormMode + ' SET '
                                        + ' name = ' + "'" + idnameval  + "'" + ","
                                        + ' description = ' + "'" + iddescriptionval + "'"  + ","
                                        + ' Instructions = ' + "'" + idinstructionsval  + "'"  + ","
                                        + ' ApproverUserId = ' + "'" + idapproveruser + "'"
                                        + ' WHERE stepkey = ' + idval + ' AND WorkflowId = ' + BSSWorkflowId;

                                       //alert(updSQLString);

                                var xmlHttp = null;
                                xmlHttp = new XMLHttpRequest();
                                xmlHttp.open( "GET", "DBServices/BSSPerformSQLCommand.php?BSSSQLCommand=" + updSQLString + "&userid=" + BSSUserId, false );
                                xmlHttp.send(null);

                                //alert(xmlHttp.responseText);

                            }catch(e){
                                alert(e);
                            }

                        }

                    },{
                        minWidth: 80,
                        text: 'Cancel',
                        handler: function(){win.close(); win.destroy(); Ext.getCmp('idwsform').close();}
                    }]
                }]



            });

            win.show();

        }catch(e){alert(e.message)}

 }


function gethistorydata(BSSWorkflowId,BSSWorkflowStepId){


     var historyStore = Ext.create('Ext.data.Store', {
     fields: [
     {name: 'id', type: 'string'},
     {name: 'masterid', type: 'string'},
     {name: 'sequence', type: 'string'},
     {name: 'historyuser', type: 'string'},
     {name: 'historydate', type: 'date'},
     {name: 'historytext', type: 'string'}
     ],
     data:
     [['1','','','','','']]
     });

     //if(BSSVIEWHISTORY_FLAG = false){return;}

     try{
     //Get the history data
     xmlHttp = new XMLHttpRequest();
     xmlHttp.open( "GET", "DBServices/BSSGetJSData.php?BSSConfigName=History&BSSWhereClause=workflowid="+ BSSWorkflowId + " AND stepkey = '" + BSSWorkflowStepId + "' ORDER BY id DESC",false);
     xmlHttp.send( null );

     var newdata1 = eval('[' + xmlHttp.responseText + ']');
     historyStore.loadData(newdata1,false);

     var cellEditing = Ext.create('Ext.grid.plugin.CellEditing', {
     clicksToEdit: 1
     });

     var historyform = Ext.create('Ext.grid.Panel', {
     name: 'historygrid',
     store: historyStore,
     selModel: 'cellmodel',
     columns: [
     {name: 'idhist',
     header: 'Id',
     disabled: true,
     listeners: {
     beforeedit: function(){
     return false;
     }},
     width: 20,
     dataIndex: 'id',
     editor: {
     allowBlank: false
     }
     },
     {name: 'masteridhist',
     header: 'Id',
     disabled: true,
     listeners: {
     beforeedit: function(){
     return false;
     }},
     width: 20,
     dataIndex: 'masterid',
     editor: {
     allowBlank: false
     }
     },{name: 'sequencehist',
     header: 'Id',
     disabled: true,
     listeners: {
     beforeedit: function(){
     return false;
     }},
     width: 20,
     dataIndex: 'sequence',
     editor: {
     allowBlank: false
     }
     },

     {name: 'idHistoryUser',
     header: 'History User',
     disabled: false,
     width: 180,
     dataIndex: 'historyuser',
     editor:
     { xtype: 'combobox',
     typeAhead: true,
     selectOnTab: true,
     disabled: true,
     triggerAction: 'all',
     fields:['id','value'],
     store: userliststore, //[[1, 'GLOBAL'],[2, 'USER']],
     valueField:'id',
     displayField:'value',
     multiSelect: false,
     queryMode: 'local',
     lazyRender: true,
     listClass: 'x-combo-list-small'},
     renderer: function(val) {var matching =  userliststore.queryBy( function(rec){ return rec.data.id == val; }); return (matching.items[0]) ? matching.items[0].data.value : ''}
     },


     {name: 'idhistorydate',
     header: 'Date',
     width: 240,
     editable: false,
     dataIndex: 'historydate',
     editor: {
     allowBlank: true
     }
     },
     {name: 'idHistoryText',
     header: 'History Text',
     disabled: false,
     width: 500,
     dataIndex: 'historytext',
     editor: {
     allowBlank: false
     }
     }],
     width: 960,
     height: 300,
     x: 0,
     y: 0,
     title: 'History',
     frame: true,
     plugins: [cellEditing]
     });

     return historyform;

     }catch(e)
     {alert("History Form Creation Error: " + e.message);
     }







}






function ProcessSubmission(BSSApprovalType,BSSWorkflowId,BSSWorkflowStepId)
    {

        alert("In PRocess Submission 55" + BSSFormMode);

        alert("In PRocess Submission 55" + BSSInstanceMode);

        if(BSSApprovalType == 'Approve'){
        var updSQLString = 'UPDATE AdvWorkflowStep' + BSSInstanceMode + ' SET '
                + ' Completed = CURDATE(), status = 2'
                + ' WHERE stepkey = ' + BSSWorkflowStepId + ' AND WorkflowId = ' + BSSWorkflowId;
        }


        if(BSSApprovalType == 'Reject'){
            var updSQLString = 'UPDATE AdvWorkflowStep' + BSSInstanceMode + ' SET '
                    + ' Completed = null, status = 3'
                    + ' WHERE stepkey = ' + BSSWorkflowStepId + ' AND WorkflowId = ' + BSSWorkflowId;
        }

        alert(updSQLString);

        var xmlHttp = null;
        xmlHttp = new XMLHttpRequest();
        xmlHttp.open( "GET", "DBServices/BSSPerformSQLCommand.php?BSSSQLCommand=" + updSQLString + "&userid=" + BSSUserId, false );
        xmlHttp.send(null);

        var txtResult = xmlHttp.responseText;

       // alert(txtResult);

        if(txtResult.length > 0){
        TestWorkflow(BSSWorkflowId);
    }
    }

function OpenActionForm(WorkflowID, Key, Category){

    var BSSWorkflowStepName;
    BSSWorkflowStepId = Key;

    alert(BSSFormMode);

    try{
        xmlHttp = new XMLHttpRequest();
        xmlHttp.open( "GET", "Workflow/BSSGetAdvWorkflowStepData.php?BSSWorkflowId= " + BSSWorkflowId +  "&BSSWorkflowStepId=" +  BSSWorkflowStepId + "&BSSInstanceMode=" + BSSFormMode, false );
        xmlHttp.send( null );


        alert("URL: " + "Workflow/BSSGetAdvWorkflowStepData.php?BSSWorkflowId= " + BSSWorkflowId +  "&BSSWorkflowStepId=" +  BSSWorkflowStepId + "&BSSInstanceMode=" + BSSFormMode);

        alert("DATA: " + xmlHttp.responseText);
        var wsdata =eval('[' + xmlHttp.responseText + ']');



        var BSSID = wsdata[0].id;
        var BSSLOC = wsdata[0].location;
        var BSSName = wsdata[0].name;
        var BSSDescription = wsdata[0].description;
        var BSSCategory = wsdata[0].category;
        var BSSActionURL = wsdata[0].ActionURL;
        var BSSInstructions = wsdata[0].Instructions;
        var BSSStarted = wsdata[0].Started;
        var BSSCompleted = wsdata[0].Completed;
        var BSSErrorResult = wsdata[0].ErrorResult;

        //  masterStore.loadData(newdata,false);
    }catch(e)
    {alert("Master Data Get ERROR: " + e.message);
    }

    try{

        var form = Ext.create('Ext.form.Panel', {
            id: 'idwsactionform',
            plain: false,
            border: 0,
            title: 'Status Detail',
            width: 360,
            bodyPadding: 5,
            url: 'BSSSaveWorkflowStep.php',
            fieldDefaults: {
                labelWidth: 70,
                anchor: '100%'
            },
            layout: {
                type: 'vbox',
                align: 'stretch'  // Child items are stretched to full width
            },
            items: [
                {   //id: 'id',
                    xtype: 'textfield',
                    fieldLabel: 'id',
                    name: 'id',
                    dataIndex: 'id',
                    value: Key,
                    disabled: true},
                {   //id: 'idxloc',
                    xtype: 'textfield',
                    fieldLabel: 'Location',
                    name: 'location',
                    dataIndex: 'location',
                    value: BSSLOC, //  valx / 70,
                    disabled: true},
                {
                   // id: 'idname',
                    xtype: 'textfield',
                    fieldLabel: 'Name',
                    name: 'name',
                    dataIndex: 'name',
                    value: BSSName
                },
                {   //id: 'iddescription',
                    xtype: 'textfield',
                    fieldLabel: 'Description',
                    name: 'description',
                    //         dataIndex: 'description',
                    value: BSSDescription},


                { //  id: 'iddescription',
                    xtype: 'textfield',
                    fieldLabel: 'Category',
                    name: 'category',
                    dataIndex: 'category',
                    readOnly: true,
                    value: BSSCategory},

                  /*
                {   id: 'idstatustype',
                    xtype: 'combo',
                    //  store: bssWorkflowStatusListStore,
                    valueField:'id',
                    displayField:'value',
                    fieldLabel: 'Status Type',
                    queryMode: 'local',
                    //       selectOnTab: false,
                    name: 'statustype',
                    //dataIndex: 'statustype',
                    displayValue: 'Task',
                    submitValue : true,
                    //     hiddenName : 'id'
                    //  flex: 1,
                    forceSelection: false
                    //     disabled: true
                  },
                    */
                  {
                    //  id: 'idactionurl',
                      xtype: 'textfield',
                      fieldLabel: 'Action URL',
                      name: 'actionurl',
                      dataIndex: 'ActionURL',
                      value: BSSActionURL

                  },
                  {
                  //  id: 'idinstructions',
                    xtype: 'textarea',
                    fieldLabel: 'Notes',
                    hideLabel: false,
                    name: 'instructions',
                    dataIndex: 'instructions',
                    value: BSSInstructions,
                    style: 'margin:0', // Remove default margin
                    flex: 1  // Take up all *remaining* vertical space
                }

            ]
        });

        var formprocessresult = Ext.create('Ext.form.Panel', {
            id: 'idwsformh',
            plain: false,
            border: 0,
            title: 'Process Result',
            width: 290,
            bodyPadding: 5,
            url: 'Workflow/BSSSaveWorkflowStep.php',

            fieldDefaults: {
                labelWidth: 70,
                anchor: '100%'
            },

            layout: {
                type: 'vbox',
                align: 'stretch'  // Child items are stretched to full width
            },


            items: [
                {id: 'idstart',
                 xtype: 'datefield',
                 fieldLabel: 'Start',
                 name: 'start',
                 dataIndex: 'start',
                 value: BSSStarted,
                 disabled: true},
                {id: 'idcomplete',
                xtype: 'datefield',
                fieldLabel: 'Complete',
                name: 'complete',
                dataIndex: 'complete',
                value: BSSCompleted,
                disabled: true},
                {
                    id: 'iderrorresult',
                    xtype: 'textarea',
                    fieldLabel: 'Error Result',
                    hideLabel: false,
                    name: 'errorresult',
                    dataIndex: 'errorresult',
                    value: BSSErrorResult,
                    style: 'margin:0', // Remove default margin
                    flex: 1  // Take up all *remaining* vertical space
                }
            ]
        });

        var historyform = gethistorydata(BSSWorkflowId,BSSWorkflowStepId);

        var tabs = Ext.create('Ext.tab.Panel', {
            //  renderTo: 'tabs1',
            width: 450,
            activeTab: 0,
            defaults :{
                bodyPadding: 10
            },
            items: [form, formprocessresult, historyform]
        });


        var win = Ext.create('Ext.window.Window', {
            title: 'Workflow Step Description',
            collapsible: true,
            animCollapse: true,
            maximizable: true,
            width: 600,
            height: 400,
            minWidth: 300,
            minHeight: 200,
            layout: 'fit',
            items: tabs, //form,


            dockedItems: [{
                xtype: 'toolbar',
                dock: 'bottom',
                ui: 'footer',
                layout: {
                    pack: 'center'
                },
                items: [{
                    minWidth: 80,
                    text: 'Save',

                    handler: function(){

                        try{
                            var idval = Ext.getCmp('idwsactionform').getForm().findField("id").getValue();
                            var idnameval = Ext.getCmp('idwsactionform').getForm().findField("name").getValue();
                            var iddescriptionval = Ext.getCmp('idwsactionform').getForm().findField("description").getValue();
                            var idactionurlval = Ext.getCmp('idwsactionform').getForm().findField("actionurl").getValue();
                            var idinstructionsval = Ext.getCmp('idwsactionform').getForm().findField("instructions").getValue();


                            var updSQLString = 'UPDATE AdvWorkflowStep' + BSSInstanceMode + ' SET '
                                    + ' name = ' + "'" + idnameval  + "'" + ","
                                    + ' description = ' + "'" + iddescriptionval + "'"  + ","
                                    + ' Instructions = ' + "'" + idinstructionsval  + "'"  + ","
                                    + ' ActionURL = ' + "'" + idactionurlval + "'"
                                    + ' WHERE stepkey = ' + idval + ' AND WorkflowId = ' + BSSWorkflowId;

                            //       alert(updSQLString);

                            var xmlHttp = null;
                            xmlHttp = new XMLHttpRequest();
                            xmlHttp.open( "GET", "DBServices/BSSPerformSQLCommand.php?BSSSQLCommand=" + updSQLString + "&userid=" + BSSUserId, false );
                            xmlHttp.send(null);

                            // alert(xmlHttp.responseText);


                        }catch(e){
                            alert(e);
                        }



                    }

                },{
                    minWidth: 80,
                    text: 'Cancel',
                    handler: function(){win.close(); win.destroy(); Ext.getCmp('idwsform').close();}
                }]
            }]



        });

        win.show();


    }catch(e){alert(e.message)}










}




function OpenNotificationForm(WorkflowID, Key, Category){

        var BSSWorkflowStepName;
        BSSWorkflowStepId = Key;
        try{
            //Get the data
            xmlHttp = new XMLHttpRequest();
            xmlHttp.open( "GET", "Workflow/BSSGetAdvWorkflowStepData.php?BSSWorkflowId= " + BSSWorkflowId +  "&BSSWorkflowStepId=" +  BSSWorkflowStepId + "&BSSInstanceMode=" + BSSInstanceMode, false );
            xmlHttp.send( null );
          //  alert("DATA: " + xmlHttp.responseText);
            var wsdata =eval('[' + xmlHttp.responseText + ']');


            /*
             alert(wsdata[0].id);
             alert(wsdata[0].ActionURL);
             alert(wsdata[0].xloc);
             alert(wsdata[0].yloc);
             alert(wsdata[0].ActionType);
             alert(wsdata[0].statustype);
             alert(wsdata[0].Notification);
             alert(wsdata[0].Revision);
             alert(wsdata[0].Started);
             alert(wsdata[0].Completed);
             alert(wsdata[0].Instructions);
             alert(wsdata[0].ErrorResult);
             alert(wsdata[0].name);
             alert(wsdata[0].description);


             {id:1, value: 'Pending'},
             {id:2, value: 'Submit'},
             {id:3, value: 'Review'},
             {id:4, value: 'Release'},
             {id:5, value: 'Complete'},
             {id:6, value: 'Notify'},
             {id:7, value: 'Action'}
             */


            var BSSID = wsdata[0].id;
            var BSSLOC = wsdata[0].location;

            var BSSActionURL = wsdata[0].ActionURL;
            var BSSStarted = wsdata[0].Started;
            var BSSCompleted = wsdata[0].Completed;
            var BSSInstructions = wsdata[0].Instructions;
            var BSSErrorResult = wsdata[0].ErrorResult;
            var BSSName = wsdata[0].name;
            var BSSDescription = wsdata[0].description;
            var BSSCategory = wsdata[0].category;

            //  masterStore.loadData(newdata,false);
        }catch(e)
        {alert("Master Data Get ERROR: " + e.message);
        }



    //        {name: 'id', type: 'string'},
    //        {name: 'masterid', type: 'string'},
    //        {name: 'sequence', type: 'string'},
    //        {name: 'WorkflowApprover', type: 'string'},
    //        {name: 'SignoffDate', type: 'date'},
    //        {name: 'SignoffResult', type: 'string'},
    //        {name: 'Comments', type: 'string'}


        try{

            var signoffs = Ext.create('Ext.grid.Panel', {
                id: 'signoffgrid',
                hidden: false,
                store: signoffsStore,
                //    listeners: {itemclick: function() {alert('SSS');}},
                listeners: {activate: function() {GetSignOffs(BSSWorkflowStepId);}},
                selModel: 'cellmodel',
                columns: [
                    {id: 'idsignoff',
                        header: 'Id',
                        disabled: true,
                        listeners: {
                            beforeedit: function(){
                                return false;
                            }},
                        width: 1,
                        dataIndex: 'id',
                        editor: {
                            allowBlank: false
                        }
                    },
                    {id: 'masteridsignoff',
                        header: 'Id',
                        disabled: true,
                        listeners: {
                            beforeedit: function(){
                                return false;
                            }},
                        width: 1,
                        dataIndex: 'masterid',
                        editor: {
                            allowBlank: false
                        }
                    },{id: 'sequenceasignoff',
                        header: 'Id',
                        disabled: true,
                        listeners: {
                            beforeedit: function(){
                                return false;
                            }},
                        width: 1,
                        dataIndex: 'sequence',
                        editor: {
                            allowBlank: false
                        }
                    },
                    {id: 'idWorkflowApprover',
                        header: 'Notification User',
                        disabled: false,
                        width: 180,
                        dataIndex: 'WorkflowApprover',
                        editor:
                        { xtype: 'combobox',
                            typeAhead: true,
                            selectOnTab: true,
                            triggerAction: 'all',
                            fields:['id','value'],
                            store: userliststore, //[[1, 'GLOBAL'],[2, 'USER']],
                            valueField:'id',
                            displayField:'value',
                            multiSelect: false,
                            queryMode: 'local',
                            lazyRender: true,
                            listClass: 'x-combo-list-small'},
                        renderer: function(val) {var matching =  userliststore.queryBy( function(rec){ return rec.data.id == val; }); return (matching.items[0]) ? matching.items[0].data.value : ''}
                    },

                    {id: 'idSignoffDate',
                        header: 'Signoff Date',
                        disabled: false,
                        width: 100,
                        dataIndex: 'SignoffDate',
                        editor: {
                            allowBlank: false
                        }
                    }

                        /*
                    ,

                    {id: 'idSignoffResult',
                        header: 'Signoff Result',
                        disabled: false,
                        width: 100,
                        dataIndex: 'SignoffResult',
                        editor:
                        { xtype: 'combobox',
                            typeAhead: true,
                            selectOnTab: true,
                            triggerAction: 'all',
                            fields:['id','value'],
                            store: workflowapprovalstatusliststore, //[[1, 'GLOBAL'],[2, 'USER']],
                            valueField:'id',
                            displayField:'value',
                            multiSelect: false,
                            queryMode: 'local',
                            lazyRender: true,
                            listClass: 'x-combo-list-small'},
                        renderer: function(val) {var matching =  workflowapprovalstatusliststore.queryBy( function(rec){ return rec.data.id == val; }); return (matching.items[0]) ? matching.items[0].data.value : ''}


                    },
                    {id: 'idComments',
                        header: 'Comments',
                        disabled: false,
                        width: 100,
                        dataIndex: 'Comments',
                        editor: {
                            allowBlank: false
                        }
                    }     */
                ],
                width: 350,
                height: 200,
                x: 2,
                y: 2,
                title: 'Notification List',
                frame: true,
                tbar: [
                    {text: 'Add Notification', disabled: BSSADDREMOVEAPPROVERS, handler : function() {AddApprovers(signoffs,BSSWorkflowStepId);}},
                    {text: 'Remove Notification',disabled: BSSADDREMOVEAPPROVERS, handler : function() {removeApprovers(signoffs,BSSWorkflowStepId);}}
                ],
                plugins: [cellEditing6]
            });




            //     alert(BSSISACTION);

            //       alert(BSSISNOTIFICATION);

            var form = Ext.create('Ext.form.Panel', {
                id: 'idwsform',
                plain: false,
                border: 0,
                title: 'Status Detail',
                width: 360,
                bodyPadding: 5,
                url: 'BSSSaveWorkflowStep.php',

                fieldDefaults: {
                    labelWidth: 70,
                    anchor: '100%'
                },

                layout: {
                    type: 'vbox',
                    align: 'stretch'  // Child items are stretched to full width
                },


                items: [
                    {
                        id: 'id',
                        xtype: 'textfield',
                        fieldLabel: 'id',
                        name: 'id',
                        dataIndex: 'id',
                        value: Key,
                        disabled: true
                    },
                    {
                        id: 'idxloc',
                        xtype: 'textfield',
                        fieldLabel: 'Location',
                        name: 'location',
                        dataIndex: 'location',
                        value: BSSLOC, //  valx / 70,
                        disabled: true
                    },

                    {
                        id: 'idname',
                        xtype: 'textfield',
                        fieldLabel: 'Name',
                        name: 'name',
                        dataIndex: 'name',
                        value: BSSName
                    },
                    {
                        id: 'idsubject',
                        xtype: 'textfield',
                        fieldLabel: 'Subject',
                        name: 'description',
                        //         dataIndex: 'description',
                        value: BSSDescription
                    },
                    {
                        id: 'idfrevision',
                        name: 'txtrevision',
                        xtype: 'textfield',
                        fieldLabel: 'Revision',
                        dataIndex: 'revision',
                        hidden: true,
                        value: ''
                    },
                    { //  id: 'iddescription',
                        xtype: 'textfield',
                        fieldLabel: 'Category',
                        name: 'category',
                        dataIndex: 'category',
                        readOnly: true,
                        value: BSSCategory},
                    {
                        id: 'idactontype',
                        hidden: true,
                        xtype: 'combo',
                        store: bssWorkflowActionTypeStore,
                        valueField:'id',
                        displayField:'value',
                        fieldLabel: 'Action Type',
                        queryMode: 'local',
                        selectOnTab: false,
                        name: 'actiontype',
                        dataIndex: 'ActionType'
                        //          value: BSSActionTypeValue
                    },
        //            {
        //                id: 'idnotification',
        //                hidden: BSSISNOTIFICATION,
        //                xtype: 'combo',
        //                store: bssWorkflowNotificationListStore,
        //                valueField:'id',
        //                displayField:'value',
        //                fieldLabel: 'Notification',
        //                queryMode: 'local',
        //                selectOnTab: false,
        //                name: 'notification',
        //                dataIndex: 'notification'
        //                //   value: BSSNotificationValue
        //            },
                    {
                        id: 'idactionurl',
                        hidden: false,
                        xtype: 'textfield',
                        fieldLabel: 'MSG GEN URL',
                        name: 'ActionURL',
                        dataIndex: 'ActionURL',
                        value: BSSActionURL

                    },
                    {
                        id: 'idinstructions',
                        xtype: 'textarea',
                        fieldLabel: 'Body',
                        hideLabel: false,
                        name: 'instructions',
                        dataIndex: 'instructions',
                        value: BSSInstructions,
                        style: 'margin:0', // Remove default margin
                        flex: 1  // Take up all *remaining* vertical space
                    }

                ]
            });



            var form1 = Ext.create('Ext.form.Panel', {
                id: 'idwsformh',
                plain: false,
                border: 0,
                title: 'Process Result',
                width: 290,
                bodyPadding: 5,
                url: 'Workflow/BSSSaveWorkflowStep.php',

                fieldDefaults: {
                    labelWidth: 70,
                    anchor: '100%'
                },

                layout: {
                    type: 'vbox',
                    align: 'stretch'  // Child items are stretched to full width
                },


                items: [

                    {
                        id: 'idstart',
                        xtype: 'datefield',
                        fieldLabel: 'Start',
                        name: 'start',
                        dataIndex: 'start',
                        value: BSSStarted,
                        disabled: true
                    },
                    {
                        id: 'idcomplete',
                        xtype: 'datefield',
                        fieldLabel: 'Complete',
                        name: 'complete',
                        dataIndex: 'complete',
                        value: BSSCompleted,
                        disabled: true
                    },
                    {
                        id: 'iderrorresult',
                        xtype: 'textarea',
                        fieldLabel: 'Error Result',
                        hideLabel: false,
                        name: 'errorresult',
                        dataIndex: 'errorresult',
                        value: BSSErrorResult,
                        style: 'margin:0', // Remove default margin
                        flex: 1  // Take up all *remaining* vertical space
                    }
                ]
            });


            var historyform = gethistorydata(BSSWorkflowId,BSSWorkflowStepId);

            var tabs = Ext.create('Ext.tab.Panel', {
                //  renderTo: 'tabs1',
                width: 450,
                activeTab: 0,
                defaults :{
                    bodyPadding: 10
                },
                items: [form, form1, signoffs, historyform]
            });


            var win = Ext.create('Ext.window.Window', {
                title: 'Workflow Step Description',
                collapsible: true,
                animCollapse: true,
                maximizable: true,
                width: 600,
                height: 400,
                minWidth: 300,
                minHeight: 200,
                layout: 'fit',
                items: tabs, //form,


                dockedItems: [{
                    xtype: 'toolbar',
                    dock: 'bottom',
                    ui: 'footer',
                    layout: {
                        pack: 'center'
                    },
                    items: [{
                        minWidth: 80,
                        text: 'Save',

                        handler: function(){

                            var idval = Ext.getCmp('idwsform').getForm().findField("id").getValue();
                            var idnameval = Ext.getCmp('idwsform').getForm().findField("idname").getValue();
                            var iddescriptionval = Ext.getCmp('idwsform').getForm().findField("idsubject").getValue();
                            var idinstructionsval = Ext.getCmp('idwsform').getForm().findField("idinstructions").getValue();
                            var idactionurlval = Ext.getCmp('idwsform').getForm().findField("idactionurl").getValue();

                            var updSQLString = 'UPDATE AdvWorkflowStep' + BSSInstanceMode +' SET '
                                    + ' name = ' + "'" + idnameval  + "'" + ","
                                    + ' description = ' + "'" + iddescriptionval + "'"  + ","
                                    + ' ActionURL = ' + "'" + idactionurlval  + "'"  + ","
                                    + ' Instructions = ' + "'" + idinstructionsval  + "'"
                                    + ' WHERE stepkey = ' + "'" + idval + "'"
                                    + ' AND workflowid = ' + "'" + BSSWorkflowId + "'";

                         //   alert(updSQLString);

                            var xmlHttp = null;
                            xmlHttp = new XMLHttpRequest();
                            xmlHttp.open( "GET", "DBServices/BSSPerformSQLCommand.php?BSSSQLCommand=" + updSQLString + "&userid=" + BSSUserId, false );
                            xmlHttp.send(null);

                            //alert(xmlHttp.responseText);

                        }



                    },{
                        minWidth: 80,
                        text: 'Cancel',
                        handler: function(){win.close(); win.destroy(); Ext.getCmp('idwsform').close();}
                    }]
                }]



            });

            win.show();

        }catch(e){alert(e.message)}


    }

function OpenRejectForm(WorkflowID, Key, Category){

    var BSSWorkflowStepName;
    BSSWorkflowStepId = Key;
    try{
        //Get the data
        xmlHttp = new XMLHttpRequest();
        xmlHttp.open( "GET", "Workflow/BSSGetAdvWorkflowStepData.php?BSSWorkflowId= " + BSSWorkflowId +  "&BSSWorkflowStepId=" +  BSSWorkflowStepId + "&BSSInstanceMode=" + BSSFormMode, false );
        xmlHttp.send( null );
        //  alert("DATA: " + xmlHttp.responseText);
        var wsdata =eval('[' + xmlHttp.responseText + ']');


        /*
         alert(wsdata[0].id);
         alert(wsdata[0].ActionURL);
         alert(wsdata[0].xloc);
         alert(wsdata[0].yloc);
         alert(wsdata[0].ActionType);
         alert(wsdata[0].statustype);
         alert(wsdata[0].Notification);
         alert(wsdata[0].Revision);
         alert(wsdata[0].Started);
         alert(wsdata[0].Completed);
         alert(wsdata[0].Instructions);
         alert(wsdata[0].ErrorResult);
         alert(wsdata[0].name);
         alert(wsdata[0].description);


         {id:1, value: 'Pending'},
         {id:2, value: 'Submit'},
         {id:3, value: 'Review'},
         {id:4, value: 'Release'},
         {id:5, value: 'Complete'},
         {id:6, value: 'Notify'},
         {id:7, value: 'Action'}
         */


        var BSSID = wsdata[0].id;
        var BSSLOC = wsdata[0].location;

        var BSSActionURL = wsdata[0].ActionURL;
        var BSSStarted = wsdata[0].Started;
        var BSSCompleted = wsdata[0].Completed;
        var BSSInstructions = wsdata[0].Instructions;
        var BSSErrorResult = wsdata[0].ErrorResult;
        var BSSName = wsdata[0].name;
        var BSSDescription = wsdata[0].description;
        var BSSCategory = wsdata[0].category;

        var BSSRejectActionURL = wsdata[0].RejectURL;


        //  masterStore.loadData(newdata,false);
    }catch(e)
    {alert("Master Data Get ERROR: " + e.message);
    }



    //        {name: 'id', type: 'string'},
    //        {name: 'masterid', type: 'string'},
    //        {name: 'sequence', type: 'string'},
    //        {name: 'WorkflowApprover', type: 'string'},
    //        {name: 'SignoffDate', type: 'date'},
    //        {name: 'SignoffResult', type: 'string'},
    //        {name: 'Comments', type: 'string'}


    try{

        var signoffs = Ext.create('Ext.grid.Panel', {
            id: 'signoffgrid',
            hidden: false,
            store: signoffsStore,
            //    listeners: {itemclick: function() {alert('SSS');}},
            listeners: {activate: function() {GetSignOffs(BSSWorkflowStepId);}},
            selModel: 'cellmodel',
            columns: [
                {id: 'idsignoff',
                    header: 'Id',
                    disabled: true,
                    listeners: {
                        beforeedit: function(){
                            return false;
                        }},
                    width: 1,
                    dataIndex: 'id',
                    editor: {
                        allowBlank: false
                    }
                },
                {id: 'masteridsignoff',
                    header: 'Id',
                    disabled: true,
                    listeners: {
                        beforeedit: function(){
                            return false;
                        }},
                    width: 1,
                    dataIndex: 'masterid',
                    editor: {
                        allowBlank: false
                    }
                },{id: 'sequenceasignoff',
                    header: 'Id',
                    disabled: true,
                    listeners: {
                        beforeedit: function(){
                            return false;
                        }},
                    width: 1,
                    dataIndex: 'sequence',
                    editor: {
                        allowBlank: false
                    }
                },
                {id: 'idWorkflowApprover',
                    header: 'Notification User',
                    disabled: false,
                    width: 180,
                    dataIndex: 'WorkflowApprover',
                    editor:
                    { xtype: 'combobox',
                        typeAhead: true,
                        selectOnTab: true,
                        triggerAction: 'all',
                        fields:['id','value'],
                        store: userliststore, //[[1, 'GLOBAL'],[2, 'USER']],
                        valueField:'id',
                        displayField:'value',
                        multiSelect: false,
                        queryMode: 'local',
                        lazyRender: true,
                        listClass: 'x-combo-list-small'},
                    renderer: function(val) {var matching =  userliststore.queryBy( function(rec){ return rec.data.id == val; }); return (matching.items[0]) ? matching.items[0].data.value : ''}
                },

                {id: 'idSignoffDate',
                    header: 'Signoff Date',
                    disabled: false,
                    width: 100,
                    dataIndex: 'SignoffDate',
                    editor: {
                        allowBlank: false
                    }
                },

                {id: 'idSignoffResult',
                    header: 'Signoff Result',
                    disabled: false,
                    hidden: true,
                    width: 100,
                    dataIndex: 'SignoffResult',
                    editor:
                    { xtype: 'combobox',
                        typeAhead: true,
                        selectOnTab: true,
                        triggerAction: 'all',
                        fields:['id','value'],
                        store: workflowapprovalstatusliststore, //[[1, 'GLOBAL'],[2, 'USER']],
                        valueField:'id',
                        displayField:'value',
                        multiSelect: false,
                        queryMode: 'local',
                        lazyRender: true,
                        listClass: 'x-combo-list-small'},
                    renderer: function(val) {var matching =  workflowapprovalstatusliststore.queryBy( function(rec){ return rec.data.id == val; }); return (matching.items[0]) ? matching.items[0].data.value : ''}


                },
                {id: 'idComments',
                    header: 'Comments',
                    disabled: false,
                    hidden: true,
                    width: 100,
                    dataIndex: 'Comments',
                    editor: {
                        allowBlank: false
                    }
                }],
            width: 350,
            height: 200,
            x: 2,
            y: 2,
            title: 'Notification List',
            frame: true,
            tbar: [
                {text: 'Add Notification', disabled: BSSADDREMOVEAPPROVERS, handler : function() {AddApprovers(signoffs,BSSWorkflowStepId);}},
                {text: 'Remove Notification',disabled: BSSADDREMOVEAPPROVERS, handler : function() {removeApprovers(signoffs,BSSWorkflowStepId);}}
            ],
            plugins: [cellEditing6]
        });




        //     alert(BSSISACTION);

        //       alert(BSSISNOTIFICATION);

        var form = Ext.create('Ext.form.Panel', {
            id: 'idwsform',
            plain: false,
            border: 0,
            title: 'Status Detail',
            width: 360,
            bodyPadding: 5,
            url: 'Workflow/BSSSaveWorkflowStep.php',

            fieldDefaults: {
                labelWidth: 70,
                anchor: '100%'
            },

            layout: {
                type: 'vbox',
                align: 'stretch'  // Child items are stretched to full width
            },


            items: [
                {
                    id: 'id',
                    xtype: 'textfield',
                    fieldLabel: 'id',
                    name: 'id',
                    dataIndex: 'id',
                    value: Key,
                    disabled: true
                },
                {
                    id: 'idxloc',
                    xtype: 'textfield',
                    fieldLabel: 'Location',
                    name: 'location',
                    dataIndex: 'location',
                    value: BSSLOC, //  valx / 70,
                    disabled: true
                },

                {
                    id: 'idname',
                    xtype: 'textfield',
                    fieldLabel: 'Name',
                    name: 'name',
                    dataIndex: 'name',
                    value: BSSName
                },
                {
                    id: 'idsubject',
                    xtype: 'textfield',
                    fieldLabel: 'Subject',
                    name: 'description',
                    //         dataIndex: 'description',
                    value: BSSDescription
                },
                {
                    id: 'idfrevision',
                    name: 'txtrevision',
                    xtype: 'textfield',
                    fieldLabel: 'Revision',
                    dataIndex: 'revision',
                    hidden: true,
                    value: ''
                },
                { //  id: 'iddescription',
                    xtype: 'textfield',
                    fieldLabel: 'Category',
                    name: 'category',
                    dataIndex: 'category',
                    readOnly: true,
                    value: BSSCategory},
                {
                    id: 'idactontype',
                    hidden: true,
                    xtype: 'combo',
                    store: bssWorkflowActionTypeStore,
                    valueField:'id',
                    displayField:'value',
                    fieldLabel: 'Action Type',
                    queryMode: 'local',
                    selectOnTab: false,
                    name: 'actiontype',
                    dataIndex: 'ActionType'
                    //          value: BSSActionTypeValue
                },
                //            {
                //                id: 'idnotification',
                //                hidden: BSSISNOTIFICATION,
                //                xtype: 'combo',
                //                store: bssWorkflowNotificationListStore,
                //                valueField:'id',
                //                displayField:'value',
                //                fieldLabel: 'Notification',
                //                queryMode: 'local',
                //                selectOnTab: false,
                //                name: 'notification',
                //                dataIndex: 'notification'
                //                //   value: BSSNotificationValue
                //            },
                {
                    id: 'idactionurl',
                    hidden: false,
                    xtype: 'textfield',
                    fieldLabel: 'MSG GEN URL',
                    name: 'ActionURL',
                    dataIndex: 'ActionURL',
                    value: BSSActionURL

                },
                {
                    id: 'idrejectactionurl',
                    hidden: false,
                    xtype: 'textfield',
                    fieldLabel: 'Reject Action URL',
                    name: 'RejectActionURL',
                    dataIndex: 'RejectActionURL',
                    value: BSSRejectActionURL

                },
                {
                    id: 'idinstructions',
                    xtype: 'textarea',
                    fieldLabel: 'Body',
                    hideLabel: false,
                    name: 'instructions',
                    dataIndex: 'instructions',
                    value: BSSInstructions,
                    style: 'margin:0', // Remove default margin
                    flex: 1  // Take up all *remaining* vertical space
                }

            ]
        });



        var form1 = Ext.create('Ext.form.Panel', {
            id: 'idwsformh',
            plain: false,
            border: 0,
            title: 'Process Result',
            width: 290,
            bodyPadding: 5,
            url: 'BSSSaveWorkflowStep.php',

            fieldDefaults: {
                labelWidth: 70,
                anchor: '100%'
            },

            layout: {
                type: 'vbox',
                align: 'stretch'  // Child items are stretched to full width
            },


            items: [

                {
                    id: 'idstart',
                    xtype: 'datefield',
                    fieldLabel: 'Start',
                    name: 'start',
                    dataIndex: 'start',
                    value: BSSStarted,
                    disabled: true
                },
                {
                    id: 'idcomplete',
                    xtype: 'datefield',
                    fieldLabel: 'Complete',
                    name: 'complete',
                    dataIndex: 'complete',
                    value: BSSCompleted,
                    disabled: true
                },
                {
                    id: 'iderrorresult',
                    xtype: 'textarea',
                    fieldLabel: 'Error Result',
                    hideLabel: false,
                    name: 'errorresult',
                    dataIndex: 'errorresult',
                    value: BSSErrorResult,
                    style: 'margin:0', // Remove default margin
                    flex: 1  // Take up all *remaining* vertical space
                }
            ]
        });


        var historyform = gethistorydata(BSSWorkflowId,BSSWorkflowStepId);

        var tabs = Ext.create('Ext.tab.Panel', {
            //  renderTo: 'tabs1',
            width: 450,
            activeTab: 0,
            defaults :{
                bodyPadding: 10
            },
            items: [form, form1, signoffs, historyform]
        });


        var win = Ext.create('Ext.window.Window', {
            title: 'Workflow Step Description',
            collapsible: true,
            animCollapse: true,
            maximizable: true,
            width: 600,
            height: 400,
            minWidth: 300,
            minHeight: 200,
            layout: 'fit',
            items: tabs, //form,


            dockedItems: [{
                xtype: 'toolbar',
                dock: 'bottom',
                ui: 'footer',
                layout: {
                    pack: 'center'
                },
                items: [{
                    minWidth: 80,
                    text: 'Save',

                    handler: function(){

                        var idval = Ext.getCmp('idwsform').getForm().findField("id").getValue();
                        var idnameval = Ext.getCmp('idwsform').getForm().findField("idname").getValue();
                        var iddescriptionval = Ext.getCmp('idwsform').getForm().findField("idsubject").getValue();
                        var idinstructionsval = Ext.getCmp('idwsform').getForm().findField("idinstructions").getValue();
                        var idactionurlval = Ext.getCmp('idwsform').getForm().findField("idactionurl").getValue();

                        var updSQLString = 'UPDATE AdvWorkflowStep' + BSSInstanceMode +' SET '
                                + ' name = ' + "'" + idnameval  + "'" + ","
                                + ' description = ' + "'" + iddescriptionval + "'"  + ","
                                + ' ActionURL = ' + "'" + idactionurlval  + "'"  + ","
                                + ' Instructions = ' + "'" + idinstructionsval  + "'"
                                + ' WHERE stepkey = ' + "'" + idval + "'"
                                + ' AND workflowid = ' + "'" + BSSWorkflowId + "'";

                        //   alert(updSQLString);

                        var xmlHttp = null;
                        xmlHttp = new XMLHttpRequest();
                        xmlHttp.open( "GET", "DBServices/BSSPerformSQLCommand.php?BSSSQLCommand=" + updSQLString + "&userid=" + BSSUserId, false );
                        xmlHttp.send(null);

                        //alert(xmlHttp.responseText);

                    }



                },{
                    minWidth: 80,
                    text: 'Cancel',
                    handler: function(){win.close(); win.destroy(); Ext.getCmp('idwsform').close();}

                }]
            }]



        });

        win.show();

    }catch(e){alert(e.message)}


}


function OpenURLForm(WorkflowID, Key, Category){

        var BSSWorkflowStepName;
        BSSWorkflowStepId = Key;

        try{
            xmlHttp = new XMLHttpRequest();
            xmlHttp.open( "GET", "Workflow/BSSGetAdvWorkflowStepData.php?BSSWorkflowId= " + BSSWorkflowId +  "&BSSWorkflowStepId=" +  BSSWorkflowStepId + "&BSSInstanceMode=" + BSSFormMode, false );
            xmlHttp.send( null );
            //alert("DATA: " + xmlHttp.responseText);
            var wsdata =eval('[' + xmlHttp.responseText + ']');

            var BSSID = wsdata[0].id;
            var BSSLOC = wsdata[0].location;
            var BSSName = wsdata[0].name;
            var BSSDescription = wsdata[0].description;
            var BSSCategory = wsdata[0].category;
            var BSSActionURL = wsdata[0].ActionURL;
            var BSSInstructions = wsdata[0].Instructions;
            var BSSTASKEE = parseInt(wsdata[0].ApproverUserId);   // Make sure its int
            var BSSStarted = wsdata[0].Started;
            var BSSCompleted = wsdata[0].Completed;
            var BSSStatus =  wsdata[0].status;

            //  masterStore.loadData(newdata,false);
        }catch(e)
        {alert("Master Data Get ERROR: " + e.message);
        }

            var BSSDisableStep = true;
            if(BSSStatus == 1 || BSSStatus == 2){
                BSSDisableStep = false;  //Enabled if in process or rejected
            }


            // Only for Instances
            //if(BSSUserId != BSSTASKEE){
            //    BSSDisableStep = true;  // Disable if the user is not the taskee
            //}



        try{
            var form = Ext.create('Ext.form.Panel', {
                id: 'idwsurlform',
                plain: false,
                border: 0,
                title: 'Status Detail',
                width: 360,
                bodyPadding: 5,
                url: 'BSSSaveWorkflowStep.php',
                fieldDefaults: {
                    labelWidth: 70,
                    anchor: '100%'
                },
                layout: {
                    type: 'vbox',
                    align: 'stretch'  // Child items are stretched to full width
                },
                items: [
                    {  // id: 'id',
                        xtype: 'textfield',
                        fieldLabel: 'id',
                        name: 'id',
                        dataIndex: 'id',
                        value: Key,
                        disabled: true},

                    {  // id: 'idxloc',
                        xtype: 'textfield',
                        fieldLabel: 'Location',
                        name: 'location',
                        dataIndex: 'location',
                        value: BSSLOC, //  valx / 70,
                        disabled: true},

                    {
                       // id: 'idname',
                        xtype: 'textfield',
                        fieldLabel: 'Name',
                        name: 'name',
                        dataIndex: 'name',
                        value: BSSName
                    },
                    {  // id: 'iddescription',
                        xtype: 'textfield',
                        fieldLabel: 'Description',
                        name: 'description',
                        //         dataIndex: 'description',
                        value: BSSDescription},


                    { //  id: 'iddescription',
                        xtype: 'textfield',
                        fieldLabel: 'Category',
                        name: 'category',
                        dataIndex: 'category',
                        readOnly: true,
                        value: BSSCategory},


                              {
                              //    id: 'idactionurl',
                                  hidden: false,
                                  xtype: 'textfield',
                                  fieldLabel: 'Navigate To URL',
                                  name: 'ActionURL',
                                  dataIndex: 'ActionURL',
                                  value: BSSActionURL
                              },
                    {
                       // id: 'idinstructions',
                        xtype: 'textarea',
                        fieldLabel: 'Instructions',
                        hideLabel: false,
                        name: 'instructions',
                        dataIndex: 'instructions',
                        value: BSSInstructions,
                        style: 'margin:0', // Remove default margin
                        flex: 1  // Take up all *remaining* vertical space
                    },

                    {
                      //  id: 'idtaskassignemnt',
                        xtype: 'combo',
                        store: userliststore,
                        valueField:'id',
                        displayField:'value',
                        fieldLabel: 'Task Assignmnt',
                        queryMode: 'local',
                        //       selectOnTab: false,
                        name: 'ApproverUserId',
                        //dataIndex: BSSTASKEE, // 'ApproverUserId',
                        value: BSSTASKEE,
                        submitValue : true,
                        //     hiddenName : 'id'
                        //  flex: 1,
                        forceSelection: false
                        //     disabled: true
                    },
                    {
                      //  id: 'idstart',
                        xtype: 'datefield',
                        fieldLabel: 'Start',
                        name: 'start',
                        dataIndex: 'start',
                        value: BSSStarted,
                        disabled: true
                    },
                    {
                    //    id: 'idcomplete',
                        xtype: 'datefield',
                        fieldLabel: 'Complete',
                        name: 'complete',
                        dataIndex: 'complete',
                        value: BSSCompleted,
                        disabled: true
                    }
                ]
            });

            var historyform = gethistorydata(BSSWorkflowId,BSSWorkflowStepId);

            var tabs = Ext.create('Ext.tab.Panel', {
                //  renderTo: 'tabs1',
                width: 450,
                activeTab: 0,
                defaults :{
                    bodyPadding: 10
                },
                items: [form, historyform],
                tbar: [
                    {text: 'Launch URL Task', disabled: BSSDisableStep, handler : function() {LaunchURL(BSSActionURL,BSSWorkflowId,BSSWorkflowStepId);}},
                    {text: 'Complete URL Task', disabled: BSSDisableStep, handler : function() {ProcessTask("APPROVE",BSSWorkflowId,BSSWorkflowStepId);}},
                    {text: 'Reject URL Task',disabled: BSSDisableStep, handler : function() {ProcessTask("REJECT",BSSWorkflowId,BSSWorkflowStepId);}}
                ]
            });


            var win = Ext.create('Ext.window.Window', {
                title: 'Workflow Step Description',
                collapsible: true,
                animCollapse: true,
                maximizable: true,
                width: 600,
                height: 400,
                minWidth: 300,
                minHeight: 200,
                layout: 'fit',
                items: tabs, //form,

                dockedItems: [{
                    xtype: 'toolbar',
                    dock: 'bottom',
                    ui: 'footer',
                    layout: {
                        pack: 'center'
                    },
                    items: [{
                        minWidth: 80,
                        text: 'Save',

                        handler: function(){

                            try{

                                var idval = Ext.getCmp('idwsurlform').getForm().findField("id").getValue();
                                var idnameval = Ext.getCmp('idwsurlform').getForm().findField("name").getValue();
                                var iddescriptionval = Ext.getCmp('idwsurlform').getForm().findField("description").getValue();
                                var idactionurlval = Ext.getCmp('idwsurlform').getForm().findField("ActionURL").getValue();
                                var idinstructionsval = Ext.getCmp('idwsurlform').getForm().findField("instructions").getValue();
                                var idapproveruser = Ext.getCmp('idwsurlform').getForm().findField("ApproverUserId").getValue();
                               // alert(idapproveruser);

                                var updSQLString = 'UPDATE AdvWorkflowStep' + BSSInstanceMode + ' SET '
                                        + ' name = ' + "'" + idnameval  + "'" + ","
                                        + ' description = ' + "'" + iddescriptionval + "'"  + ","
                                        + ' ActionURL = ' + "'" + idactionurlval + "'" + ","
                                        + ' Instructions = ' + "'" + idinstructionsval  + "'"  + ","
                                        + ' ApproverUserId = ' + "'" + idapproveruser + "'"
                                        + ' WHERE stepkey = ' + idval + ' AND WorkflowId = ' + BSSWorkflowId;

                                //       alert(updSQLString);

                            }catch(e){
                                alert(e);
                            }

                            var xmlHttp = null;
                            xmlHttp = new XMLHttpRequest();
                            xmlHttp.open( "GET", "DBServices/BSSPerformSQLCommand.php?BSSSQLCommand=" + updSQLString + "&userid=" + BSSUserId, false );
                            xmlHttp.send(null);

                          //  alert(xmlHttp.responseText);

                        }

                    },{
                        minWidth: 80,
                        text: 'Cancel',
                        handler: function(){win.close(); win.destroy(); Ext.getCmp('idwsform').close();}
                    }]
                }]



            });

            win.show();


        }catch(e){alert(e.message)}




function LaunchURL(BSSActionURL,BSSWorkflowId,BSSWorkflowStepId){

    BSSExtendedURL = "http://" + BSSActionURL; // + "BSSWorkflowId=" + BSSWorkflowId + "&BSSWorkflowStepId=" + BSSWorkflowStepId;

    //alert(BSSExtendedURL);

    var win = window.open('','','left=0px, top=0px, width=460px, height=840px, scrollbars=no, status =yes, resizable=no');
    win.location.href = BSSExtendedURL;
    win=null;


}





    }

function OpenListenerForm(WorkflowID, Key, Category){

        var BSSWorkflowStepName;
        BSSWorkflowStepId = Key;

        try{
            xmlHttp = new XMLHttpRequest();
            xmlHttp.open( "GET", "Workflow/BSSGetAdvWorkflowStepData.php?BSSWorkflowId= " + BSSWorkflowId +  "&BSSWorkflowStepId=" +  BSSWorkflowStepId + "&BSSInstanceMode" + BSSInstanceMode, false );
            xmlHttp.send( null );
            //    alert("DATA: " + xmlHttp.responseText);
            var wsdata =eval('[' + xmlHttp.responseText + ']');

            var BSSID = wsdata[0].id;
            var BSSLOC = wsdata[0].location;
            var BSSName = wsdata[0].name;
            var BSSDescription = wsdata[0].description;
            var BSSCategory =  wsdata[0].category;
            var BSSActionURL = wsdata[0].ActionURL;
            var BSSInstructions = wsdata[0].Instructions;

            var BSSStarted = wsdata[0].Started;
            var BSSCompleted = wsdata[0].Completed;
            var BSSErrorResult = wsdata[0].ErrorResult;
            //  masterStore.loadData(newdata,false);
        }catch(e)
        {alert("Master Data Get ERROR: " + e.message);
        }

        try{

            var form = Ext.create('Ext.form.Panel', {
                id: 'idwslistenerform',
                plain: false,
                border: 0,
                title: 'Status Detail',
                width: 360,
                bodyPadding: 5,
                url: 'BSSSaveWorkflowStep.php',
                fieldDefaults: {
                    labelWidth: 70,
                    anchor: '100%'
                },
                layout: {
                    type: 'vbox',
                    align: 'stretch'  // Child items are stretched to full width
                },
                items: [
                    {  // id: 'id',
                        xtype: 'textfield',
                        fieldLabel: 'id',
                        name: 'id',
                        dataIndex: 'id',
                        value: Key,
                        disabled: true},
                    {  // id: 'idlocation',
                        xtype: 'textfield',
                        fieldLabel: 'Location',
                        name: 'location',
                        dataIndex: 'location',
                        value: BSSLOC,
                        disabled: true},
                    {
                        id: 'idname',
                        xtype: 'textfield',
                        fieldLabel: 'Name',
                        name: 'name',
                        dataIndex: 'name',
                        value: BSSName
                    },
                    {  // id: 'iddescription',
                        xtype: 'textfield',
                        fieldLabel: 'Description',
                        name: 'description',
                        //         dataIndex: 'description',
                        value: BSSDescription},

                    { //  id: 'iddescription',
                        xtype: 'textfield',
                        fieldLabel: 'Category',
                        name: 'category',
                        dataIndex: 'category',
                        readOnly: true,
                        value: BSSCategory},

                    {
                   //     id: 'idactionurl',
                        xtype: 'textfield',
                        fieldLabel: 'Listener URL',
                        name: 'ActionURL',
                        dataIndex: 'ActionURL',
                        value: BSSActionURL

                    },
                    {
                      //  id: 'idinstructions',
                        xtype: 'textarea',
                        fieldLabel: 'Notes',
                        hideLabel: false,
                        name: 'instructions',
                        dataIndex: 'instructions',
                        value: BSSInstructions,
                        style: 'margin:0', // Remove default margin
                        flex: 1  // Take up all *remaining* vertical space
                    }

                ]
            });

            var formprocessresult = Ext.create('Ext.form.Panel', {
                id: 'idwsformh',
                plain: false,
                border: 0,
                title: 'Process Result',
                width: 290,
                bodyPadding: 5,
                url: 'Workflow/BSSSaveWorkflowStep.php',

                fieldDefaults: {
                    labelWidth: 70,
                    anchor: '100%'
                },

                layout: {
                    type: 'vbox',
                    align: 'stretch'  // Child items are stretched to full width
                },


                items: [
                    {id: 'idstart',
                        xtype: 'datefield',
                        fieldLabel: 'Start',
                        name: 'start',
                        dataIndex: 'start',
                        value: BSSStarted,
                        disabled: true},
                    {id: 'idcomplete',
                        xtype: 'datefield',
                        fieldLabel: 'Complete',
                        name: 'complete',
                        dataIndex: 'complete',
                        value: BSSCompleted,
                        disabled: true},
                    {
                        id: 'iderrorresult',
                        xtype: 'textarea',
                        fieldLabel: 'Error Result',
                        hideLabel: false,
                        name: 'errorresult',
                        dataIndex: 'errorresult',
                        value: BSSErrorResult,
                        style: 'margin:0', // Remove default margin
                        flex: 1  // Take up all *remaining* vertical space
                    }
                ]
            });

            var historyform = gethistory(BSSWorkflowId,BSSWorkflowStepId);

            var tabs = Ext.create('Ext.tab.Panel', {
                //  renderTo: 'tabs1',
                width: 450,
                activeTab: 0,
                defaults :{
                    bodyPadding: 10
                },
                items: [form, formprocessresult, historyform]
            });

            var win = Ext.create('Ext.window.Window', {
                title: 'Workflow Step Description',
                collapsible: true,
                animCollapse: true,
                maximizable: true,
                width: 600,
                height: 400,
                minWidth: 300,
                minHeight: 200,
                layout: 'fit',
                items: tabs, //form,


                dockedItems: [{
                    xtype: 'toolbar',
                    dock: 'bottom',
                    ui: 'footer',
                    layout: {
                        pack: 'center'
                    },
                    items: [{
                        minWidth: 80,
                        text: 'Save',

                        handler: function(){



                            try{
                                var idval = Ext.getCmp('idwslistenerform').getForm().findField("id").getValue();
                                var idnameval = Ext.getCmp('idwslistenerform').getForm().findField("name").getValue();
                                var iddescriptionval = Ext.getCmp('idwslistenerform').getForm().findField("description").getValue();
                                var idactionurlval = Ext.getCmp('idwslistenerform').getForm().findField("ActionURL").getValue();
                                var idinstructionsval = Ext.getCmp('idwslistenerform').getForm().findField("instructions").getValue();

                                var updSQLString = 'UPDATE AdvWorkflowStep' + BSSInstanceMode + ' SET '
                                        + ' name = ' + "'" + idnameval  + "'" + ","
                                        + ' description = ' + "'" + iddescriptionval + "'"  + ","
                                        + ' Instructions = ' + "'" + idinstructionsval  + "'"  + ","
                                        + ' ActionURL = ' + "'" + idactionurlval + "'"
                                        + ' WHERE stepkey = ' + idval + ' AND WorkflowId = ' + BSSWorkflowId;

                                     //  alert(updSQLString);

                            }catch(e){
                                alert(e);
                            }


                            var xmlHttp = null;
                            xmlHttp = new XMLHttpRequest();
                            xmlHttp.open( "GET", "DBServices/BSSPerformSQLCommand.php?BSSSQLCommand=" + updSQLString + "&userid=" + BSSUserId, false );
                            xmlHttp.send(null);

                         //   alert(xmlHttp.responseText);

                        }

                    },{
                        minWidth: 80,
                        text: 'Cancel',
                        handler: function(){win.close(); win.destroy(); Ext.getCmp('idwsform').close();}
                    }]
                }]



            });

            win.show();


        }catch(e){alert(e.message)}










    }

function OpenReviewForm(WorkflowID, Key, Category, obj){


        var BSSWorkflowStepName;
        BSSWorkflowStepId = Key;

                try{

                    BSSReviewBrush = redgrad;
          //          obj.cle

                    //Get the data
                    xmlHttp = new XMLHttpRequest();
                    xmlHttp.open( "GET", "Workflow/BSSGetAdvWorkflowStepData.php?BSSWorkflowId= " + BSSWorkflowId +  "&BSSWorkflowStepId=" +  BSSWorkflowStepId + "&BSSInstanceMode=" + BSSFormMode, false );
                    xmlHttp.send( null );
                    alert("DATA: " + xmlHttp.responseText);
                    var wsdata =eval('[' + xmlHttp.responseText + ']');

                    /*

                     alert(wsdata[0].id);
                     alert(wsdata[1].ActionURL);
                     alert(wsdata[2].xloc);
                     alert(wsdata[3].yloc);
                     alert(wsdata[4].ActionType);
                     alert(wsdata[5].statustype);
                     alert(wsdata[6].Notification);
                     alert(wsdata[7].Revision);
                     alert(wsdata[8].Started);
                     alert(wsdata[9].Completed);
                     alert(wsdata[10].Instructions);
                     alert(wsdata[11].ErrorResult);
                     alert(wsdata[12].name);
                     alert(wsdata[13].description);

                     {id:1, value: 'Pending'},
                     {id:2, value: 'Submit'},
                     {id:3, value: 'Review'},
                     {id:4, value: 'Release'},
                     {id:5, value: 'Complete'},
                     {id:6, value: 'Notify'},
                     {id:7, value: 'Action'}
                     */


                    var BSSID = wsdata[0].id;
                    var BSSLOC = wsdata[0].location;
                    var BSSInstructions = wsdata[0].Instructions;
                    var BSSErrorResult = wsdata[0].ErrorResult;
                    var BSSName = wsdata[0].name;
                    var BSSDescription = wsdata[0].description;
                    var BSSCategory = wsdata[0].category;
                    var BSSStarted = wsdata[0].Started;
                    var BSSCompleted = wsdata[0].Completed;
                    var BSSErrorResult = wsdata[0].ErrorResult;
                    var BSSStatus =  wsdata[0].status;
                    var BSSReviewPolicy =  parseInt(wsdata[0].ReviewPolicy);

                //    alert("policy is " + BSSReviewPolicy);

                    //  masterStore.loadData(newdata,false);
                }catch(e)
                {alert("Master Data Get ERROR: " + e.message);
                }


                    var BSSDisableStep = true;
                    if(BSSStatus == 1 || BSSStatus == 3){
                        BSSDisableStep = false;  //Enabled if in process or rejected
                    }

                    // CHANGE TO Check if user is all approvers
          //          if(BSSUserId != BSSTASKEE){
           //             BSSDisableStep = true;  // Disable if the user is not the taskee
           //         }




                try{

                    var signoffs = Ext.create('Ext.grid.Panel', {
                        name: 'signoffgrid',
                        hidden: false,
                        store: signoffsStore,
                        //    listeners: {itemclick: function() {alert('SSS');}},
                        listeners: {activate: function() {GetSignOffs(Key);}},
                        selModel: 'cellmodel',
                        columns: [
                            { //id: 'idsignoff',
                                header: 'Id',
                                disabled: true,
                                listeners: {
                                    beforeedit: function(){
                                        return false;
                                    }},
                                width: 1,
                                dataIndex: 'id',
                                editor: {
                                    allowBlank: false
                                }
                            },
                            {//id: 'masteridsignoff',
                                header: 'Id',
                                disabled: true,
                                listeners: {
                                    beforeedit: function(){
                                        return false;
                                    }},
                                width: 1,
                                dataIndex: 'masterid',
                                editor: {
                                    allowBlank: false
                                }
                            },{//id: 'sequenceasignoff',
                                header: 'Id',
                                disabled: true,
                                listeners: {
                                    beforeedit: function(){
                                        return false;
                                    }},
                                width: 1,
                                dataIndex: 'sequence',
                                editor: {
                                    allowBlank: false
                                }
                            },

                            {//id: 'idWorkflowApprover',
                                header: 'Workflow Approver',
                                disabled: false,
                                width: 150,
                                dataIndex: 'WorkflowApprover',
                                editor:
                                { xtype: 'combobox',
                                    typeAhead: true,
                                    selectOnTab: true,
                                    triggerAction: 'all',
                                    fields:['id','value'],
                                    store: userliststore, //[[1, 'GLOBAL'],[2, 'USER']],
                                    valueField:'id',
                                    displayField:'value',
                                    multiSelect: false,
                                    queryMode: 'local',
                                    lazyRender: true,
                                    listClass: 'x-combo-list-small'},
                                renderer: function(val) {var matching =  userliststore.queryBy( function(rec){ return rec.data.id == val; }); return (matching.items[0]) ? matching.items[0].data.value : ''}
                            },

                            {//id: 'idSignoffDate',
                                header: 'Signoff Date',
                                disabled: false,
                                width: 100,
                                dataIndex: 'SignoffDate',
                                editor: {
                                    allowBlank: false
                                }
                            },

                            {//id: 'idSignoffResult',
                                header: 'Signoff Result',
                                disabled: false,
                                width: 100,
                                dataIndex: 'SignoffResult',
                                editor:
                                { xtype: 'combobox',
                                    typeAhead: true,
                                    selectOnTab: true,
                                    triggerAction: 'all',
                                    fields:['id','value'],
                                    store: workflowapprovalstatusliststore, //[[1, 'GLOBAL'],[2, 'USER']],
                                    valueField:'id',
                                    displayField:'value',
                                    multiSelect: false,
                                    queryMode: 'local',
                                    lazyRender: true,
                                    listClass: 'x-combo-list-small'},
                                renderer: function(val) {var matching =  workflowapprovalstatusliststore.queryBy( function(rec){ return rec.data.id == val; }); return (matching.items[0]) ? matching.items[0].data.value : ''}


                            },
                            {//id: 'idComments',
                                header: 'Comments',
                                disabled: false,
                                width: 300,
                                dataIndex: 'Comments',
                                editor: {
                                    allowBlank: false
                                }
                            }],
                        width: 350,
                        height: 200,
                        x: 2,
                        y: 2,
                        title: 'Approval Status',
                        frame: true,
                        tbar: [{text: 'Approve', disabled: BSSDisableStep, handler : function() {ApproveWorkflow(signoffs,BSSWorkflowId,BSSWorkflowStepId);}},
                            {text: 'Reject', disabled: BSSDisableStep, handler : function() {RejectWorkflow(signoffs,BSSWorkflowId,BSSWorkflowStepId);}},
                            {text: 'Add Approver', disabled: false, handler : function() {AddApprovers(signoffs,BSSWorkflowStepId);}},
                            {text: 'Remove Approver',disabled: false, handler : function() {removeApprovers(signoffs,Key);}}


                        ],
                        plugins: [cellEditing5]
                    });

                    //alert(BSSISACTION);
                    //alert(BSSISNOTIFICATION);

                    alert('HEREZ');

                    var form = Ext.create('Ext.form.Panel', {
                           id: 'idwsreviewform',
                        plain: false,
                        border: 0,
                        title: 'Status Detail',
                        width: 360,
                        bodyPadding: 5,
                        url: 'BSSSaveWorkflowStep.php',

                        fieldDefaults: {
                            labelWidth: 70,
                            anchor: '100%'
                        },

                        layout: {
                            type: 'vbox',
                            align: 'stretch'  // Child items are stretched to full width
                        },


                        items: [
                            {
                               // id: 'id',
                                xtype: 'textfield',
                                fieldLabel: 'id',
                                name: 'id',
                                dataIndex: 'id',
                                value: Key,
                                disabled: true
                            },
                            {
                              //  id: 'idxloc',
                                xtype: 'textfield',
                                fieldLabel: 'Location',
                                name: 'location',
                                dataIndex: 'location',
                                value: BSSLOC, //  valx / 70,
                                disabled: true
                            },
                            {
                              //  id: 'idname',
                                xtype: 'textfield',
                                fieldLabel: 'Name',
                                name: 'name',
                                dataIndex: 'name',
                                value: BSSName
                            },
                            {
                             //   id: 'iddescription',
                                xtype: 'textfield',
                                fieldLabel: 'Description',
                                name: 'description',
                                //         dataIndex: 'description',
                                value: BSSDescription
                            },
                            {
                             //   id: 'idfrevision',
                                name: 'txtrevision',
                                xtype: 'textfield',
                                fieldLabel: 'Revision',
                                dataIndex: 'revision',
                                hidden: true,
                                value: ''
                            },
                            { //  id: 'iddescription',
                                xtype: 'textfield',
                                fieldLabel: 'Category',
                                name: 'category',
                                dataIndex: 'category',
                                readOnly: true,
                                value: BSSCategory},
                            {
                                //id: 'idactontype',
                                hidden: true,
                                xtype: 'combo',
                                store: bssWorkflowActionTypeStore,
                                valueField:'id',
                                displayField:'value',
                                fieldLabel: 'Action Type',
                                queryMode: 'local',
                                selectOnTab: false,
                                name: 'actiontype',
                                dataIndex: 'ActionType'
                                //          value: BSSActionTypeValue
                            },



                          /*
                            {
                                //   id: 'idtaskassignemnt',
                                xtype: 'combo',
                                store: userliststore,
                                valueField:'id',
                                displayField:'value',
                                fieldLabel: 'Submitted To',
                                queryMode: 'local',
                                //       selectOnTab: false,
                                name: 'submittedtouser',
                                //dataIndex: BSSTASKEE, // 'ApproverUserId',
                                value: BSSTASKEE,
                                submitValue : true,
                                //     hiddenName : 'id'
                                //  flex: 1,
                                forceSelection: false
                                //     disabled: true
                            },
                            */

                            {
                               // id: 'idworkflowpolicy',
                                hidden: false,
                                xtype: 'combo',
                                store: bssWorkflowPolicyDataStore,
                                valueField:'id',
                                value: BSSReviewPolicy,
                                displayField:'value',
                                fieldLabel: 'Review Policy',
                                queryMode: 'local',
                                selectOnTab: false,
                                submitValue : true,
                                forceSelection: false,
                                name: 'ReviewPolicy'
                             //   dataIndex: 'ReviewPolicy'
                                //          value: BSSActionTypeValue
                            },
                            {
                                id: 'idnotification',
                                hidden: true,
                                xtype: 'combo',
                                store: bssWorkflowNotificationListStore,
                                valueField:'id',
                                displayField:'value',
                                fieldLabel: 'Notification',
                                queryMode: 'local',
                                selectOnTab: false,
                                name: 'notification',
                                dataIndex: 'notification'
                                //   value: BSSNotificationValue
                            },
                            {
                            //    id: 'idactionurl',
                                hidden: true,
                                xtype: 'textfield',
                                fieldLabel: 'Action URL',
                                name: 'ActionURL',
                                dataIndex: 'ActionURL',
                                value: ''

                            },
                            {
                             //   id: 'idinstructions',
                                xtype: 'textarea',
                                fieldLabel: 'Instructions',
                                hideLabel: false,
                                name: 'instructions',
                                dataIndex: 'instructions',
                                value: BSSInstructions,
                                style: 'margin:0', // Remove default margin
                                flex: 1  // Take up all *remaining* vertical space
                            }

                        ]
                    });


                    var form1 = Ext.create('Ext.form.Panel', {
                        id: 'idwsformh',
                        plain: false,
                        border: 0,
                        title: 'Process Result',
                        width: 290,
                        bodyPadding: 5,
                        url: 'DBServices/BSSSaveWorkflowStep.php',

                        fieldDefaults: {
                            labelWidth: 70,
                            anchor: '100%'
                        },

                        layout: {
                            type: 'vbox',
                            align: 'stretch'  // Child items are stretched to full width
                        },


                        items: [

                            {
                            //    id: 'idstart',
                                xtype: 'datefield',
                                fieldLabel: 'Start',
                                name: 'start',
                                dataIndex: 'start',
                                value: BSSStarted,
                                disabled: true
                            },
                            {
                            //    id: 'idcomplete',
                                xtype: 'datefield',
                                fieldLabel: 'Complete',
                                name: 'complete',
                                dataIndex: 'complete',
                                value: BSSCompleted,
                                disabled: true
                            },
                            {
                            //    id: 'iderrorresult',
                                xtype: 'textarea',
                                fieldLabel: 'Error Result',
                                hideLabel: false,
                                name: 'errorresult',
                                dataIndex: 'errorresult',
                                value: BSSErrorResult,
                                style: 'margin:0', // Remove default margin
                                flex: 1  // Take up all *remaining* vertical space
                            }
                        ]
                    });




                    var historyform = gethistorydata(BSSWorkflowId,BSSWorkflowStepId);


                    var tabs = Ext.create('Ext.tab.Panel', {
                        //  renderTo: 'tabs1',
                        width: 450,
                        activeTab: 0,
                        defaults :{
                            bodyPadding: 10
                        },
                        items: [form, form1, signoffs, historyform]
                    });


           //         Ext.getCmp('idstatustype').setValue(BSSstatustype);
           //         Ext.getCmp('idstatustype').setRawValue(BSSstatustypeValue);

           //         Ext.getCmp('idactontype').setRawValue(BSSActionType);
           //         Ext.getCmp('idactontype').setValue(BSSActionTypeValue);

            //        Ext.getCmp('idnotification').setRawValue(BSSNotification);
             //       Ext.getCmp('idnotification').setValue(BSSNotificationValue);

                    //Ext.getCmp('idstatustype').valueField = BSSstatustype;

                    var win = Ext.create('Ext.window.Window', {
                        title: 'Workflow Step Description',
                        collapsible: true,
                        animCollapse: true,
                        maximizable: true,
                        width: 600,
                        height: 400,
                        minWidth: 300,
                        minHeight: 200,
                        layout: 'fit',
                        items: tabs, //form,


                        dockedItems: [{
                            xtype: 'toolbar',
                            dock: 'bottom',
                            ui: 'footer',
                            layout: {
                                pack: 'center'
                            },
                            items: [{
                                minWidth: 80,
                                text: 'Save',

                                handler: function(){

                                    try{
                                 //  alert('1');

                                    var idval = Ext.getCmp('idwsreviewform').getForm().findField("id").getValue();
                                    var idnameval = Ext.getCmp('idwsreviewform').getForm().findField("name").getValue();
                                    var iddescriptionval = Ext.getCmp('idwsreviewform').getForm().findField("description").getValue();
                                    var idinstructionsval = Ext.getCmp('idwsreviewform').getForm().findField("instructions").getValue();
                                    var idaccountpolicy = Ext.getCmp('idwsreviewform').getForm().findField("ReviewPolicy").getValue();


                                   //     alert('2');

                                    var updSQLString = 'UPDATE AdvWorkflowStep' + BSSInstanceMode + ' SET '
                                            + ' name = ' + "'" + idnameval  + "'" + ","
                                            + ' description = ' + "'" + iddescriptionval + "'"  + ","
                                            + ' Instructions = ' + "'" + idinstructionsval + "'"  + ","
                                            + ' ReviewPolicy = ' + "'" + idaccountpolicy  + "'"
                                            + ' WHERE stepkey = ' + idval + ' AND WorkflowId = ' + BSSWorkflowId;

                                 //   alert(updSQLString);

                                    var xmlHttp = null;
                                    xmlHttp = new XMLHttpRequest();
                                    xmlHttp.open( "GET", "DBServices/BSSPerformSQLCommand.php?BSSSQLCommand=" + updSQLString + "&userid=" + BSSUserId, false );
                                    xmlHttp.send(null);

                                    //alert(xmlHttp.responseText);

                                }catch(e){
                                alert(e);
                }

                                }



                            },{
                                minWidth: 80,
                                text: 'Cancel',
                                handler: function(){win.close(); win.destroy(); Ext.getCmp('idwsform').close();}
                            }]
                        }]



                    });

                    win.show();

                }catch(e){alert(e.message)}














}

function GetSignOffs(BSSStepKey)
{

            try{
                //Get the data
                xmlHttp = new XMLHttpRequest();
                varQueryId = 0;

                //alert("BSSGetJSData.php?BSSConfigName=" + "SignOffs" + "&BSSQueryId=" + "" + "&BSSWhereClause=" + "workflowid = " + BSSWorkflowId + " AND stepkey = " + BSSStepKey + " ORDER BY sequence,id DESC");

                xmlHttp.open( "GET", "DBServices/BSSGetJSData.php?BSSConfigName=" + "AdvWorkflowSignOffs" + "&BSSQueryId=" + "" + "&BSSInstanceMode=" + BSSFormMode + "&BSSWhereClause=" + "workflowid = " + BSSWorkflowId + " AND stepkey = " + BSSStepKey + " ORDER BY sequence,id DESC", false );
                xmlHttp.send( null );
                alert(xmlHttp.responseText);
                var newdata = eval('[' + xmlHttp.responseText + ']');
                signoffsStore.loadData(newdata,false);
            }catch(e)
            {alert("Signoff Data Get ERROR: " + e.message);
            }

            //   alert(varRecordId);

}


    function OpenExtNodeForm(WorkflowID, Key, Category){

        var BSSWorkflowStepName;
        BSSWorkflowStepId = Key;

        alert("Workflow/BSSGetAdvWorkflowStepData.php?BSSWorkflowId= " + BSSWorkflowId +  "&BSSWorkflowStepId=" +  BSSWorkflowStepId);

        try{
            xmlHttp = new XMLHttpRequest();
            xmlHttp.open( "GET", "Workflow/BSSGetAdvWorkflowStepData.php?BSSWorkflowId= " + BSSWorkflowId +  "&BSSWorkflowStepId=" +  BSSWorkflowStepId + "&BSSInstanceMode=" + BSSInstanceMode, false );
            xmlHttp.send( null );
                alert("DATA: " + xmlHttp.responseText);
            var wsdata =eval('[' + xmlHttp.responseText + ']');



            var BSSID = wsdata[0].id;
            var BSSLOC = wsdata[0].location;
            var BSSName = wsdata[0].name;
            var BSSDescription = wsdata[0].description;
            var BSSCategory = wsdata[0].category;
            var BSSActionURL = wsdata[0].ActionURL;
            var BSSInstructions = wsdata[0].Instructions;
            var BSSStarted = wsdata[0].Started;
            var BSSCompleted = wsdata[0].Completed;
            var BSSErrorResult = wsdata[0].ErrorResult;
            var BSSUIClass = wsdata[0].UIClass;

            //  masterStore.loadData(newdata,false);
        }catch(e)
        {alert("Master Data Get ERROR: " + e.message);
        }

        try{

            var form = Ext.create('Ext.form.Panel', {
                id: 'idwsactionform',
                plain: false,
                border: 0,
                title: 'Status Detail',
                width: 360,
                bodyPadding: 5,
                url: 'BSSSaveWorkflowStep.php',
                fieldDefaults: {
                    labelWidth: 70,
                    anchor: '100%'
                },
                layout: {
                    type: 'vbox',
                    align: 'stretch'  // Child items are stretched to full width
                },
                items: [
                    {   //id: 'id',
                        xtype: 'textfield',
                        fieldLabel: 'id',
                        name: 'id',
                        dataIndex: 'id',
                        value: Key,
                        disabled: true},
                    {   //id: 'idxloc',
                        xtype: 'textfield',
                        fieldLabel: 'Location',
                        name: 'location',
                        dataIndex: 'location',
                        value: BSSLOC, //  valx / 70,
                        disabled: true},
                    {
                        // id: 'idname',
                        xtype: 'textfield',
                        fieldLabel: 'Name',
                        name: 'name',
                        dataIndex: 'name',
                        value: BSSName
                    },
                    {   //id: 'iddescription',
                        xtype: 'textfield',
                        fieldLabel: 'Description',
                        name: 'description',
                        //         dataIndex: 'description',
                        value: BSSDescription},


                    { //  id: 'iddescription',
                        xtype: 'textfield',
                        fieldLabel: 'Category',
                        name: 'category',
                        dataIndex: 'category',
                        readOnly: true,
                        value: BSSCategory},

                    /*
                     {   id: 'idstatustype',
                     xtype: 'combo',
                     //  store: bssWorkflowStatusListStore,
                     valueField:'id',
                     displayField:'value',
                     fieldLabel: 'Status Type',
                     queryMode: 'local',
                     //       selectOnTab: false,
                     name: 'statustype',
                     //dataIndex: 'statustype',
                     displayValue: 'Task',
                     submitValue : true,
                     //     hiddenName : 'id'
                     //  flex: 1,
                     forceSelection: false
                     //     disabled: true
                     },
                     */
                    {
                        //  id: 'idactionurl',
                        xtype: 'textfield',
                        fieldLabel: 'Action URL',
                        name: 'actionurl',
                        dataIndex: 'ActionURL',
                        value: BSSActionURL

                    },

                    {
                        //  id: 'idactionurl',
                        xtype: 'textfield',
                        fieldLabel: 'UI Class',
                        name: 'UIClass',
                        dataIndex: 'UIClass',
                        value: BSSActionURL

                    },
                    {
                        //  id: 'idinstructions',
                        xtype: 'textarea',
                        fieldLabel: 'Notes',
                        hideLabel: false,
                        name: 'instructions',
                        dataIndex: 'instructions',
                        value: BSSInstructions,
                        style: 'margin:0', // Remove default margin
                        flex: 1  // Take up all *remaining* vertical space
                    }

                ]
            });


            var tabs = Ext.create('Ext.tab.Panel', {
                //  renderTo: 'tabs1',
                width: 450,
                activeTab: 0,
                defaults :{
                    bodyPadding: 10
                },
                items: [form]
            });


            var win = Ext.create('Ext.window.Window', {
                title: 'Workflow Step Description',
                collapsible: true,
                animCollapse: true,
                maximizable: true,
                width: 600,
                height: 400,
                minWidth: 300,
                minHeight: 200,
                layout: 'fit',
                items: tabs, //form,


                dockedItems: [{
                    xtype: 'toolbar',
                    dock: 'bottom',
                    ui: 'footer',
                    layout: {
                        pack: 'center'
                    },
                    items: [{
                        minWidth: 80,
                        text: 'Save',

                        handler: function(){

                            try{
                                var idval = Ext.getCmp('idwsactionform').getForm().findField("id").getValue();
                                var idnameval = Ext.getCmp('idwsactionform').getForm().findField("name").getValue();
                                var iddescriptionval = Ext.getCmp('idwsactionform').getForm().findField("description").getValue();
                                var idactionurlval = Ext.getCmp('idwsactionform').getForm().findField("actionurl").getValue();
                                var idinstructionsval = Ext.getCmp('idwsactionform').getForm().findField("instructions").getValue();


                                var updSQLString = 'UPDATE AdvWorkflowStep' + BSSInstanceMode + ' SET '
                                        + ' name = ' + "'" + idnameval  + "'" + ","
                                        + ' description = ' + "'" + iddescriptionval + "'"  + ","
                                        + ' Instructions = ' + "'" + idinstructionsval  + "'"  + ","
                                        + ' ActionURL = ' + "'" + idactionurlval + "'"
                                        + ' WHERE stepkey = ' + idval + ' AND WorkflowId = ' + BSSWorkflowId;

                                //       alert(updSQLString);

                                var xmlHttp = null;
                                xmlHttp = new XMLHttpRequest();
                                xmlHttp.open( "GET", "DBServices/BSSPerformSQLCommand.php?BSSSQLCommand=" + updSQLString + "&userid=" + BSSUserId, false );
                                xmlHttp.send(null);

                                // alert(xmlHttp.responseText);


                            }catch(e){
                                alert(e);
                            }



                        }

                    },{
                        minWidth: 80,
                        text: 'Cancel',
                        handler: function(){win.close(); win.destroy(); Ext.getCmp('idwsform').close();}
                    }]
                }]



            });

            win.show();


        }catch(e){alert(e.message)}










    }




// Define a function for creating a "port" that is normally transparent.
// The "name" is used as the GraphObject.portId, the "spot" is used to control how links connect
// and where the port is positioned on the node, and the boolean "output" and "input" arguments
// control whether the user can draw links from or to the port.
function makePort(name, spot, output, input) {
    // the port is basically just a small circle that has a white stroke when it is made visible
    return go.GraphObject.make(go.Shape,
            {
                figure: "Circle",
                fill: "transparent",
                stroke: null,  // this is changed to "white" in the showPorts function
                desiredSize: new go.Size(6, 6),
                alignment: spot, alignmentFocus: spot,  // align the port on the main Shape
                portId: name,  // declare this object to be a "port"
                fromSpot: spot, toSpot: spot,  // declare where links may connect at this port
                fromLinkable: output, toLinkable: input,  // declare whether the user may draw links to/from here
                cursor: "pointer"  // show a different cursor to indicate potential link point
            });
}


function makeStatusPort(name, spot, output, input, status) {
        // the port is basically just a small circle that has a white stroke when it is made visible
        try{

       //     alert(status);

        if(status==0){
        status = "transparent";
        }

        if(status==1){
            status = "yellow";
        }

        if(status==2){
            status = "green";
        }

        if(status==3){
            status = "red";
        }

            return go.GraphObject.make(go.Shape,
                {
                    figure: "Circle",
                    fill: status,
                    stroke: null,  // this is changed to "white" in the showPorts function
                    desiredSize: new go.Size(10, 10),
                    alignment: spot, alignmentFocus: spot  // align the port on the main Shape
                });


    }catch(e)
    {alert("STATUS PORT ERROR: " + e.message);
    }
    }




// Make all ports on a node visible when the mouse is over the node
function showPorts(node, show) {
    var diagram = node.diagram;
    if (!diagram || diagram.isReadOnly || !diagram.allowLink) return;
    var it = node.ports;
    while (it.next()) {
        var port = it.value;
        port.stroke = (show ? "white" : null);
    }
}

// Show the diagram's model in JSON format that the user may have edited
function clear() {

/*
    var model = myPalette.model;
    var arr = model.nodeDataArray;
    for (var i = 0; i < arr.length; i++) {
        data = arr[i];
        alert(data.key);
        data.status =0;
        model.updateTargetBindings(data);
    }
*/

    myDiagram.clear();
    BSSWorkflowId = 0;

   // document.getElementById("mySavedModel").value = str;
}

function load() {

  // alert('load');

    var xmlHttp = null;
    xmlHttp = new XMLHttpRequest();
    xmlHttp.open( "GET", "Workflow/BSSGetWorkflowGOJSData.php", false ); //?BSSWorkflowStepId=" + xstepbox.getAttrs().id + "&name=" + StatusType  + "$statustype=" + StatusType + "&xloc=" + curx + "&yloc=" + cury, false );
    xmlHttp.send(null);


    str =  xmlHttp.responseText;

    myDiagram.model = go.Model.fromJson(str);
    myDiagram.undoManager.isEnabled = true;
}


function GetWorkFlowList(){


    if(BSSInstanceMode == "Instance"){
        GetInstanceView();
        exit;
    }


        var childgrid;
        var notificationgrid;
        var actiongrid;
        var BSSCREATEMASTER_FLAG = false
        var BSSREADMASTER_FLAG = false
        var BSSUPDATEMASTER_FLAG = false
        var BSSDELETEMASTER_FLAG = false
        var BSSCREATECHILD_FLAG = false
        var BSSREADCHILD_FLAG = false
        var BSSUPDATECHILD_FLAG = false
        var BSSDELETECHILD_FLAG = false

        var BSSChildConfigName = "WorkflowApprovers";
        var BSSWorkflowNotificationConfigName = "WorkflowNotifications";
        var BSSWorkflowActionConfigName = "WorkflowActions";
        var bssNewFieldNameData;
        var bssNewFlowManagerData;



        bssFieldNameData = [ { id:1, value: 'AGLOBAL'},{ id:2, value: 'AUSER'}];

        bssNewFlowManagerData = [ { id:1, value: 'AG'},{ id:2, value: 'AU'}];

        try {
            fieldStore = Ext.create('Ext.data.Store', {
                        fields: [{name: 'id'}, {name: 'value'}],
                        data: bssFieldNameData
                    }
            );
        }catch(e){
        alert(e);
    }

        var cellEditing = Ext.create('Ext.grid.plugin.CellEditing', {
            clicksToEdit: 1
        });

        usermanagerStore = Ext.create('Ext.data.Store', {
                fields: [{name: 'id'}, {name: 'value'} ],
                data: bssNewFlowManagerData
            }
        );

        usermanagerStore = Ext.create('Ext.data.Store', {
                    fields: [{name: 'id'}, {name: 'value'} ],
                    data: bssNewFlowManagerData
                }
        );

        //Get the data
        xmlHttp = new XMLHttpRequest();
        xmlHttp.open( "GET", "DBServices/BSSGetComboStore.php?BSSSQLString=SELECT id, QueryName AS value FROM Queries", false );
        xmlHttp.send( null );
        //      alert("DATA: " + xmlHttp.responseText);
        var bssNewFieldNameData = eval('[' + xmlHttp.responseText + ']');
        fieldStore.loadData(bssNewFieldNameData,false);

        //Get the data
        xmlHttp = new XMLHttpRequest();
        xmlHttp.open( "GET", "DBServices/BSSGetComboStore.php?BSSSQLString=SELECT id, Email AS value FROM users", false );
        xmlHttp.send( null );
        //       alert("DATA: " + xmlHttp.responseText);
        var bssNewFlowManagerData = eval('[' + xmlHttp.responseText + ']');
        usermanagerStore.loadData(bssNewFlowManagerData,false);


        try{
            //Get the data
            xmlHttp = new XMLHttpRequest();
            xmlHttp.open( "GET", "DBServices/BSSGetJSData.php?BSSConfigName=" + "AdvWorkflow" + BSSInstanceMode + "&BSSWhereClause=" + "id>0 ORDER BY sequence,id", false );
            xmlHttp.send( null );
            //alert("DATA: " + xmlHttp.responseText);
            var newdata = eval('[' + xmlHttp.responseText + ']');
            workflowstore.loadData(newdata,false);
        }catch(e)

        {
            alert(e.message);
        }


        workflowgrid = Ext.create('Ext.grid.Panel', {
            store: workflowstore,
            selModel: 'cellmodel',
            listeners: {
                dblclick: function() {
                    GetWorkflowSteps("AdvWorkflow",workflowgrid,workflowstore);
                }},
            columns: [
                {id: 'id1',
                    header: 'Id',
                    disabled: true,
                    listeners: {
                        beforeedit: function(){
                            return false;
                        }},
                    width: 40,
                    dataIndex: 'id',
                    editor: {
                        allowBlank: false
                    }
                },
                {id: 'sequence1',
                    header: 'Sequence',
                    disabled: false,
                    width: 0,
                    dataIndex: 'sequence',
                    editor: {
                        allowBlank: false
                    }
                },
                {id: 'masterid1',
                    header: 'Master Id',
                    disabled: false,
                    width: 0,
                    dataIndex: 'masterid',
                    editor: {
                        allowBlank: false
                    }

                },
                {id: 'WorkflowName',
                    header: 'Workflow Name',
                    width: 150,
                    editable: false,
                    dataIndex: 'WorkflowName',
                    editor: {
                        allowBlank: true
                    }
                },
                {
                    id: 'Workflowdescription',
                    header: 'Workflow Description',
                    width: 250,
                    dataIndex: 'Workflowdescription',
                    editor: {
                        allowBlank: false
                    }
                },
                {header:'Enabled',
                 dataIndex:'Enabled',
                 width: 80,
                 disabled: true,
                 editor:
                 {xtype: 'combobox',
                 disabled: true,
                 typeAhead: true,
                 selectOnTab: true,
                 triggerAction: 'all',
                 fields:['id','value'],
                 store: bssWorkflowEnabledStore,
                 valueField:'id',
                 displayField:'value',
                 multiSelect: false,
                 queryMode: 'local',
                 lazyRender: true,
                 listClass: 'x-combo-list-small'},
                 renderer: function(val) {var matching =  bssWorkflowEnabledStore.queryBy( function(rec){ return rec.data.id == val; }); return (matching.items[0]) ? matching.items[0].data.value : ''}

                 }
            ],
            width: 550,
            height: 350,
            x: 0,
            y: 0,
            //     title: 'Workflows',
            frame: true,
            tbar: [{text: 'Add',    handler : function() {processInsert("AdvWorkflow",workflowgrid,workflowstore);}},
                {text: 'Save',   handler : function() {processUpdate("AdvWorkflow",workflowgrid,workflowstore);}},
                {text: 'Delete', handler : function() {processDelete("AdvWorkflow",workflowgrid,workflowstore);}},
                {text: 'Get Workflow Steps', handler : function() {GetWorkflowSteps("AdvWorkflow",workflowgrid,workflowstore);}},
                {text: 'Enable Workflow', handler : function() {EnableWorkflow("AdvWorkflow",workflowgrid,workflowstore);}},
                {text: 'Disable Workflow', handler : function() {DisableWorkflow("AdvWorkflow",workflowgrid,workflowstore);}}

            ]
            , plugins: [cellEditing]
        });

        absolute1 = Ext.create('Ext.window.Window', {
            title: 'Workflow Maintenance',
            x:50,
            y:50,
            width: 570,
            height: 450,
            //        layout:'absolute',
            defaults: {
                bodyStyle: 'padding:10px'
            },
            items: [workflowgrid]
        });

        absolute1.show();

    }


function GetInstanceView(){
    GetWorkflowStepsFromId(BSSWorkflowId);
}

function processInsert(BSSConfigName, BSSGrid, BSSStore)
{
        //  Get default data from config array

        try{
            idval = 0;
            var sm = BSSGrid.getSelectionModel();
            var selrecords = sm.getSelection();
            if(sm.getCount() > 0){
                var fieldname = "id";
                var idval = selrecords[0].get('id');
                // alert(idval);
            }

            //   return;

            var xmlHttp = null;
            xmlHttp = new XMLHttpRequest();
            xmlHttp.open( "GET", "DBServices/BSSPerformInsert.php?BSSConfigName=" + BSSConfigName+ "&masterid=" + idval, false );
            xmlHttp.send(null);

            // document.write("<p>"+ xmlHttp.responseText + "</p>");

            newdata = eval('[' + xmlHttp.responseText + ']');

            BSSStore.add(newdata);
        }catch(e)
        {document.write("<p>" + e.message + "</p>");
        }

    }

function processDelete(BSSConfigName, BSSGrid, BSSStore)
{

        var sm = BSSGrid.getSelectionModel();
        BSSStore.remove(sm.getSelection());

        if (BSSStore.getCount() > 0) {
            sm.select(0);
        }

        var delrecords = BSSStore.getRemovedRecords();

        var fieldname = "id";




        //"&id=" + delrecords[0].get('id'),

        try{
            var xmlHttp = null;
            xmlHttp = new XMLHttpRequest();
            xmlHttp.open( "GET", "DBServices/BSSPerformDelete.php?BSSConfigName=" + BSSConfigName + "&id=" + delrecords[0].get('id'), false);
            xmlHttp.send(null);

            //alert(xmlHttp.responseText);

            BSSStore.removed = [];


        }catch(e)
        {    alert(e.message); //document.write("<p>" + e.message + "</p>");
        }


    }

function processUpdate(BSSConfigName, BSSGrid, BSSStore)
{


        var updrecords = BSSStore.getUpdatedRecords();

        var fieldname = "phone_type";
        var rec = new BSSStore.model();

        jsenc = "";
        var fieldcount = rec.fields.getCount();

        var xfieldtype;
        var xfieldname;


        for(x = 0; x < fieldcount; x++){
            xfieldtype = rec.fields.getAt(x).type.type;
            xfieldname = rec.fields.getAt(x).name;

            switch(xfieldtype){
                case "date":
                    jsenc = jsenc + formatDate(updrecords[0].get(xfieldname)) + "|";
                    break;
                case "bool":
                    if(updrecords[0].get(xfieldname).toString()=='true'){
                        jsenc = jsenc + "1" + "|";
                    }else{
                        jsenc = jsenc + "0" + "|";
                    }
                    break;
                default:
                    jsenc = jsenc + updrecords[0].get(xfieldname) + "|";
            }
        }


        try{
            var xmlHttp = null;
            xmlHttp = new XMLHttpRequest();
            xmlHttp.open( "GET", "DBServices/BSSPerformUpdate.php?BSSConfigName=" + BSSConfigName + "&id=" + jsenc, false);
            xmlHttp.send(null);
            //alert(xmlHttp.responseText);

            //REmove the red triangle
            BSSStore.each(function(r){
                r.commit();
            });


        }catch(e)
        {alert(e.getMessage());}


    }


function AddApprovers(BSSGrid,BSSStepKey)
{

        //Add get uers authorized to sign off
        //custom user store
      //  alert('here1');

  //      var sm = BSSGrid.getSelectionModel();



  //      try{
  //          if (sm.getCount() == 0) {
  //              return;
  //          }

  //          var selrecords = sm.getSelection();
  //          var fieldname = "id";
  //          var BSSWorkflowId = selrecords[0].get('id');

  //      }catch(e)
  //      {
  //          alert(e.message);
  //      }

   //     alert('here3');

        var msg = function(title, msg) {
            Ext.Msg.show({
                title: title,
                msg: msg,
                minWidth: 200,
                modal: true,
                icon: Ext.Msg.INFO,
                buttons: Ext.Msg.OK
            });
        };



        var getsignoffuser = Ext.create('Ext.form.Panel', {
            //   renderTo: 'editor-grid',
            id: 'idgetuser',
            width: 500,
            frame: true,
            title: 'Add Approver',
            bodyPadding: '10 10 0',

            defaults: {
                anchor: '100%',
                allowBlank: false,
                msgTarget: 'side',
                labelWidth: 70
            },

            items:[{
                name: 'idAddWorkflowApprover',
                //     disabled: false,
                //    width: 180,
                //name: 'txtuserlist',
                xtype: 'combobox',
                fieldLabel: 'Approver',
                queryMode: 'local',
                fields:['id', 'value'],
                store: userliststore,
                displayField: 'value',
                valueField: 'id',
                grow: true,
                labelPad: 10,
                labelWidth: 80,
                labelAlign: 'right'
            }
            ],

            buttons: [{
                text: 'Select',
                handler: function(){

                    try{

                //        alert('before');
                        var ApproverUserId = Ext.getCmp('idgetuser').getForm().findField("idAddWorkflowApprover").getValue();

                        var BSSSQLCommand = "INSERT INTO AdvWorkflowSignOffs(workflowid,WorkflowApprover,stepkey)VALUES(" + BSSWorkflowId + "," + ApproverUserId + "," + BSSStepKey + ")";

                //        alert(BSSSQLCommand);

                        // iterate here on the ids in the sign offs tab  Google: How to iterate on a sencha data grid


                        var xmlHttp = null;
                        xmlHttp = new XMLHttpRequest();
                        xmlHttp.open( "GET", "DBServices/BSSPerformSQLCommand.php?BSSSQLCommand=" + BSSSQLCommand + "&userid=" + BSSUserId, false );
                        xmlHttp.send(null);

                        //alert(xmlHttp.responseText);
                        //newdata = eval('[' + xmlHttp.responseText + ']');
                        //BSSStore.add(newdata);
                        GetSignOffs(BSSStepKey);
                        absoluteuser.close();
                        //this.up('form').getForm().close();
                        //Ext.getCmp('idgetuser').close();


                    }catch(e)
                    {document.write("<p>" + e.message + "</p>");
                    }


                }
            },{
                text: 'Close',
                handler: function() {
                    absoluteuser.close();
                    this.up('form').getForm().close();
                    Ext.getCmp('idgetuser').close();
                    GetSignOffs(BSSStepKey);
                }
            }]
        });

        absoluteuser = Ext.create('Ext.window.Window', {
            //  title: 'File Upload',
            width: 510,
            height: 140,
            layout:'absolute',
            defaults: {
                bodyStyle: 'padding:10px'
            },
            items: [getsignoffuser]
        });


        try{
            absoluteuser.show();
        }catch(e){
            alert(e.message);
        }

    }


function removeApprovers(BSSGrid, BSSStepKey)
{

        try{

            var sm = BSSGrid.getSelectionModel();

            if (sm.getCount() == 0) {
                return;
            }
            var selrecords = sm.getSelection();
            var BSSWorkflowApproverId = selrecords[0].get('id');
            var BSSSignOffResult = selrecords[0].get('SignoffResult');
            var BSSSQLCommand = "DELETE FROM AdvWorkflowSignOffs WHERE id = " + BSSWorkflowApproverId;

            // add message do you wish to remove user: X

            if(BSSSignOffResult > 0){
                alert("User has already Signed Off");
                return;
            }

            //alert(BSSSQLCommand);

            var xmlHttp = null;
            xmlHttp = new XMLHttpRequest();
            xmlHttp.open( "GET", "DBServices/BSSPerformSQLCommand.php?BSSSQLCommand=" + BSSSQLCommand + "&userid=" + BSSUserId, false );
            xmlHttp.send(null);

            //alert(xmlHttp.responseText);

            GetSignOffs(BSSStepKey);


        }catch(e)
        {
            alert(e.message);
        }


    }





function GetWorkflowSteps(BSSConfigName, BSSGrid, BSSStore)
{
    try{

       // alert("here");

        idval = 0;
        var sm = BSSGrid.getSelectionModel();
        var selrecords = sm.getSelection();
        if(sm.getCount() > 0){
            var fieldname = "id";
            BSSWorkflowId = selrecords[0].get('id');
            BSSWorkflowName = selrecords[0].get('WorkflowName');
            //alert(idval);
        }

        GetWorkflowStepsFromId(BSSWorkflowId);

         /*
        var xmlHttp = null;
        xmlHttp = new XMLHttpRequest();
        xmlHttp.open( "GET", "BSSGetWorkflowGOJSData.php?BSSWorkflowId=" + BSSWorkflowId, false ); //?BSSWorkflowStepId=" + xstepbox.getAttrs().id + "&name=" + StatusType  + "$statustype=" + StatusType + "&xloc=" + curx + "&yloc=" + cury, false );
        xmlHttp.send(null);

        str =  xmlHttp.responseText;

      //  alert(str);

        myDiagram.clear();
        myDiagram.model = go.Model.fromJson(str);
        myDiagram.undoManager.isEnabled = true;

        myDiagram.add(
                $(go.Node, go.Panel.Vertical,
                        $(go.TextBlock, {name: 'txtWFSelected', text: "Selected Workflow: "+ BSSWorkflowName, font: "12pt sans-serif", editable: false }) ));

          */
}catch(e)
    {alert(e.getMessage());}

}


    function GetWorkflowStepsFromId(BSSWorkflowId)
    {
        try{
            var xmlHttp = null;
            xmlHttp = new XMLHttpRequest();
            xmlHttp.open( "GET", "Workflow/BSSGetWorkflowGOJSData.php?BSSWorkflowId=" + BSSWorkflowId + "&BSSFormMode=" + BSSFormMode, false ); //?BSSWorkflowStepId=" + xstepbox.getAttrs().id + "&name=" + StatusType  + "$statustype=" + StatusType + "&xloc=" + curx + "&yloc=" + cury, false );

            xmlHttp.send(null);

            //alert("Workflow/BSSGetWorkflowGOJSData.php?BSSWorkflowId=" + BSSWorkflowId + "&BSSFormMode=" + BSSFormMode);
            //alert(xmlHttp.responseText);

            str =  xmlHttp.responseText;

            myDiagram.clear();
            myDiagram.model = go.Model.fromJson(str);
            myDiagram.undoManager.isEnabled = true;

            myDiagram.add(
                    $(go.Node, go.Panel.Vertical,
                            $(go.TextBlock, {name: 'txtWFSelected', text: "Selected Workflow: "+ BSSWorkflowName, font: "12pt sans-serif", editable: false }) ));


        }catch(e)
        {alert(e.getMessage());}


    }



    function EnableWorkflow(BSSConfigName, BSSGrid, BSSStore)
    {
        try{

            idval = 0;
            var sm = BSSGrid.getSelectionModel();
            var selrecords = sm.getSelection();
            if(sm.getCount() > 0){
                var fieldname = "id";
           //     BSSWorkflowId = selrecords[0].get('id');
          //      BSSWorkflowName = selrecords[0].get('WorkflowName');
             //  alert(selrecords[0].get('id'));
            } else
            {
                alert("Select a Workflow First");
                return;
            }

            var xmlHttp = null;
            xmlHttp = new XMLHttpRequest();
            xmlHttp.open( "GET", "Utilities/BSSAuditAdvWorkflow.php?BSSWorkflowId=" + selrecords[0].get('id'), false );
            xmlHttp.send(null);

            alert(xmlHttp.responseText);

            if(xmlHttp.responseText.length > 10)
            {
                alert("Cannot Enable Audit Has Failed: " + xmlHttp.responseText);

                updSQLString = 'UPDATE AdvWorkflow SET Enabled = 0 WHERE id = ' + selrecords[0].get('id');

              //  alert(updSQLString);

                var xmlHttp = null;
                xmlHttp = new XMLHttpRequest();
                xmlHttp.open( "GET", "DBServices/BSSPerformSQLCommand.php?BSSSQLCommand=" + updSQLString + "&userid=" + BSSUserId, false );
                xmlHttp.send(null);



            }else
            {
                alert("Audit Passes");

                updSQLString = 'UPDATE AdvWorkflow SET Enabled = 1  WHERE id = ' + selrecords[0].get('id');

               // alert(updSQLString);

                // Put Enbale workflow here
                var xmlHttp = null;
                xmlHttp = new XMLHttpRequest();
                xmlHttp.open( "GET", "DBServices/BSSPerformSQLCommand.php?BSSSQLCommand=" + updSQLString + "&userid=" + BSSUserId, false );
                xmlHttp.send(null);

            //    alert(xmlHttp.responseText);

            }


            try{
                //Get the data
                xmlHttp = new XMLHttpRequest();
                xmlHttp.open( "GET", "DBServices/BSSGetJSData.php?BSSConfigName=" + "AdvWorkflow" + "&BSSWhereClause=" + "id>0 ORDER BY sequence,id", false );
                xmlHttp.send( null );
                var newdata = eval('[' + xmlHttp.responseText + ']');
                workflowstore.loadData(newdata,false);
            }catch(e)
            {document.write("<p>" + "ERROR: " + e.message + "</p>");
            }

        }catch(e)
        {alert(e.getMessage());}


    }





    function DisableWorkflow(BSSConfigName, BSSGrid, BSSStore)
    {
        try{


            idval = 0;
            var sm = BSSGrid.getSelectionModel();
            var selrecords = sm.getSelection();
            if(sm.getCount() > 0){
                var fieldname = "id";
            } else
            {
                alert("Select a Workflow First");
                return;
            }

                updSQLString = 'UPDATE AdvWorkflow SET Enabled = 0 WHERE id = ' + selrecords[0].get('id');

          //      alert(updSQLString);

                // Put Enbale workflow here
                var xmlHttp = null;
                xmlHttp = new XMLHttpRequest();
                xmlHttp.open( "GET", "DBServices/BSSPerformSQLCommand.php?BSSSQLCommand=" + updSQLString + "&userid=" + BSSUserId, false );
                xmlHttp.send(null);

        //        alert(xmlHttp.responseText);

            try{
                //Get the data
                xmlHttp = new XMLHttpRequest();
                xmlHttp.open( "GET", "DBServices/BSSGetJSData.php?BSSConfigName=" + "AdvWorkflow" + "&BSSWhereClause=" + "id>0 ORDER BY sequence,id", false );
                xmlHttp.send( null );
           //     alert("DATA: " + xmlHttp.responseText);
                var newdata = eval('[' + xmlHttp.responseText + ']');
                workflowstore.loadData(newdata,false);
            }catch(e)
            {document.write("<p>" + "ERROR: " + e.message + "</p>");
            }

        }catch(e)
        {alert(e.getMessage());}


    }



    function ProcessTask(BSSResultType, workflowid, stepkey)
    {

       // alert("here in process task");
        var SQLString = "";
        if(BSSResultType == "APPROVE"){
            SQLString = "UPDATE AdvWorkflowStep" + " SET Completed = CURDATE(), ErrorResult = 'Successfully Completed', status = 2 WHERE workflowid = '" + workflowid + "' and stepkey = '" + stepkey + "'";
        }else{
            SQLString = "UPDATE AdvWorkflowStep" + " SET Completed = null, ErrorResult = 'Task Rejected', status = 3 WHERE workflowid = '" + workflowid + "' and stepkey = '" + stepkey + "'";
        }

        alert(SQLString);

        try{
            BSSUserId = "0";

            var xmlHttp = null;
            xmlHttp = new XMLHttpRequest();
            xmlHttp.open( "GET", "DBServices/BSSPerformSQLCommand.php?BSSSQLCommand=" + SQLString + "&userid=" + BSSUserId, false );
            xmlHttp.send(null);

             //alert(xmlHttp.responseText);

            ProcessWorkflow(BSSWorkflowId);

           // GetWorkflowSteps("AdvWorkflow",workflowgrid,workflowstore);

        }catch(e)
        {    alert(e.message);
        }


    }
function ProcessWorkflow(workflowid)
    {


        try{
            BSSUserId = "0";

            //alert("Processing Here");

            var xmlHttp = null;
            xmlHttp = new XMLHttpRequest();
            xmlHttp.open( "GET", "Workflow/BSSProcessNewADVWorkflow.php?BSSWorkflowId=" + BSSWorkflowId  + "&BSSUserId=" + BSSUserId + "&BSSWorkflowMode=Design", false );
            xmlHttp.send(null);

            alert("Workflow/BSSProcessNewADVWorkflow.php?BSSWorkflowId=" + BSSWorkflowId  + "&BSSUserId=" + BSSUserId + "&BSSWorkflowMode=Design");

            //alert(xmlHttp.responseText);

            GetWorkflowStepsFromId(BSSWorkflowId);

        }catch(e)
        {    alert(e.message);
        }

    }


function audit(){

    if(BSSWorkflowId == 0){
        alert("Select a workflow first");
        return;
    }


    var xmlHttp = null;
    xmlHttp = new XMLHttpRequest();
    xmlHttp.open( "GET", "Utilities/BSSAuditAdvWorkflow.php?BSSWorkflowId=" + BSSWorkflowId, false );
    xmlHttp.send(null);

    alert(xmlHttp.responseText);


    if(xmlHttp.responseText.length > 10)
    {
        alert(xmlHttp.responseText);
    }else
    {
        alert("Audit Passes");
    }

}


function ApproveWorkflow(BSSGrid,BSSWorkflowId,BSSWorkflowStepId){

    //  alert("here");

    idval = 0;
    var sm = BSSGrid.getSelectionModel();
    var selrecords = sm.getSelection();
    if(sm.getCount() > 0){
        var fieldname = "id";
        //     BSSWorkflowId = selrecords[0].get('id');
        //      BSSWorkflowName = selrecords[0].get('WorkflowName');
        //  alert(selrecords[0].get('id'));
    } else
    {
        alert("Select a Workflow First");
        return;
    }


        updSQLString = "UPDATE AdvWorkflowSignOffs SET SignoffDate = CURDATE(), SignoffResult  = 1 WHERE workflowid = " + BSSWorkflowId + " AND stepkey = " + BSSWorkflowStepId + " AND id = " + selrecords[0].get('id');

        alert(updSQLString);

        var xmlHttp = null;
        xmlHttp = new XMLHttpRequest();
        xmlHttp.open( "GET", "DBServices/BSSPerformSQLCommand.php?BSSSQLCommand=" + updSQLString + "&userid=" + BSSUserId, false );
        xmlHttp.send(null);



    //    updSQLString = "UPDATE AdvWorkflowStep SET status = 2, Completed = CURDATE(), ErrorResult = 'Approved' WHERE workflowid = " + BSSWorkflowId + " AND stepkey = '" + BSSWorkflowStepId + "'";
      //  alert(updSQLString);
    //    var xmlHttp = null;
    //    xmlHttp = new XMLHttpRequest();
    //    xmlHttp.open( "GET", "BSSPerformSQLCommand.php?BSSSQLCommand=" + updSQLString + "&userid=" + BSSUserId, false );
    //    xmlHttp.send(null);

        GetSignOffs(BSSWorkflowStepId);

        ProcessWorkflow(BSSWorkflowId);

        GetWorkflowStepsFromId(BSSWorkflowId);


}

function RejectWorkflow(BSSGrid,BSSWorkflowId,BSSWorkflowStepId){

    //alert("here");

    idval = 0;
    var sm = BSSGrid.getSelectionModel();
    var selrecords = sm.getSelection();
    if(sm.getCount() > 0){
        var fieldname = "id";
        //     BSSWorkflowId = selrecords[0].get('id');
        //      BSSWorkflowName = selrecords[0].get('WorkflowName');
        //  alert(selrecords[0].get('id'));
    } else
    {
        alert("Select a Sign Off Row First");
        return;
    }


    updSQLString = "UPDATE AdvWorkflowSignOffs SET SignoffDate = CURDATE(), SignoffResult  = 2 WHERE workflowid = " + BSSWorkflowId + " AND stepkey = " + BSSWorkflowStepId + " AND id = " + selrecords[0].get('id');

   // alert(updSQLString);

    var xmlHttp = null;
    xmlHttp = new XMLHttpRequest();
    xmlHttp.open( "GET", "DBServices/BSSPerformSQLCommand.php?BSSSQLCommand=" + updSQLString + "&userid=" + BSSUserId, false );
    xmlHttp.send(null);

    alert(xmlHttp.responseText);
    //updSQLString = "UPDATE AdvWorkflowStep SET status = 3, ErrorResult = 'Rejected by Approver' WHERE workflowid = " + BSSWorkflowId + " AND stepkey = '" + BSSWorkflowStepId + "'";

    //alert(updSQLString);

    //var xmlHttp = null;
    //xmlHttp = new XMLHttpRequest();
    //xmlHttp.open( "GET", "BSSPerformSQLCommand.php?BSSSQLCommand=" + updSQLString + "&userid=" + BSSUserId, false );
    //xmlHttp.send(null);




    GetSignOffs(BSSWorkflowStepId);

    ProcessWorkflow(BSSWorkflowId);

    GetWorkflowStepsFromId(BSSWorkflowId);

}


function TestWorkflow(BSSWorkflowId){


    alert("BSSProcessNewADVWorkflow.php?BSSWorkflowId=" + BSSWorkflowId + "&BSSWorkflowMode=Design");

    var xmlHttp = null;
    xmlHttp = new XMLHttpRequest();
    xmlHttp.open( "GET", "Workflow/BSSProcessNewADVWorkflow.php?BSSWorkflowId=" + BSSWorkflowId + "&BSSWorkflowMode=Design", false );
    xmlHttp.send(null);

  //  if(xmlHttp.responseText.length > 10)
  //  {
        alert("GGGG" + xmlHttp.responseText);
  //  }else
  //  {
  //      alert("Audit Passes");
  //  }


    GetWorkflowStepsFromId(BSSWorkflowId);

}


    function ResetWorkflow(BSSWorkflowId){

        if(BSSWorkflowId == 0){return;}

        updSQLString = "UPDATE AdvWorkflowStep SET status = 0, ErrorResult = '', Completed = null WHERE workflowid = " + BSSWorkflowId;

        // alert(updSQLString);

        var xmlHttp = null;
        xmlHttp = new XMLHttpRequest();
        xmlHttp.open( "GET", "DBServices/BSSPerformSQLCommand.php?BSSSQLCommand=" + updSQLString + "&userid=" + BSSUserId, false );
        xmlHttp.send(null);


        updSQLString = "UPDATE AdvWorkflowSignOffs SET SignoffDate = null, SignoffResult = null, Comments = null WHERE workflowid = " + BSSWorkflowId;

        alert(updSQLString);

        var xmlHttp = null;
        xmlHttp = new XMLHttpRequest();
        xmlHttp.open( "GET", "DBServices/BSSPerformSQLCommand.php?BSSSQLCommand=" + updSQLString + "&userid=" + BSSUserId, false );
        xmlHttp.send(null);



        GetWorkflowStepsFromId(BSSWorkflowId);

    }


    function gethistory(HISTWorkflowid,HISTStepKey){

        var historyStore = Ext.create('Ext.data.Store', {
            fields: [
                {name: 'id', type: 'string'},
                {name: 'masterid', type: 'string'},
                {name: 'sequence', type: 'string'},
                {name: 'historyuser', type: 'string'},
                {name: 'historydate', type: 'date'},
                {name: 'historytext', type: 'string'}
            ],
            data:
                    [['1','','','','','']]
        });

        //    alert('Here' + childtabs.getActiveTab().title);

        //if(BSSVIEWHISTORY_FLAG = false){return;}

        try{

            //Get the history data
            xmlHttp = new XMLHttpRequest();
            //alert("BSSGetJSData.php?BSSConfigName=History&BSSWhereClause=workflowid="+ HISTWorkflowid + " and stepkey= '" + HISTStepKey + "' ORDER BY id DESC");
            xmlHttp.open( "GET", "DBServices/BSSGetJSData.php?BSSConfigName=History&BSSWhereClause=workflowid="+ HISTWorkflowid + " AND stepkey = '" + HISTStepKey + "' ORDER BY id DESC",false);
            xmlHttp.send( null );

         //   alert("Getting History");
         //   alert(xmlHttp.responseText);
            var newdata1 = eval('[' + xmlHttp.responseText + ']');
            historyStore.loadData(newdata1,false);

        var cellEditing = Ext.create('Ext.grid.plugin.CellEditing', {
            clicksToEdit: 1
        });

        history = Ext.create('Ext.grid.Panel', {
            name: 'historygrid',
            store: historyStore,
            selModel: 'cellmodel',
            columns: [
                {name: 'idhist',
                    header: 'Id',
                    disabled: true,
                    listeners: {
                        beforeedit: function(){
                            return false;
                        }},
                    width: 20,
                    dataIndex: 'id',
                    editor: {
                        allowBlank: false
                    }
                },
                {name: 'masteridhist',
                    header: 'Id',
                    disabled: true,
                    listeners: {
                        beforeedit: function(){
                            return false;
                        }},
                    width: 20,
                    dataIndex: 'masterid',
                    editor: {
                        allowBlank: false
                    }
                },{name: 'sequencehist',
                    header: 'Id',
                    disabled: true,
                    listeners: {
                        beforeedit: function(){
                            return false;
                        }},
                    width: 20,
                    dataIndex: 'sequence',
                    editor: {
                        allowBlank: false
                    }
                },

                //     {name: 'idHistoryUser',
                //     header: 'History User',
                //     disabled: false,
                //     width: 200,
                //     dataIndex: 'historyuser',
                //     editor: {
                //     allowBlank: false
                //     }
                //     },


                {name: 'idHistoryUser',
                    header: 'History User',
                    disabled: false,
                    width: 180,
                    dataIndex: 'historyuser',
                    editor:
                    { xtype: 'combobox',
                        typeAhead: true,
                        selectOnTab: true,
                        disabled: true,
                        triggerAction: 'all',
                        fields:['id','value'],
                        store: userliststore, //[[1, 'GLOBAL'],[2, 'USER']],
                        valueField:'id',
                        displayField:'value',
                        multiSelect: false,
                        queryMode: 'local',
                        lazyRender: true,
                        listClass: 'x-combo-list-small'},
                    renderer: function(val) {var matching =  userliststore.queryBy( function(rec){ return rec.data.id == val; }); return (matching.items[0]) ? matching.items[0].data.value : ''}
                },



                {name: 'idhistorydate',
                    header: 'Date',
                    width: 240,
                    editable: false,
                    dataIndex: 'historydate',
                    editor: {
                        allowBlank: true
                    }
                },
                {name: 'idHistoryText',
                    header: 'History Text',
                    disabled: false,
                    width: 500,
                    dataIndex: 'historytext',
                    editor: {
                        allowBlank: false
                    }
                }],
            width: 960,
            height: 300,
            x: 0,
            y: 0,
            title: 'History',
            frame: true,
            plugins: [cellEditing]
        });


           alert("Returning da history");

        return history;


        }catch(e)
        {alert("History Form Creation Error: " + e.message);
        }

    }




}


function nodeStyle() {
    return [
        // The Node.location comes from the "loc" property of the node data,
        // converted by the Point.parse static method.
        // If the Node.location is changed, it updates the "loc" property of the node data,
        // converting back using the Point.stringify static method.
        new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
        {
            // the Node.location is at the center of each node
            locationSpot: go.Spot.Center,
            //isShadowed: true,
            //shadowColor: "#888",
            // handle mouse enter/leave events to show/hide the ports
            mouseEnter: function (e, obj) { showPorts(obj.part, true); },
            mouseLeave: function (e, obj) { showPorts(obj.part, false); }
        }
    ];
}


function menuStyle() {
    return [
        // The Node.location comes from the "loc" property of the node data,
        // converted by the Point.parse static method.
        // If the Node.location is changed, it updates the "loc" property of the node data,
        // converting back using the Point.stringify static method.
        new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
        {
            // the Node.location is at the center of each node
            locationSpot: go.Spot.Center
            //isShadowed: true,
            //shadowColor: "#888",
            // handle mouse enter/leave events to show/hide the ports
        }
    ];
}




function processForm()
{
    var parameters = location.search.substring(1).split("&");
    var temp = parameters[0].split("=");
    l = unescape(temp[1]);
    BSSFormMode = l;
    m = unescape(temp[2]);

    BSSWorkflowId = m;
}



function inspect(obj, maxLevels, level)
{
    var str = '', type, msg;

    // Start Input Validations
    // Don't touch, we start iterating at level zero
    if(level == null)  level = 0;

    // At least you want to show the first level
    if(maxLevels == null) maxLevels = 1;
    if(maxLevels < 1)
        return '<font color="red">Error: Levels number must be > 0</font>';

    // We start with a non null object
    if(obj == null)
        return '<font color="red">Error: Object <b>NULL</b></font>';
    // End Input Validations

    // Each Iteration must be indented
    str += '<ul>';

    // Start iterations for all objects in obj
    for(property in obj)
    {
        try
        {
            // Show "property" and "type property"
            type =  typeof(obj[property]);
            str += '<li>(' + type + ') ' + property +
                    ( (obj[property]==null)?(': <b>null</b>'):('')) + '</li>';

            // We keep iterating if this property is an Object, non null
            // and we are inside the required number of levels
            if((type == 'object') && (obj[property] != null) && (level+1 < maxLevels))
                str += inspect(obj[property], maxLevels, level+1);
        }
        catch(err)
        {
            // Is there some properties in obj we can't access? Print it red.
            if(typeof(err) == 'string') msg = err;
            else if(err.message)        msg = err.message;
            else if(err.description)    msg = err.description;
            else                        msg = 'Unknown';

            str += '<li><font color="red">(Error) ' + property + ': ' + msg +'</font></li>';
        }
    }

    // Close indent
    str += '</ul>';

    return str;
}





</script>


<div id="sample">
    <div style="width:100%; white-space:nowrap;">
    <span style="display: inline-block; vertical-align: top; padding: 5px; width:110px">
      <div id="myPalette" style="background-color: #9999CC; border: solid 1px black; height: 1000px"></div>
    </span>
    <span style="display: inline-block; vertical-align: top; padding: 5px; width:80%">
      <div id="myDiagram" style="background-color: #6699BC; border: solid 1px black; height: 1000px"></div>
    </span>
    </div>

    <br>

</div>


</body>

</html>